<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bản đồ chia sẻ vị trí</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #f2f2f2;
    font-family: sans-serif;
    text-align: center;
  }
  #map {
    width: 100%;
    height: 80vh;
  }
  #info {
    padding: 10px;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background: #4CAF50;
    color: white;
  }
</style>
</head>
<body>

<h2>🌏 Chia sẻ vị trí theo thời gian thực</h2>
<div id="info">Nhấn nút bên dưới để bắt đầu chia sẻ vị trí</div>
<button onclick="startShare()">📍 Bắt đầu chia sẻ vị trí</button>
<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// === Cấu hình Firebase của bạn ===
const firebaseConfig = {
  databaseURL: "https://mapgps-6fa8a-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === Tên người chia sẻ (có thể sửa theo từng người) ===
const USERNAME = "nhut"; // ví dụ: "van", "nhut", "y"

// === Bắt đầu chia sẻ vị trí ===
function startShare() {
  if (!navigator.geolocation) {
    alert("Thiết bị của bạn không hỗ trợ định vị GPS");
    return;
  }

  document.getElementById("info").innerText = "Đang chia sẻ vị trí...";
  
  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const timestamp = Date.now();
      firebase.database().ref("locations/" + USERNAME).set({ lat, lng, timestamp });
    },
    err => alert("Không lấy được vị trí: " + err.message),
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

// === Hiển thị bản đồ & theo dõi vị trí ===
let map, marker;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 10.8, lng: 106.6 },
    zoom: 14,
  });

  marker = new google.maps.Marker({
    map,
    title: "Vị trí hiện tại"
  });

  // Lắng nghe dữ liệu vị trí từ Firebase
  firebase.database().ref("locations/" + USERNAME).on("value", snap => {
    const data = snap.val();
    if (data) {
      const latLng = new google.maps.LatLng(data.lat, data.lng);
      marker.setPosition(latLng);
      map.setCenter(latLng);
      document.getElementById("info").innerHTML =
        `📍 Vị trí hiện tại:<br>Lat: ${data.lat.toFixed(5)}, Lng: ${data.lng.toFixed(5)}<br>
         ⏱ Cập nhật: ${new Date(data.timestamp).toLocaleTimeString()}<br><br>
         <a href="https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}" target="_blank">🧭 Chỉ đường đến đây</a>`;
    }
  });
}
</script>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap"></script>

</body>
</html>
