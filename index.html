<!DOCTYPE html>

<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ªù T∆∞·ªõng Online</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #8B0000, #DC143C, #CD853F);
        min-height: 100vh;
        padding: 10px;
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
    }

    .card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    h1 {
        font-size: 2em;
        color: #DC143C;
        text-align: center;
        margin-bottom: 10px;
    }

    .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 20px;
    }

    .btn {
        width: 100%;
        padding: 15px;
        font-size: 1.1em;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin: 10px 0;
    }

    .btn-red {
        background: #DC143C;
        color: white;
    }

    .btn-red:active {
        background: #B00020;
    }

    .btn-orange {
        background: #CD853F;
        color: white;
    }

    .btn-orange:active {
        background: #B8753F;
    }

    .btn-green {
        background: #28a745;
        color: white;
    }

    input {
        width: 100%;
        padding: 15px;
        font-size: 1.2em;
        border: 2px solid #ddd;
        border-radius: 10px;
        text-align: center;
        text-transform: uppercase;
        margin: 10px 0;
    }

    .divider {
        text-align: center;
        margin: 20px 0;
        color: #999;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .info-label {
        color: #666;
        font-size: 0.9em;
    }

    .info-value {
        font-size: 1.3em;
        font-weight: bold;
        color: #DC143C;
    }

    .back-btn {
        background: #e0e0e0;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        display: inline-block;
        font-size: 0.9em;
    }

    .status-text {
        text-align: center;
        font-size: 1.2em;
        font-weight: bold;
        padding: 10px;
    }

    .status-waiting {
        color: #CD853F;
    }

    .status-turn-red {
        color: #DC143C;
    }

    .status-turn-black {
        color: #333;
    }

    .your-turn {
        color: #28a745;
        font-size: 0.9em;
        text-align: center;
        margin-top: 5px;
    }

    .board-wrapper {
        background: #DEB887;
        padding: 15px;
        border-radius: 10px;
        overflow-x: auto;
    }

    .board {
        background: #F5DEB3;
        padding: 10px;
        border-radius: 8px;
        width: fit-content;
        margin: 0 auto;
    }

    table {
        border-collapse: collapse;
        background: #FFF8DC;
    }

    td {
        width: 40px;
        height: 40px;
        border: 1px solid #8B4513;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        position: relative;
    }

    td:hover {
        background: #FFFFE0;
    }

    td.selected {
        background: #FFD700 !important;
    }

    td.river {
        background: #B0E0E6;
    }

    .piece {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4em;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .piece-red {
        background: #DC143C;
        color: white;
    }

    .piece-black {
        background: #333;
        color: white;
    }

    .hidden {
        display: none;
    }

    .winner {
        font-size: 2em;
        text-align: center;
        margin-bottom: 15px;
    }
</style>
```

</head>
<body>
    <div class="container">
        <!-- Menu -->
        <div id="menuScreen">
            <div class="card">
                <h1>üèÆ C·ªù T∆∞·ªõng Online üèÆ</h1>
                <p class="subtitle">Xiangqi - Chinese Chess</p>

```
            <button class="btn btn-red" onclick="createRoom()">‚ñ∂Ô∏è T·∫°o ph√≤ng m·ªõi</button>
            
            <p class="divider">‚îÄ‚îÄ‚îÄ ho·∫∑c ‚îÄ‚îÄ‚îÄ</p>
            
            <input type="text" id="roomInput" placeholder="Nh·∫≠p m√£ ph√≤ng" maxlength="6">
            <button class="btn btn-orange" onclick="joinRoom()">üë• Tham gia ph√≤ng</button>
        </div>
    </div>

    <!-- Game -->
    <div id="gameScreen" class="hidden">
        <div class="card">
            <div class="info-row">
                <span class="back-btn" onclick="backToMenu()">‚Üê Tho√°t</span>
                <div>
                    <div class="info-label">M√£ ph√≤ng</div>
                    <span class="info-value" id="roomId"></span>
                    <button onclick="copyRoom()" style="margin-left:5px;padding:2px 8px;border:none;background:#f0f0f0;border-radius:5px;cursor:pointer;">üìã</button>
                </div>
                <div style="text-align: right;">
                    <div class="info-label">B·∫°n l√†</div>
                    <span class="info-value" id="playerColor"></span>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="statusWaiting" class="hidden">
                <div class="status-text status-waiting">‚è≥ ƒêang ch·ªù ƒë·ªëi th·ªß...</div>
                <div style="text-align:center;color:#666;font-size:0.9em;">Chia s·∫ª m√£ ph√≤ng cho b·∫°n b√®</div>
            </div>

            <div id="statusPlaying" class="hidden">
                <div class="status-text">L∆∞·ª£t: <span id="currentTurn"></span></div>
                <div id="yourTurnMsg" class="your-turn hidden">ƒê·∫øn l∆∞·ª£t b·∫°n!</div>
            </div>

            <div id="statusFinished" class="hidden">
                <div class="winner" id="winnerText"></div>
                <button class="btn btn-green" onclick="resetGame()">üîÑ Ch∆°i l·∫°i</button>
            </div>
        </div>

        <div class="card">
            <div class="board-wrapper">
                <div class="board">
                    <table id="boardTable"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const DB = 'https://nhutvan5c-79ce9-default-rtdb.asia-southeast1.firebasedatabase.app';
    const PIECES = {
        RED: { K: 'Â∏•', A: '‰ªï', E: 'Áõ∏', H: 'ÂÇå', R: '‰ø•', C: 'ÁÇÆ', P: 'ÂÖµ' },
        BLACK: { K: 'Â∞á', A: 'Â£´', E: 'Ë±°', H: 'È¶¨', R: 'Ëªä', C: 'Á†≤', P: 'Âçí' }
    };

    let roomId, playerId, playerColor, gameState, selectedPos, timer;

    function initBoard() {
        const b = Array(10).fill(null).map(() => Array(9).fill(null));
        // ƒê·ªè
        b[9][4] = {t:'K',c:'RED'}; b[9][3] = {t:'A',c:'RED'}; b[9][5] = {t:'A',c:'RED'};
        b[9][2] = {t:'E',c:'RED'}; b[9][6] = {t:'E',c:'RED'};
        b[9][1] = {t:'H',c:'RED'}; b[9][7] = {t:'H',c:'RED'};
        b[9][0] = {t:'R',c:'RED'}; b[9][8] = {t:'R',c:'RED'};
        b[7][1] = {t:'C',c:'RED'}; b[7][7] = {t:'C',c:'RED'};
        for(let i=0;i<9;i+=2) b[6][i] = {t:'P',c:'RED'};
        // ƒêen
        b[0][4] = {t:'K',c:'BLACK'}; b[0][3] = {t:'A',c:'BLACK'}; b[0][5] = {t:'A',c:'BLACK'};
        b[0][2] = {t:'E',c:'BLACK'}; b[0][6] = {t:'E',c:'BLACK'};
        b[0][1] = {t:'H',c:'BLACK'}; b[0][7] = {t:'H',c:'BLACK'};
        b[0][0] = {t:'R',c:'BLACK'}; b[0][8] = {t:'R',c:'BLACK'};
        b[2][1] = {t:'C',c:'BLACK'}; b[2][7] = {t:'C',c:'BLACK'};
        for(let i=0;i<9;i+=2) b[3][i] = {t:'P',c:'BLACK'};
        return b;
    }

    async function createRoom() {
        roomId = Math.random().toString(36).substr(2,6).toUpperCase();
        playerId = Math.random().toString(36).substr(2,15);
        playerColor = 'RED';
        
        const state = {
            board: initBoard(),
            turn: 'RED',
            players: {RED: playerId, BLACK: null},
            status: 'waiting',
            winner: null
        };

        await fetch(`${DB}/rooms/${roomId}.json`, {
            method: 'PUT',
            body: JSON.stringify(state)
        });

        showGame();
    }

    async function joinRoom() {
        const input = document.getElementById('roomInput').value.trim().toUpperCase();
        if(!input) return alert('Nh·∫≠p m√£ ph√≤ng!');

        const res = await fetch(`${DB}/rooms/${input}.json`);
        const data = await res.json();

        if(!data) return alert('Ph√≤ng kh√¥ng t·ªìn t·∫°i!');
        if(data.players.BLACK) return alert('Ph√≤ng ƒë√£ ƒë·∫ßy!');

        roomId = input;
        playerId = Math.random().toString(36).substr(2,15);
        playerColor = 'BLACK';

        await fetch(`${DB}/rooms/${roomId}/players/BLACK.json`, {
            method: 'PUT',
            body: JSON.stringify(playerId)
        });

        await fetch(`${DB}/rooms/${roomId}/status.json`, {
            method: 'PUT',
            body: JSON.stringify('playing')
        });

        showGame();
    }

    function showGame() {
        document.getElementById('menuScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.remove('hidden');
        document.getElementById('roomId').textContent = roomId;
        document.getElementById('playerColor').textContent = playerColor === 'RED' ? 'ƒê·ªè' : 'ƒêen';
        document.getElementById('playerColor').style.color = playerColor === 'RED' ? '#DC143C' : '#333';
        
        timer = setInterval(updateGame, 1000);
    }

    function backToMenu() {
        clearInterval(timer);
        document.getElementById('menuScreen').classList.remove('hidden');
        document.getElementById('gameScreen').classList.add('hidden');
        roomId = playerId = playerColor = gameState = selectedPos = null;
    }

    async function updateGame() {
        const res = await fetch(`${DB}/rooms/${roomId}.json`);
        gameState = await res.json();
        if(!gameState) return;

        // Status
        document.getElementById('statusWaiting').classList.toggle('hidden', gameState.status !== 'waiting');
        document.getElementById('statusPlaying').classList.toggle('hidden', gameState.status !== 'playing');
        document.getElementById('statusFinished').classList.toggle('hidden', gameState.status !== 'finished');

        if(gameState.status === 'playing') {
            const turnText = gameState.turn === 'RED' ? 'ƒê·ªè' : 'ƒêen';
            const turnEl = document.getElementById('currentTurn');
            turnEl.textContent = turnText;
            turnEl.className = 'status-turn-' + gameState.turn.toLowerCase();
            document.getElementById('yourTurnMsg').classList.toggle('hidden', gameState.turn !== playerColor);
        }

        if(gameState.status === 'finished') {
            document.getElementById('winnerText').textContent = 
                gameState.winner === playerColor ? 'üéâ B·∫°n th·∫Øng!' : 'üòî B·∫°n thua!';
        }

        renderBoard();
    }

    function renderBoard() {
        const table = document.getElementById('boardTable');
        table.innerHTML = '';

        for(let r=0; r<10; r++) {
            const tr = table.insertRow();
            for(let c=0; c<9; c++) {
                const td = tr.insertCell();
                
                if(r===4 || r===5) td.classList.add('river');
                if(selectedPos && selectedPos[0]===r && selectedPos[1]===c) {
                    td.classList.add('selected');
                }

                const piece = gameState.board[r][c];
                if(piece) {
                    const div = document.createElement('div');
                    div.className = 'piece piece-' + piece.c.toLowerCase();
                    div.textContent = piece.c === 'RED' ? PIECES.RED[piece.t] : PIECES.BLACK[piece.t];
                    td.appendChild(div);
                }

                td.onclick = () => clickSquare(r, c);
            }
        }
    }

    function clickSquare(r, c) {
        if(!gameState || gameState.status !== 'playing' || gameState.turn !== playerColor) return;

        const piece = gameState.board[r][c];

        if(selectedPos) {
            const [fr, fc] = selectedPos;
            if(fr === r && fc === c) {
                selectedPos = null;
                renderBoard();
                return;
            }

            const moving = gameState.board[fr][fc];
            if(isValid(fr, fc, r, c, moving)) {
                makeMove(fr, fc, r, c);
            } else if(piece && piece.c === playerColor) {
                selectedPos = [r, c];
                renderBoard();
            } else {
                selectedPos = null;
                renderBoard();
            }
        } else if(piece && piece.c === playerColor) {
            selectedPos = [r, c];
            renderBoard();
        }
    }

    async function makeMove(fr, fc, tr, tc) {
        const newBoard = gameState.board.map(r => [...r]);
        const captured = newBoard[tr][tc];
        newBoard[tr][tc] = newBoard[fr][fc];
        newBoard[fr][fc] = null;

        const nextTurn = playerColor === 'RED' ? 'BLACK' : 'RED';
        const winner = captured && captured.t === 'K' ? playerColor : null;

        await fetch(`${DB}/rooms/${roomId}.json`, {
            method: 'PATCH',
            body: JSON.stringify({
                board: newBoard,
                turn: winner ? playerColor : nextTurn,
                status: winner ? 'finished' : 'playing',
                winner: winner
            })
        });

        selectedPos = null;
    }

    function isValid(fr, fc, tr, tc, p) {
        if(tr<0||tr>9||tc<0||tc>8) return false;
        const tgt = gameState.board[tr][tc];
        if(tgt && tgt.c === p.c) return false;

        const rd = Math.abs(tr-fr), cd = Math.abs(tc-fc);

        switch(p.t) {
            case 'K':
                if(rd+cd !== 1) return false;
                return p.c==='RED' ? (tr>=7 && tc>=3 && tc<=5) : (tr<=2 && tc>=3 && tc<=5);
            case 'A':
                if(rd!==1 || cd!==1) return false;
                return p.c==='RED' ? (tr>=7 && tc>=3 && tc<=5) : (tr<=2 && tc>=3 && tc<=5);
            case 'E':
                if(rd!==2 || cd!==2) return false;
                const mr = (fr+tr)/2, mc = (fc+tc)/2;
                if(gameState.board[mr][mc]) return false;
                return p.c==='RED' ? tr>=5 : tr<=4;
            case 'H':
                if(!((rd===2&&cd===1)||(rd===1&&cd===2))) return false;
                const br = rd===2 ? fr+(tr>fr?1:-1) : fr;
                const bc = cd===2 ? fc+(tc>fc?1:-1) : fc;
                return !gameState.board[br][bc];
            case 'R':
                if(rd!==0 && cd!==0) return false;
                if(rd>0) {
                    for(let i=Math.min(fr,tr)+1; i<Math.max(fr,tr); i++)
                        if(gameState.board[i][fc]) return false;
                } else {
                    for(let i=Math.min(fc,tc)+1; i<Math.max(fc,tc); i++)
                        if(gameState.board[fr][i]) return false;
                }
                return true;
            case 'C':
                if(rd!==0 && cd!==0) return false;
                let cnt = 0;
                if(rd>0) {
                    for(let i=Math.min(fr,tr)+1; i<Math.max(fr,tr); i++)
                        if(gameState.board[i][fc]) cnt++;
                } else {
                    for(let i=Math.min(fc,tc)+1; i<Math.max(fc,tc); i++)
                        if(gameState.board[fr][i]) cnt++;
                }
                return tgt ? cnt===1 : cnt===0;
            case 'P':
                if(p.c==='RED') {
                    if(fr>4) return tr===fr-1 && tc===fc;
                    return (tr===fr-1&&tc===fc) || (tr===fr&&Math.abs(tc-fc)===1);
                } else {
                    if(fr<5) return tr===fr+1 && tc===fc;
                    return (tr===fr+1&&tc===fc) || (tr===fr&&Math.abs(tc-fc)===1);
                }
        }
        return false;
    }

    function copyRoom() {
        navigator.clipboard.writeText(roomId);
        alert('ƒê√£ copy: ' + roomId);
    }

    async function resetGame() {
        await fetch(`${DB}/rooms/${roomId}.json`, {
            method: 'PATCH',
            body: JSON.stringify({
                board: initBoard(),
                turn: 'RED',
                status: 'playing',
                winner: null
            })
        });
    }
</script>
```

</body>
</html>