<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bản đồ chia sẻ vị trí (Leaflet)</title>

<!-- Thư viện bản đồ Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #f2f2f2;
    font-family: sans-serif;
    text-align: center;
  }
  #map {
    width: 100%;
    height: 80vh;
  }
  #info {
    padding: 10px;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background: #4CAF50;
    color: white;
  }
</style>
</head>
<body>

<h2>📍 Chia sẻ vị trí theo thời gian thực</h2>
<div id="info">Nhấn nút để bắt đầu chia sẻ vị trí</div>
<button onclick="startShare()">Bắt đầu chia sẻ</button>
<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ==== Cấu hình Firebase ====
const firebaseConfig = {
  databaseURL: "https://mapgps-6fa8a-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== Tên người chia sẻ ====
const USERNAME = "nhut"; // sửa thành tên khác nếu là người khác

let map, marker;

// ==== Khởi tạo bản đồ Leaflet ====
function initMap() {
  map = L.map('map').setView([10.8, 106.6], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
  }).addTo(map);

  marker = L.marker([10.8, 106.6]).addTo(map)
    .bindPopup("Vị trí hiện tại").openPopup();

  // Lắng nghe vị trí từ Firebase
  firebase.database().ref("locations/" + USERNAME).on("value", snap => {
    const data = snap.val();
    if (data) {
      const latlng = [data.lat, data.lng];
      marker.setLatLng(latlng);
      map.setView(latlng, 15);
      document.getElementById("info").innerHTML = 
        `📍 Lat: ${data.lat.toFixed(5)}, Lng: ${data.lng.toFixed(5)}<br>
         ⏱ ${new Date(data.timestamp).toLocaleTimeString()}<br>
         <a href="https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}" target="_blank">🧭 Chỉ đường đến đây</a>`;
    }
  });
}

// ==== Bắt đầu chia sẻ vị trí ====
function startShare() {
  document.getElementById("info").innerText = "Đang chia sẻ vị trí...";
  if (!navigator.geolocation) {
    alert("Thiết bị không hỗ trợ định vị GPS");
    return;
  }

  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const timestamp = Date.now();
      firebase.database().ref("locations/" + USERNAME).set({ lat, lng, timestamp });
    },
    err => alert("Không lấy được vị trí: " + err.message),
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

// Khởi tạo bản đồ sau khi tải xong
window.onload = initMap;
</script>

</body>
</html>