<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat ri√™ng Firebase</title>
<style>
body { font-family: Arial; background:#eef; text-align:center; margin:0; padding:0; }
#login, #chat { max-width:400px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px #999; }
input, button { width:90%; padding:10px; margin:6px 0; font-size:16px; border:1px solid #ccc; border-radius:5px; }
button { background:#4CAF50; color:white; cursor:pointer; border:none; }
button:hover { background:#45a049; }
button:disabled { background:#ccc; cursor:not-allowed; }
#messages { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; text-align:left; background:#fafafa; margin:10px 0; }
.msg { margin:8px 0; padding:8px 12px; clear:both; max-width:80%; word-wrap:break-word; }
.msg.left { float:left; background:#e3f2fd; border-radius:10px 10px 10px 0; }
.msg.right { float:right; background:#c8e6c9; border-radius:10px 10px 0 10px; text-align:right; }
.msg .sender { font-weight:bold; font-size:13px; margin-bottom:3px; display:block; }
.msg.left .sender { color:#1976d2; }
.msg.right .sender { color:#388e3c; }
.msg .text { font-size:15px; color:#333; }
.msg .time { font-size:11px; color:#666; margin-top:3px; display:block; }
#deleteRoom { background:#f44336; }
#deleteRoom:hover { background:#da190b; }
.loading { opacity:0.6; pointer-events:none; }
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}
</style>
</head>
<body>

<div id="login">
  <h2>üí¨ Chat ri√™ng Online</h2>
  <input id="name" placeholder="T√™n c·ªßa b·∫°n" autocomplete="off">
  <input id="room" placeholder="T√™n ph√≤ng" autocomplete="off">
  <input id="pass" placeholder="M·∫≠t kh·∫©u" type="password">
  <button id="create">T·∫°o ph√≤ng</button>
  <button id="join">V√†o ph√≤ng</button>
  <p style="font-size:12px; color:#666;">üí° T√™n ph√≤ng v√† m·∫≠t kh·∫©u ph√¢n bi·ªát hoa th∆∞·ªùng</p>
</div>

<div id="chat" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <input id="msgBox" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
  <button id="send">G·ª≠i</button>
  <br><br>
  <button id="leave" style="background:#FF9800;">R·ªùi ph√≤ng</button>
  <button id="deleteRoom" style="background:#f44336;">Xo√° ph√≤ng</button>
</div>

<!-- Firebase SDK -->

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const firebaseConfig = {
    databaseURL: "https://nhutvan5c-79ce9-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let myName, roomName, myPass, isCreator = false;
  let messageListener = null; // ƒê·ªÉ qu·∫£n l√Ω listener

  // H√†m hash m·∫≠t kh·∫©u ƒë∆°n gi·∫£n (SHA-256)
  async function hashPassword(password) {
    const msgBuffer = new TextEncoder().encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // H√†m escape HTML ƒë·ªÉ tr√°nh XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // T·∫°o ph√≤ng
  document.getElementById("create").onclick = async () => {
    const btn = document.getElementById("create");
    try {
      btn.disabled = true;
      btn.textContent = "ƒêang t·∫°o...";

      myName = document.getElementById("name").value.trim();
      roomName = document.getElementById("room").value.trim();
      myPass = document.getElementById("pass").value.trim();

      if (!myName || !roomName || !myPass) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        return;
      }

      if (myPass.length < 6) {
        alert("‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!");
        return;
      }

      const rRef = db.ref("rooms/" + roomName);
      const snap = await rRef.get();

      if (snap.exists()) {
        alert("‚ö†Ô∏è Ph√≤ng ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn t√™n kh√°c.");
        return;
      }

      // Hash m·∫≠t kh·∫©u tr∆∞·ªõc khi l∆∞u
      const hashedPass = await hashPassword(myPass);
      await rRef.set({ 
        password: hashedPass,
        creator: myName,
        createdAt: new Date().toISOString(),
        members: {},
        messages: {}
      });

      // Th√™m ng∆∞·ªùi t·∫°o v√†o danh s√°ch th√†nh vi√™n
      await rRef.child("members").child(myName).set({
        name: myName,
        joinedAt: new Date().toISOString()
      });

      isCreator = true;
      alert("‚úÖ Ph√≤ng ƒë√£ t·∫°o th√†nh c√¥ng!");
      startChat();

    } catch (error) {
      console.error("L·ªói t·∫°o ph√≤ng:", error);
      alert("‚ùå L·ªói: " + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "T·∫°o ph√≤ng";
    }
  };

  // V√†o ph√≤ng
  document.getElementById("join").onclick = async () => {
    const btn = document.getElementById("join");
    try {
      btn.disabled = true;
      btn.textContent = "ƒêang k·∫øt n·ªëi...";

      myName = document.getElementById("name").value.trim();
      roomName = document.getElementById("room").value.trim();
      myPass = document.getElementById("pass").value.trim();

      if (!myName || !roomName || !myPass) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        return;
      }

      const rRef = db.ref("rooms/" + roomName);
      const snap = await rRef.get();

      if (!snap.exists()) {
        alert("‚ö†Ô∏è Ph√≤ng kh√¥ng t·ªìn t·∫°i!");
        return;
      }

      const hashedPass = await hashPassword(myPass);
      if (snap.val().password !== hashedPass) {
        alert("‚ùå Sai m·∫≠t kh·∫©u!");
        return;
      }

      // Th√™m th√†nh vi√™n m·ªõi v√†o ph√≤ng
      await rRef.child("members").child(myName).set({
        name: myName,
        joinedAt: new Date().toISOString()
      });

      isCreator = false; // Quan tr·ªçng: reset isCreator
      alert("‚úÖ ƒê√£ v√†o ph√≤ng th√†nh c√¥ng!");
      startChat();

    } catch (error) {
      console.error("L·ªói v√†o ph√≤ng:", error);
      alert("‚ùå L·ªói: " + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "V√†o ph√≤ng";
    }
  };

  // B·∫Øt ƒë·∫ßu chat
  function startChat() {
    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("roomTitle").textContent = "üè† Ph√≤ng: " + roomName;
    loadMessages();
    listenForNewMembers(); // L·∫Øng nghe th√†nh vi√™n m·ªõi
  }

  // G·ª≠i tin nh·∫Øn
  document.getElementById("send").onclick = sendMessage;
  document.getElementById("msgBox").onkeypress = function(e) {
    if (e.key === 'Enter') sendMessage();
  };

  async function sendMessage() {
    const msgBox = document.getElementById("msgBox");
    const text = msgBox.value.trim();
    if (!text) return;

    try {
      const msgRef = db.ref("rooms/" + roomName + "/messages");
      await msgRef.push({
        sender: myName,
        text: text,
        time: new Date().toISOString()
      });
      msgBox.value = "";
    } catch (error) {
      console.error("L·ªói g·ª≠i tin:", error);
      alert("‚ùå Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn: " + error.message);
    }
  }

  // Load tin nh·∫Øn
  function loadMessages() {
    const msgRef = db.ref("rooms/" + roomName + "/messages");
    
    // X√≥a listener c≈© n·∫øu c√≥
    if (messageListener) {
      msgRef.off("value", messageListener);
    }

    // T·∫°o listener m·ªõi
    messageListener = msgRef.on("value", (snap) => {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      
      if (!snap.exists() || !snap.val()) {
        messagesDiv.innerHTML = "<p style='color:#999;text-align:center;'>Ch∆∞a c√≥ tin nh·∫Øn n√†o...</p>";
        return;
      }

      snap.forEach(child => {
        const m = child.val();
        const div = document.createElement("div");
        
        // Ki·ªÉm tra tin nh·∫Øn c·ªßa ai: c·ªßa m√¨nh th√¨ b√™n tr√°i, ng∆∞·ªùi kh√°c b√™n ph·∫£i
        const isMyMessage = m.sender === myName;
        div.className = isMyMessage ? "msg left" : "msg right";
        
        const time = new Date(m.time).toLocaleString('vi-VN', {
          hour: '2-digit',
          minute: '2-digit',
          day: '2-digit',
          month: '2-digit'
        });
        
        div.innerHTML = `
          <span class="sender">${escapeHtml(m.sender)}</span>
          <span class="text">${escapeHtml(m.text)}</span>
          <span class="time">${time}</span>
        `;
        messagesDiv.appendChild(div);
      });
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // L·∫Øng nghe th√†nh vi√™n m·ªõi v√†o ph√≤ng (ch·ªâ ng∆∞·ªùi t·∫°o ph√≤ng th·∫•y th√¥ng b√°o)
  function listenForNewMembers() {
    if (!isCreator) return; // Ch·ªâ ng∆∞·ªùi t·∫°o ph√≤ng m·ªõi nh·∫≠n th√¥ng b√°o

    const membersRef = db.ref("rooms/" + roomName + "/members");
    
    // L·∫Øng nghe th√†nh vi√™n m·ªõi ƒë∆∞·ª£c th√™m
    membersRef.on("child_added", (snapshot) => {
      const memberName = snapshot.val().name;
      
      // Kh√¥ng th√¥ng b√°o khi ch√≠nh m√¨nh (ng∆∞·ªùi t·∫°o) v√†o
      if (memberName !== myName) {
        // Hi·ªÉn th·ªã th√¥ng b√°o
        showNotification(`üéâ ${memberName} ƒë√£ v√†o ph√≤ng`);
        
        // Th√™m tin nh·∫Øn h·ªá th·ªëng v√†o chat
        const messagesDiv = document.getElementById("messages");
        const div = document.createElement("div");
        div.style.cssText = "text-align:center; color:#666; font-size:13px; margin:10px 0; padding:8px; background:#f0f0f0; border-radius:15px;";
        div.innerHTML = `üë§ <strong>${escapeHtml(memberName)}</strong> ƒë√£ v√†o ph√≤ng`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });
  }

  // Hi·ªÉn th·ªã th√¥ng b√°o popup
  function showNotification(message) {
    // T·∫°o th√¥ng b√°o t·∫°m th·ªùi
    const notification = document.createElement("div");
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9999;
      font-size: 15px;
      animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    // T·ª± ƒë·ªông x√≥a sau 4 gi√¢y
    setTimeout(() => {
      notification.style.animation = "slideOut 0.3s ease";
      setTimeout(() => notification.remove(), 300);
    }, 4000);
  }

  // X√≥a ph√≤ng (b·∫•t k·ª≥ ai c≈©ng c√≥ th·ªÉ x√≥a)
  document.getElementById("deleteRoom").onclick = async () => {
    if (confirm("‚ö†Ô∏è X√ìA PH√íNG CHAT\n\nB·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng n√†y?\n\n‚Ä¢ Ph√≤ng \"" + roomName + "\" s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn\n‚Ä¢ T·∫•t c·∫£ tin nh·∫Øn s·∫Ω b·ªã m·∫•t\n‚Ä¢ M·ªçi ng∆∞·ªùi s·∫Ω b·ªã ng·∫Øt k·∫øt n·ªëi\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!")) {
      try {
        const btn = document.getElementById("deleteRoom");
        btn.disabled = true;
        btn.textContent = "ƒêang x√≥a...";

        // T·∫Øt listener tr∆∞·ªõc khi x√≥a
        const msgRef = db.ref("rooms/" + roomName + "/messages");
        if (messageListener) {
          msgRef.off("value", messageListener);
          messageListener = null;
        }
        
        await db.ref("rooms/" + roomName).remove();
        alert("‚úÖ ƒê√£ x√≥a ph√≤ng v√† t·∫•t c·∫£ tin nh·∫Øn th√†nh c√¥ng!");
        location.reload();
      } catch (error) {
        console.error("L·ªói x√≥a ph√≤ng:", error);
        alert("‚ùå Kh√¥ng th·ªÉ x√≥a ph√≤ng: " + error.message);
        document.getElementById("deleteRoom").disabled = false;
        document.getElementById("deleteRoom").textContent = "Xo√° ph√≤ng";
      }
    }
  };

  // R·ªùi ph√≤ng
  document.getElementById("leave").onclick = () => {
    if (confirm("B·∫°n mu·ªën r·ªùi kh·ªèi ph√≤ng?")) {
      // T·∫Øt listener
      const msgRef = db.ref("rooms/" + roomName + "/messages");
      if (messageListener) {
        msgRef.off("value", messageListener);
        messageListener = null;
      }
      location.reload();
    }
  };
});
</script>

</body>
</html>