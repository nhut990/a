<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kiểm tra Camera & Micro</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 16px;
      background: #fafafa;
      color: #222;
      text-align: center;
    }
    video {
      width: 100%;
      max-width: 360px;
      background: #000;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    select, button {
      padding: 8px 12px;
      margin: 6px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #aaa;
    }
    button:disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    progress {
      width: 80%;
      height: 16px;
      border-radius: 8px;
    }
    audio {
      width: 90%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Trang kiểm tra Camera & Micro (Web)</h2>
  <video id="preview" autoplay playsinline></video>
  <br>
  <label for="cameraSelect">Camera:</label>
  <select id="cameraSelect"></select>
  <br>
  <label for="micSelect">Micro:</label>
  <select id="micSelect"></select>
  <br>
  <button id="startPreview">Bắt đầu Preview</button>
  <button id="stopPreview" disabled>Ngưng Preview</button>

  <p>⚠️ <b>Lưu ý</b>: Trình duyệt có thể yêu cầu quyền truy cập <b>camera</b> và <b>micro</b>. Hãy cho phép để sử dụng tính năng này.</p>

  <div>
    <b>Mức âm thanh (camera/micro):</b><br>
    <progress id="audioLevel" value="0" max="1"></progress><br>
    <span id="dbValue">— dB</span>
    <hr>
    <b>Mức âm thanh khi ghi âm:</b><br>
    <progress id="recLevel" value="0" max="1"></progress><br>
    <span id="recDb">— dB</span>
  </div>

  <div>
    <button id="startRec">Bắt đầu Ghi âm</button>
    <button id="stopRec" disabled>Ngừng Ghi</button>
    <button id="playRec" disabled>Phát Lại</button>
    <button id="downloadRec" disabled>Tải về</button>
    <span id="timer">00:00</span>
  </div>

  <audio id="player" controls></audio>

  <p>Kết quả ghi âm có thể phát lại và tải về. Một số trình duyệt (như iOS) chỉ cho phát khi có thao tác người dùng.</p>

  <script>
    const video = document.getElementById('preview');
    const camSelect = document.getElementById('cameraSelect');
    const micSelect = document.getElementById('micSelect');
    const startBtn = document.getElementById('startPreview');
    const stopBtn = document.getElementById('stopPreview');
    const audioLevel = document.getElementById('audioLevel');
    const dbValue = document.getElementById('dbValue');

    const startRec = document.getElementById('startRec');
    const stopRec = document.getElementById('stopRec');
    const playRec = document.getElementById('playRec');
    const downloadRec = document.getElementById('downloadRec');
    const player = document.getElementById('player');
    const recLevel = document.getElementById('recLevel');
    const recDb = document.getElementById('recDb');
    const timer = document.getElementById('timer');

    let stream, micStream, analyser, recAnalyser, dataArray;
    let mediaRecorder, chunks = [];
    let timerInterval;

    async function loadDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      camSelect.innerHTML = '';
      micSelect.innerHTML = '';
      devices.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `${d.kind}`;
        if (d.kind === 'videoinput') camSelect.appendChild(opt);
        if (d.kind === 'audioinput') micSelect.appendChild(opt);
      });
    }

    async function startPreviewFunc() {
      startBtn.disabled = true;
      startBtn.style.opacity = 0.4;
      stopBtn.disabled = false;
      const camId = camSelect.value;
      const micId = micSelect.value;
      stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: camId ? { exact: camId } : undefined },
        audio: { deviceId: micId ? { exact: micId } : undefined }
      });
      video.srcObject = stream;

      const audioCtx = new AudioContext();
      const source = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      monitorAudio();
    }

    function stopPreviewFunc() {
      stream?.getTracks().forEach(t => t.stop());
      startBtn.disabled = false;
      startBtn.style.opacity = 1;
      stopBtn.disabled = true;
    }

    function monitorAudio() {
      requestAnimationFrame(monitorAudio);
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
      const db = (avg/255).toFixed(2);
      audioLevel.value = db;
      dbValue.textContent = `${(db*100 - 50).toFixed(1)} dB`;
    }

    startBtn.onclick = startPreviewFunc;
    stopBtn.onclick = stopPreviewFunc;

    // Ghi âm
    startRec.onclick = async () => {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(micStream);
      chunks = [];
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        player.src = url;
        playRec.disabled = false;
        downloadRec.disabled = false;
        downloadRec.style.opacity = 1;
        downloadRec.onclick = () => {
          const a = document.createElement('a');
          a.href = url;
          a.download = 'recording.webm';
          a.click();
        };
      };
      mediaRecorder.start();

      // Disable tải về khi chưa xong
      downloadRec.disabled = true;
      downloadRec.style.opacity = 0.4;

      startRec.disabled = true;
      stopRec.disabled = false;

      const audioCtx = new AudioContext();
      const source = audioCtx.createMediaStreamSource(micStream);
      recAnalyser = audioCtx.createAnalyser();
      source.connect(recAnalyser);
      const recData = new Uint8Array(recAnalyser.frequencyBinCount);

      function monitorRec() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
        requestAnimationFrame(monitorRec);
        recAnalyser.getByteFrequencyData(recData);
        const avg = recData.reduce((a,b)=>a+b,0)/recData.length;
        const db = (avg/255).toFixed(2);
        recLevel.value = db;
        recDb.textContent = `${(db*100 - 50).toFixed(1)} dB`;
      }
      monitorRec();

      let sec = 0;
      timer.textContent = "00:00";
      timerInterval = setInterval(() => {
        sec++;
        timer.textContent = new Date(sec * 1000).toISOString().substr(14, 5);
      }, 1000);
    };

    stopRec.onclick = () => {
      mediaRecorder.stop();
      micStream.getTracks().forEach(t => t.stop());
      startRec.disabled = false;
      stopRec.disabled = true;
      clearInterval(timerInterval);
    };

    playRec.onclick = () => player.play();

    loadDevices();
  </script>
</body>
</html>