<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Chord Finder (Responsive, Center Chord - Fixed)</title>
    <style>
        :root{
            --white-key-width: 50px;
            --white-key-height: 200px;
            --black-key-width: 35px;
            --black-key-height: 120px;
            --black-key-offset: 17.5px;
            --label-font-size: 12px;
            --black-label-font-size: 10px;
        }

        @media (max-width: 600px) {
            :root{
                --white-key-width: 40px;
                --white-key-height: 120px;
                --black-key-width: 28px;
                --black-key-height: 80px;
                --black-key-offset: 14px;
                --label-font-size: 11px;
                --black-label-font-size: 9px;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 2.5em; }

        .controls { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; align-items: center; justify-content: center; }

        .control-group { display: flex; flex-direction: column; gap: 8px; }

        label { font-weight: 600; color: #555; font-size: 14px; }

        select {
            padding: 12px 20px; font-size: 16px; border: 2px solid #ddd; border-radius: 10px;
            background: white; cursor: pointer; transition: all 0.3s;
        }
        select:hover { border-color: #667eea; }
        select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }

        .play-buttons { display:flex; gap:10px; }
        button {
            padding: 12px 24px; font-size: 16px; font-weight: 600; border: none; border-radius: 10px;
            cursor: pointer; transition: all 0.3s; color: white;
        }

        .btn-arpeggio { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-chord { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .piano-container { overflow-x: auto; padding: 20px 0; scroll-behavior: smooth; }
        .piano { display:flex; position:relative; height: var(--white-key-height); margin:0 auto; width: fit-content; }

        .key { position: relative; cursor: pointer; user-select: none; }
        .white-key {
            width: var(--white-key-width); height: var(--white-key-height);
            background: white; border: 2px solid #333; border-radius: 0 0 5px 5px;
            display:flex; align-items:flex-end; justify-content:center; padding-bottom:10px;
            font-size: var(--label-font-size); color:#666; transition: all 0.1s;
        }
        .white-key:hover { background:#f0f0f0; }
        .white-key.active { background:#ff8c00; box-shadow:0 0 20px rgba(255,140,0,0.6); }
        .white-key.playing { background:#00ff00; box-shadow:0 0 30px rgba(0,255,0,0.8); transform: translateY(3px); }

        .black-key {
            width: var(--black-key-width); height: var(--black-key-height);
            background: linear-gradient(to bottom, #222, #000); border:2px solid #000;
            border-radius: 0 0 3px 3px; position:absolute; z-index:10; color:white;
            display:flex; align-items:flex-end; justify-content:center; padding-bottom:8px;
            font-size: var(--black-label-font-size); transition: all 0.1s;
        }
        .black-key:hover { background: linear-gradient(to bottom, #333, #111); }
        .black-key.active { background: linear-gradient(to bottom, #ff8c00, #ff6600); box-shadow:0 0 20px rgba(255,140,0,0.8); }
        .black-key.playing { background: linear-gradient(to bottom, #00ff00, #00cc00); box-shadow:0 0 30px rgba(0,255,0,0.9); transform: translateY(2px); }

        .chord-info { text-align:center; margin-top:30px; padding:20px; background:#f8f9fa; border-radius:10px; }
        .loading-status { text-align:center; margin-bottom:20px; padding:15px; background:#e3f2fd; border-radius:10px; font-weight:600; color:#1976d2; }
        .loading-status.loaded { background:#e8f5e9; color:#2e7d32; }

        .chord-name { font-size:24px; font-weight:bold; color:#667eea; margin-bottom:10px; }
        .chord-notes { font-size:18px; color:#555; }

        @media (max-width: 420px) {
            .container { padding: 18px; }
            h1 { font-size: 1.8em; }
            .controls { gap: 12px; }
            .chord-name { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéπ Piano Chord Finder</h1>

        <div class="loading-status" id="loading-status">üîÑ ƒêang t·∫£i √¢m thanh... 0%</div>

        <div class="controls">
            <div class="control-group">
                <label for="root-select">N·ªët g·ªëc:</label>
                <select id="root-select">
                    <option value="C">C</option>
                    <option value="Db">C# / Db</option>
                    <option value="D">D</option>
                    <option value="Eb">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="Gb">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="Ab">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="Bb">A# / Bb</option>
                    <option value="B">B</option>
                </select>
            </div>

            <div class="control-group">
                <label for="chord-select">Lo·∫°i h·ª£p √¢m:</label>
                <select id="chord-select">
                    <optgroup label="H·ª£p √¢m c∆° b·∫£n">
                        <option value="major">Major (Tr∆∞·ªüng)</option>
                        <option value="minor">Minor (Th·ª© - m)</option>
                        <option value="7">Dominant 7th (7)</option>
                        <option value="maj7">Major 7th (Maj7/M7)</option>
                        <option value="m7">Minor 7th (m7)</option>
                    </optgroup>
                    <optgroup label="H·ª£p √¢m sus">
                        <option value="sus2">Suspended 2nd (sus2)</option>
                        <option value="sus4">Suspended 4th (sus4)</option>
                    </optgroup>
                    <optgroup label="H·ª£p √¢m ƒë·∫∑c bi·ªát">
                        <option value="dim">Diminished (dim)</option>
                        <option value="aug">Augmented (aug)</option>
                        <option value="dim7">Diminished 7th (dim7)</option>
                    </optgroup>
                    <optgroup label="H·ª£p √¢m m·ªü r·ªông">
                        <option value="6">Major 6th (6)</option>
                        <option value="m6">Minor 6th (m6)</option>
                        <option value="9">Dominant 9th (9)</option>
                        <option value="maj9">Major 9th (Maj9)</option>
                        <option value="m9">Minor 9th (m9)</option>
                        <option value="add9">Add 9 (add9)</option>
                    </optgroup>
                </select>
            </div>

            <div class="control-group">
                <label>Ph√°t √¢m:</label>
                <div class="play-buttons">
                    <button id="btn-arpeggio" class="btn-arpeggio" onclick="playArpeggio()" disabled>üéµ L·∫ßn l∆∞·ª£t</button>
                    <button id="btn-chord" class="btn-chord" onclick="playChord()" disabled>üé∂ C√πng l√∫c</button>
                </div>
            </div>
        </div>

        <div class="piano-container">
            <div class="piano" id="piano"></div>
        </div>

        <div class="chord-info">
            <div class="chord-name" id="chord-name">C Major</div>
            <div class="chord-notes" id="chord-notes">C√°c n·ªët: C - E - G</div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://raw.githubusercontent.com/Nhut11790/nhut11790.github.io/main/tieng/acoustic_grand_piano-mp3/';

        const noteToFile = {
            'C': 'C', 'C#': 'Db', 'Db': 'Db',
            'D': 'D', 'D#': 'Eb', 'Eb': 'Eb',
            'E': 'E',
            'F': 'F', 'F#': 'Gb', 'Gb': 'Gb',
            'G': 'G', 'G#': 'Ab', 'Ab': 'Ab',
            'A': 'A', 'A#': 'Bb', 'Bb': 'Bb',
            'B': 'B'
        };

        const pianoKeys = [
            {note: 'C', octave: 3, type: 'white'},
            {note: 'C#', octave: 3, type: 'black'},
            {note: 'D', octave: 3, type: 'white'},
            {note: 'D#', octave: 3, type: 'black'},
            {note: 'E', octave: 3, type: 'white'},
            {note: 'F', octave: 3, type: 'white'},
            {note: 'F#', octave: 3, type: 'black'},
            {note: 'G', octave: 3, type: 'white'},
            {note: 'G#', octave: 3, type: 'black'},
            {note: 'A', octave: 3, type: 'white'},
            {note: 'A#', octave: 3, type: 'black'},
            {note: 'B', octave: 3, type: 'white'},
            {note: 'C', octave: 4, type: 'white'},
            {note: 'C#', octave: 4, type: 'black'},
            {note: 'D', octave: 4, type: 'white'},
            {note: 'D#', octave: 4, type: 'black'},
            {note: 'E', octave: 4, type: 'white'},
            {note: 'F', octave: 4, type: 'white'},
            {note: 'F#', octave: 4, type: 'black'},
            {note: 'G', octave: 4, type: 'white'},
            {note: 'G#', octave: 4, type: 'black'},
            {note: 'A', octave: 4, type: 'white'},
            {note: 'A#', octave: 4, type: 'black'},
            {note: 'B', octave: 4, type: 'white'},
            {note: 'C', octave: 5, type: 'white'},
            {note: 'C#', octave: 5, type: 'black'},
            {note: 'D', octave: 5, type: 'white'},
            {note: 'D#', octave: 5, type: 'black'},
            {note: 'E', octave: 5, type: 'white'},
            {note: 'F', octave: 5, type: 'white'},
            {note: 'F#', octave: 5, type: 'black'},
            {note: 'G', octave: 5, type: 'white'},
            {note: 'G#', octave: 5, type: 'black'},
            {note: 'A', octave: 5, type: 'white'},
            {note: 'A#', octave: 5, type: 'black'},
            {note: 'B', octave: 5, type: 'white'},
            {note: 'C', octave: 6, type: 'white'}
        ];

        const chordFormulas = {
            'major': [0, 4, 7],
            'minor': [0, 3, 7],
            '7': [0, 4, 7, 10],
            'maj7': [0, 4, 7, 11],
            'm7': [0, 3, 7, 10],
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],
            'dim': [0, 3, 6],
            'aug': [0, 4, 8],
            'dim7': [0, 3, 6, 9],
            '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9],
            '9': [0, 4, 7, 10, 14],
            'maj9': [0, 4, 7, 11, 14],
            'm9': [0, 3, 7, 10, 14],
            'add9': [0, 4, 7, 14]
        };

        const chromaticScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        let currentChordNotes = [];
        let audioCache = {};
        let isPlaying = false;
        let audioLoaded = false;
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
                catch (e) { console.log('Web Audio API kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£'); }
            }
        }

        async function preloadAllAudio() {
            const loadingStatus = document.getElementById('loading-status');
            const totalNotes = pianoKeys.length;
            let loadedCount = 0;

            const loadPromises = pianoKeys.map(async (key) => {
                const fileNote = noteToFile[key.note];
                const fileName = `${fileNote}${key.octave}.mp3`;
                const url = BASE_URL + fileName;

                if (audioCache[fileName]) {
                    loadedCount++;
                    loadingStatus.textContent = `üîÑ ƒêang t·∫£i √¢m thanh... ${Math.round((loadedCount/totalNotes)*100)}%`;
                    return;
                }

                try {
                    const audio = new Audio(url);
                    audio.preload = 'auto';
                    await new Promise((resolve) => {
                        audio.addEventListener('canplaythrough', () => {
                            audioCache[fileName] = audio;
                            loadedCount++;
                            loadingStatus.textContent = `üîÑ ƒêang t·∫£i √¢m thanh... ${Math.round((loadedCount/totalNotes)*100)}%`;
                            resolve();
                        }, { once: true });
                        audio.addEventListener('error', () => {
                            console.warn(`Kh√¥ng t·∫£i ƒë∆∞·ª£c ${fileName}`);
                            loadedCount++;
                            loadingStatus.textContent = `üîÑ ƒêang t·∫£i √¢m thanh... ${Math.round((loadedCount/totalNotes)*100)}% (m·ªôt s·ªë file l·ªói)`;
                            resolve();
                        }, { once: true });
                        audio.load();
                    });
                } catch (error) {
                    console.error(`L·ªói t·∫£i ${fileName}:`, error);
                    loadedCount++;
                    loadingStatus.textContent = `üîÑ ƒêang t·∫£i √¢m thanh... ${Math.round((loadedCount/totalNotes)*100)}% (l·ªói)`;
                }
            });

            await Promise.all(loadPromises);
            audioLoaded = true;
            loadingStatus.textContent = '‚úÖ ƒê√£ t·∫£i xong t·∫•t c·∫£ √¢m thanh!';
            loadingStatus.classList.add('loaded');

            document.getElementById('btn-arpeggio').disabled = false;
            document.getElementById('btn-chord').disabled = false;

            setTimeout(() => { loadingStatus.style.display = 'none'; }, 2000);
        }

        function createPiano() {
            const piano = document.getElementById('piano');
            let whiteKeyIndex = 0;

            const rootStyle = getComputedStyle(document.documentElement);
            const WHITE_KEY_WIDTH = parseFloat(rootStyle.getPropertyValue('--white-key-width')) || 50;
            const BLACK_KEY_OFFSET = parseFloat(rootStyle.getPropertyValue('--black-key-offset')) || 17.5;

            pianoKeys.forEach((key, index) => {
                const keyElement = document.createElement('div');
                keyElement.className = `key ${key.type}-key`;
                keyElement.dataset.note = key.note;
                keyElement.dataset.octave = key.octave;
                keyElement.dataset.index = index;

                const label = document.createElement('span');
                label.textContent = key.note + key.octave;
                keyElement.appendChild(label);

                if (key.type === 'white') {
                    piano.appendChild(keyElement);
                    whiteKeyIndex++;
                } else {
                    keyElement.style.left = `${(whiteKeyIndex * WHITE_KEY_WIDTH) - BLACK_KEY_OFFSET}px`;
                    piano.appendChild(keyElement);
                }

                keyElement.addEventListener('click', () => playNote(key.note, key.octave, true));
            });
        }

        function getChordNotes(root, chordType) {
            const normalizedRoot = root === 'Db' ? 'C#' :
                                   root === 'Eb' ? 'D#' :
                                   root === 'Gb' ? 'F#' :
                                   root === 'Ab' ? 'G#' :
                                   root === 'Bb' ? 'A#' : root;

            const rootIndex = chromaticScale.indexOf(normalizedRoot);
            const formula = chordFormulas[chordType];
            const notes = [];

            let rootOctave = 4;
            const rootKey = pianoKeys.find(k => k.note === normalizedRoot && k.octave === rootOctave);
            if (!rootKey) rootOctave = 3;

            formula.forEach(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const noteName = chromaticScale[noteIndex];
                let octaveOffset = Math.floor((rootIndex + interval) / 12);
                let targetOctave = rootOctave + octaveOffset;
                if (targetOctave < 3) targetOctave = 3;
                if (targetOctave > 6) targetOctave = 6;
                const key = pianoKeys.find(k => k.note === noteName && k.octave === targetOctave);
                if (key) notes.push({note: noteName, octave: targetOctave});
            });

            return notes;
        }

        function updateChordDisplay() {
            const root = document.getElementById('root-select').value;
            const chordType = document.getElementById('chord-select').value;

            document.querySelectorAll('.key').forEach(key => key.classList.remove('active'));

            currentChordNotes = getChordNotes(root, chordType);

            currentChordNotes.forEach(({note, octave}) => {
                const keyElement = document.querySelector(`.key[data-note="${note}"][data-octave="${octave}"]`);
                if (keyElement) keyElement.classList.add('active');
            });

            const displayRoot = root === 'Db' ? 'C#' : root;
            const suffix = chordType === 'major' ? '' : chordType === 'minor' ? 'm' : chordType;

            document.getElementById('chord-name').textContent = `${displayRoot}${suffix}`;
            document.getElementById('chord-notes').textContent = `C√°c n·ªët: ${currentChordNotes.map(n => n.note + n.octave).join(' - ')}`;

            // ƒê·∫£m b·∫£o layout ƒë√£ render xong tr∆∞·ªõc khi cu·ªôn: g·ªçi double rAF v√† fallback timeout
            requestAnimationFrame(() => requestAnimationFrame(scrollToChord));
            setTimeout(scrollToChord, 120);
        }

        // C·∫¨P NH·∫¨T: d√πng getBoundingClientRect v√† to·∫° ƒë·ªô relative t·ªõi piano-container + scrollLeft
        function scrollToChord() {
            try {
                const pianoContainer = document.querySelector('.piano-container');
                const piano = document.getElementById('piano');
                if (!pianoContainer || !piano) return;

                // Ki·ªÉm tra mobile portrait (c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh breakpoint)
                const isMobilePortrait = window.matchMedia('(max-width: 600px) and (orientation: portrait)').matches;
                if (!isMobilePortrait) return;
                if (!currentChordNotes || currentChordNotes.length === 0) return;

                // L·∫•y c√°c element key c·ªßa h·ª£p √¢m
                const elements = currentChordNotes.map(n => document.querySelector(`.key[data-note="${n.note}"][data-octave="${n.octave}"]`)).filter(Boolean);
                if (elements.length === 0) return;

                const containerRect = pianoContainer.getBoundingClientRect();

                // T√≠nh minLeft v√† maxRight b·∫±ng c√°ch chuy·ªÉn to·∫° ƒë·ªô viewport -> to·∫° ƒë·ªô scroll n·ªôi b·ªô
                let minLeft = Infinity, maxRight = -Infinity;
                elements.forEach(el => {
                    const elRect = el.getBoundingClientRect();
                    // v·ªã tr√≠ left relative to pianoContainer's content (include current scroll)
                    const leftRelative = (elRect.left - containerRect.left) + pianoContainer.scrollLeft;
                    const rightRelative = (elRect.right - containerRect.left) + pianoContainer.scrollLeft;
                    if (leftRelative < minLeft) minLeft = leftRelative;
                    if (rightRelative > maxRight) maxRight = rightRelative;
                });

                const chordCenter = (minLeft + maxRight) / 2;
                const containerWidth = pianoContainer.clientWidth;
                let targetScroll = chordCenter - containerWidth / 2;

                // clamp
                if (targetScroll < 0) targetScroll = 0;
                const maxScroll = piano.scrollWidth - containerWidth;
                if (targetScroll > maxScroll) targetScroll = maxScroll;

                // N·∫øu targetScroll g·∫ßn v·ªõi current scroll (v√≠ d·ª• <1px) th√¨ skip
                if (Math.abs(pianoContainer.scrollLeft - targetScroll) < 1) return;

                pianoContainer.scrollTo({ left: targetScroll, behavior: 'smooth' });
            } catch (err) {
                console.warn('scrollToChord error:', err);
            }
        }

        async function playNote(note, octave, highlight = false) {
            initAudioContext();

            const fileNote = noteToFile[note];
            const fileName = `${fileNote}${octave}.mp3`;
            const url = BASE_URL + fileName;

            if (!audioCache[fileName]) {
                try {
                    const tempAudio = new Audio(url);
                    tempAudio.currentTime = 0;
                    if (highlight) {
                        const keyElement = document.querySelector(`.key[data-note="${note}"][data-octave="${octave}"]`);
                        if (keyElement) {
                            keyElement.classList.add('playing');
                            setTimeout(() => keyElement.classList.remove('playing'), 300);
                        }
                    }
                    await tempAudio.play();
                    return;
                } catch (err) {
                    console.error('L·ªói ph√°t audio t·∫°m:', err);
                    return;
                }
            }

            const cachedAudio = audioCache[fileName];
            const audioToPlay = cachedAudio.cloneNode(true);
            audioToPlay.currentTime = 0;

            if (highlight) {
                const keyElement = document.querySelector(`.key[data-note="${note}"][data-octave="${octave}"]`);
                if (keyElement) {
                    keyElement.classList.add('playing');
                    setTimeout(() => { keyElement.classList.remove('playing'); }, 300);
                }
            }

            try {
                await audioToPlay.play();
                audioToPlay.addEventListener('ended', () => { /* allow GC */ }, { once: true });
            } catch (error) {
                console.error('L·ªói ph√°t √¢m thanh:', error);
            }
        }

        async function playArpeggio() {
            initAudioContext();
            if (audioContext && audioContext.state === 'suspended') await audioContext.resume();

            // center before play (double rAF ensures layout done)
            requestAnimationFrame(() => requestAnimationFrame(scrollToChord));
            await new Promise(res => setTimeout(res, 120)); // brief wait to let scroll start

            if (isPlaying) return;
            isPlaying = true;
            for (const {note, octave} of currentChordNotes) {
                await playNote(note, octave, true);
                await new Promise(resolve => setTimeout(resolve, 400));
            }
            isPlaying = false;
        }

        async function playChord() {
            initAudioContext();
            if (audioContext && audioContext.state === 'suspended') await audioContext.resume();

            // center before play
            requestAnimationFrame(() => requestAnimationFrame(scrollToChord));
            await new Promise(res => setTimeout(res, 120));

            if (isPlaying) return;
            isPlaying = true;

            currentChordNotes.forEach(({note, octave}) => {
                const keyElement = document.querySelector(`.key[data-note="${note}"][data-octave="${octave}"]`);
                if (keyElement) keyElement.classList.add('playing');
            });

            await Promise.all(currentChordNotes.map(({note, octave}) => playNote(note, octave, false)));

            setTimeout(() => {
                currentChordNotes.forEach(({note, octave}) => {
                    const keyElement = document.querySelector(`.key[data-note="${note}"][data-octave="${octave}"]`);
                    if (keyElement) keyElement.classList.remove('playing');
                });
                isPlaying = false;
            }, 300);
        }

        // Khi orientation thay ƒë·ªïi - ƒë·ª£i layout r·ªìi realign
        window.addEventListener('orientationchange', () => {
            setTimeout(() => requestAnimationFrame(() => requestAnimationFrame(scrollToChord)), 250);
        });

        async function initialize() {
            createPiano();
            updateChordDisplay();
            await preloadAllAudio();
            // center after everything ready (small delay)
            setTimeout(() => requestAnimationFrame(() => requestAnimationFrame(scrollToChord)), 200);
        }

        initialize();

        document.getElementById('root-select').addEventListener('change', updateChordDisplay);
        document.getElementById('chord-select').addEventListener('change', updateChordDisplay);
    </script>
</body>
</html>
