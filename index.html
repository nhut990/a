<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªô Hi·ªÉn Th·ªã H·ª£p √Çm Piano</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .chord-display {
            text-align: center;
            margin-bottom: 25px;
        }

        .chord-name-box {
            display: inline-block;
            padding: 20px 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 42px;
            font-weight: bold;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
            min-width: 180px;
            letter-spacing: 2px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        label {
            font-weight: 600;
            color: #555;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover {
            border-color: #764ba2;
        }

        .play-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .play-arpeggio {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .play-chord {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .piano-container {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            padding: 40px;
            border-radius: 15px;
            overflow-x: auto;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .piano {
            position: relative;
            height: 240px;
            margin: 0 auto;
            width: 496px;
        }

        .key {
            position: absolute;
            cursor: pointer;
            user-select: none;
            transition: all 0.05s ease;
        }

        .white-key {
            width: 62px;
            height: 240px;
            background: linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%);
            border: 2px solid #222;
            border-radius: 0 0 5px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 12px;
            font-size: 14px;
            color: #555;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .white-key:hover {
            background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .white-key.active {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 2px 10px rgba(255,255,255,0.3);
        }

        .white-key.playing {
            background: linear-gradient(180deg, #ff9800 0%, #ff5722 100%) !important;
            color: white !important;
            transform: translateY(3px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 10px rgba(255,255,255,0.3);
        }

        .black-key {
            width: 38px;
            height: 150px;
            background: linear-gradient(180deg, #3a3a3a 0%, #000000 100%);
            border: 2px solid #000;
            border-radius: 0 0 4px 4px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 10px;
            font-size: 11px;
            color: #aaa;
            font-weight: 600;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.6);
        }

        .black-key:hover {
            background: linear-gradient(180deg, #4a4a4a 0%, #1a1a1a 100%);
        }

        .black-key.active {
            background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.6), inset 0 2px 8px rgba(255,255,255,0.3);
        }

        .black-key.playing {
            background: linear-gradient(180deg, #ff9800 0%, #ff5722 100%) !important;
            color: white !important;
            transform: translateY(3px);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.6), inset 0 2px 8px rgba(255,255,255,0.3);
        }

        .chord-info {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .chord-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .chord-notes {
            font-size: 18px;
            color: #555;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 15px;
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            background: #f0f4ff;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéπ B·ªô Hi·ªÉn Th·ªã H·ª£p √Çm Piano</h1>
        
        <div class="chord-display">
            <div class="chord-name-box" id="chordNameBox">C</div>
        </div>

        <div class="controls">
            <div>
                <label for="root">N·ªët g·ªëc:</label>
                <select id="root">
                    <option value="C">C</option>
                    <option value="Db">C# / Db</option>
                    <option value="D">D</option>
                    <option value="Eb">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="Gb">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="Ab">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="Bb">A# / Bb</option>
                    <option value="B">B</option>
                </select>
            </div>
            
            <div>
                <label for="chordType">Lo·∫°i h·ª£p √¢m:</label>
                <select id="chordType">
                    <optgroup label="C∆° b·∫£n">
                        <option value="major">Major (Major Triad)</option>
                        <option value="minor">Minor (m)</option>
                        <option value="dim">Diminished (dim)</option>
                        <option value="aug">Augmented (aug)</option>
                    </optgroup>
                    <optgroup label="Seventh Chords">
                        <option value="7">Dominant 7th (7)</option>
                        <option value="maj7">Major 7th (maj7)</option>
                        <option value="m7">Minor 7th (m7)</option>
                        <option value="m7b5">Half Diminished (m7b5)</option>
                        <option value="dim7">Diminished 7th (dim7)</option>
                    </optgroup>
                    <optgroup label="Suspended">
                        <option value="sus2">Suspended 2nd (sus2)</option>
                        <option value="sus4">Suspended 4th (sus4)</option>
                    </optgroup>
                    <optgroup label="Extended">
                        <option value="6">Major 6th (6)</option>
                        <option value="m6">Minor 6th (m6)</option>
                        <option value="9">Dominant 9th (9)</option>
                        <option value="maj9">Major 9th (maj9)</option>
                        <option value="m9">Minor 9th (m9)</option>
                        <option value="add9">Add 9 (add9)</option>
                    </optgroup>
                </select>
            </div>

            <div class="play-buttons">
                <button class="play-arpeggio" onclick="playArpeggio()">‚ñ∂ Ch·∫°y T·ª´ng N·ªët</button>
                <button class="play-chord" onclick="playChord()">‚ñ∂ Ph√°t C√πng L√∫c</button>
            </div>
        </div>

        <div class="piano-container">
            <div class="piano" id="piano"></div>
        </div>

        <div class="chord-info">
            <h3>Th√¥ng tin h·ª£p √¢m</h3>
            <div class="chord-notes" id="chordNotes">Ch·ªçn h·ª£p √¢m ƒë·ªÉ xem c√°c n·ªët</div>
        </div>
        
        <div class="loading" id="loading">‚è≥ ƒêang t·∫£i √¢m thanh...</div>
    </div>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const baseUrl = 'https://nhut11790.github.io/tieng/acoustic_grand_piano-mp3/';
        
        const noteToFile = {
            'C': 'C', 'Db': 'Db', 'D': 'D', 'Eb': 'Eb', 'E': 'E', 'F': 'F',
            'Gb': 'Gb', 'G': 'G', 'Ab': 'Ab', 'A': 'A', 'Bb': 'Bb', 'B': 'B'
        };

        const allNotes = [
            'C3', 'Db3', 'D3', 'Eb3', 'E3', 'F3', 'Gb3', 'G3', 'Ab3', 'A3', 'Bb3', 'B3', 'C4'
        ];

        const chordFormulas = {
            'major': [0, 4, 7],
            'minor': [0, 3, 7],
            'dim': [0, 3, 6],
            'aug': [0, 4, 8],
            '7': [0, 4, 7, 10],
            'maj7': [0, 4, 7, 11],
            'm7': [0, 3, 7, 10],
            'm7b5': [0, 3, 6, 10],
            'dim7': [0, 3, 6, 9],
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],
            '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9],
            '9': [0, 4, 7, 10, 14],
            'maj9': [0, 4, 7, 11, 14],
            'm9': [0, 3, 7, 10, 14],
            'add9': [0, 4, 7, 14]
        };

        let currentChordNotes = [];
        let audioBuffers = {};
        let isPlaying = false;

        function createPiano() {
            const piano = document.getElementById('piano');
            piano.innerHTML = '';

            const whiteKeys = [
                { note: 'C3', left: 0 },
                { note: 'D3', left: 62 },
                { note: 'E3', left: 124 },
                { note: 'F3', left: 186 },
                { note: 'G3', left: 248 },
                { note: 'A3', left: 310 },
                { note: 'B3', left: 372 },
                { note: 'C4', left: 434 }
            ];

            const blackKeys = [
                { note: 'Db3', left: 43, display: 'C#3' },
                { note: 'Eb3', left: 105, display: 'D#3' },
                { note: 'Gb3', left: 229, display: 'F#3' },
                { note: 'Ab3', left: 291, display: 'G#3' },
                { note: 'Bb3', left: 353, display: 'A#3' }
            ];

            whiteKeys.forEach(key => {
                const keyEl = document.createElement('div');
                keyEl.className = 'white-key key';
                keyEl.dataset.note = key.note;
                keyEl.textContent = key.note;
                keyEl.style.left = `${key.left}px`;
                keyEl.onclick = () => playNote(key.note, true);
                piano.appendChild(keyEl);
            });

            blackKeys.forEach(key => {
                const keyEl = document.createElement('div');
                keyEl.className = 'black-key key';
                keyEl.dataset.note = key.note;
                keyEl.textContent = key.display;
                keyEl.style.left = `${key.left}px`;
                keyEl.onclick = () => playNote(key.note, true);
                piano.appendChild(keyEl);
            });
        }

        async function loadSound(note) {
            if (audioBuffers[note]) return audioBuffers[note];

            const fileName = noteToFile[note.slice(0, -1)] + note.slice(-1);
            const url = `${baseUrl}${fileName}.mp3`;

            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                audioBuffers[note] = audioBuffer;
                return audioBuffer;
            } catch (error) {
                console.error(`Kh√¥ng th·ªÉ t·∫£i √¢m thanh cho ${note}:`, error);
                return null;
            }
        }

        async function playNote(note, highlight = false) {
            const buffer = await loadSound(note);
            if (!buffer) return;

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);

            if (highlight) {
                const key = document.querySelector(`[data-note="${note}"]`);
                if (key) {
                    key.classList.add('playing');
                    setTimeout(() => {
                        key.classList.remove('playing');
                    }, 350);
                }
            }
        }

        function calculateChordNotes(root, chordType) {
            const rootIndex = allNotes.findIndex(n => n.startsWith(root) && n.endsWith('3'));
            if (rootIndex === -1) return [];

            const formula = chordFormulas[chordType];
            const notes = formula.map(interval => {
                const noteIndex = rootIndex + interval;
                return noteIndex < allNotes.length ? allNotes[noteIndex] : null;
            }).filter(n => n !== null);

            return notes;
        }

        function updateChordDisplay() {
            const root = document.getElementById('root').value;
            const chordType = document.getElementById('chordType').value;
            
            currentChordNotes = calculateChordNotes(root, chordType);

            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('active');
            });

            currentChordNotes.forEach(note => {
                const key = document.querySelector(`[data-note="${note}"]`);
                if (key) key.classList.add('active');
            });

            const chordName = root + getChordSymbol(chordType);
            document.getElementById('chordNameBox').textContent = chordName;

            const notesDisplay = currentChordNotes.join(' - ');
            document.getElementById('chordNotes').textContent = 
                `${chordName}: ${notesDisplay}`;
        }

        function getChordSymbol(type) {
            const symbols = {
                'major': '', 'minor': 'm', 'dim': 'dim', 'aug': 'aug',
                '7': '7', 'maj7': 'maj7', 'm7': 'm7', 'm7b5': 'm7b5',
                'dim7': 'dim7', 'sus2': 'sus2', 'sus4': 'sus4',
                '6': '6', 'm6': 'm6', '9': '9', 'maj9': 'maj9',
                'm9': 'm9', 'add9': 'add9'
            };
            return symbols[type] || '';
        }

        async function playArpeggio() {
            if (isPlaying || currentChordNotes.length === 0) return;
            
            isPlaying = true;
            const btn = document.querySelector('.play-arpeggio');
            btn.disabled = true;

            for (const note of currentChordNotes) {
                await playNote(note, true);
                await new Promise(resolve => setTimeout(resolve, 450));
            }

            isPlaying = false;
            btn.disabled = false;
        }

        async function playChord() {
            if (isPlaying || currentChordNotes.length === 0) return;
            
            isPlaying = true;
            const btn = document.querySelector('.play-chord');
            btn.disabled = true;

            currentChordNotes.forEach(note => {
                const key = document.querySelector(`[data-note="${note}"]`);
                if (key) key.classList.add('playing');
            });

            await Promise.all(currentChordNotes.map(note => playNote(note, false)));

            setTimeout(() => {
                currentChordNotes.forEach(note => {
                    const key = document.querySelector(`[data-note="${note}"]`);
                    if (key) key.classList.remove('playing');
                });
                isPlaying = false;
                btn.disabled = false;
            }, 350);
        }

        async function preloadAllSounds() {
            const loading = document.getElementById('loading');
            loading.textContent = '‚è≥ ƒêang t·∫£i √¢m thanh...';
            
            const promises = allNotes.map(note => loadSound(note));
            await Promise.all(promises);
            
            loading.textContent = '‚úÖ ƒê√£ t·∫£i xong t·∫•t c·∫£ √¢m thanh!';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 2000);
        }

        createPiano();
        updateChordDisplay();

        document.getElementById('root').addEventListener('change', updateChordDisplay);
        document.getElementById('chordType').addEventListener('change', updateChordDisplay);

        preloadAllSounds();
    </script>
</body>
</html>