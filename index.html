<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Tạo Ảnh Thẻ AI</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thêm font Inter cho đẹp -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Áp dụng font Inter làm font chữ mặc định */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 sm:p-8 bg-gray-100">

    <div class="w-full max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">App Tạo Ảnh Thẻ AI</h1>
            <p class="mt-2 text-md sm:text-lg text-gray-600">Tải ảnh chân dung lên, app sẽ tự động xử lý khuôn mặt, cắt khung 4x6, đổi nền và thay trang phục bằng AI.</p>
        </header>

        <!-- Nội dung chính: Cài đặt và Kết quả -->
        <main class="flex flex-col lg:flex-row gap-8">
            
            <!-- Cột 1: Cài đặt & Upload -->
            <div class="lg:w-1/3 w-full p-6 bg-white rounded-lg shadow-xl">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-3">1. Cài đặt</h2>
                
                <!-- Bước 1: Upload -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tải ảnh chân dung</label>
                    <div class="w-full">
                        <label for="file-upload" class="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                            <!-- Vùng placeholder -->
                            <div id="upload-placeholder" class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mb-4 text-gray-500">
                                    <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                                    <path d="M12 12v9" />
                                    <path d="m16 16-4-4-4 4" />
                                </svg>
                                <p class="mb-2 text-sm font-semibold text-gray-700">Kéo hoặc chọn ảnh chân dung</p>
                                <p class="text-xs text-gray-500">PNG, JPG, WEBP (Tối đa 5MB)</p>
                            </div>
                            <!-- Vùng xem trước ảnh gốc -->
                            <img id="upload-preview" src="" alt="Ảnh gốc" class="hidden object-contain w-full h-full rounded-lg" />
                        </label>
                        <input id="file-upload" type="file" class="hidden" accept="image/*" onchange="handleImageUpload(event)" />
                    </div>
                </div>

                <!-- Bước 2: Chọn trang phục -->
                <div class="mb-6">
                    <label for="clothing-select" class="block text-sm font-medium text-gray-700 mb-2">
                        Chọn trang phục AI
                    </label>
                    <select id="clothing-select" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="white shirt and tie">Sơ mi trắng và cà vạt</option>
                        <option value="colored shirt and tie">Sơ mi màu và cà vạt</option>
                        <option value="graduation gown with shirt and tie">Lễ phục tốt nghiệp (có sơ mi, cà vạt)</option>
                        <option value="polo shirt">Áo thun polo</option>
                        <option value="business suit with shirt and tie">Áo vest doanh nhân (có sơ mi, cà vạt)</option>
                        <option value="European tuxedo">Tuxedo Châu Âu</option>
                        <option value="Japanese kimono">Kimono Nhật</option>
                    </select>
                </div>

                <!-- Nút Tạo ảnh -->
                <button id="generate-button" onclick="generateImages()" disabled class="w-full inline-flex items-center justify-center px-6 py-3 text-lg font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all duration-200">
                    <!-- Trạng thái mặc định -->
                    <span id="generate-btn-content" class="inline-flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3">
                            <path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.71 0L11.5 9.51a.5.5 0 0 1-.35.15h-1.8a.5.5 0 0 1-.35-.15L3.64 4.36a1.21 1.21 0 0 0-1.71 0L.65 5.64a1.21 1.21 0 0 0 0 1.71l5.37 5.37a.5.5 0 0 1 .15.35v1.8a.5.5 0 0 1-.15.35l-5.37 5.37a1.21 1.21 0 0 0 0 1.71l1.28 1.28a1.21 1.21 0 0 0 1.71 0l5.37-5.37a.5.5 0 0 1 .35-.15h1.8a.5.5 0 0 1 .35.15l5.37 5.37a1.21 1.21 0 0 0 1.71 0l1.28-1.28a1.21 1.21 0 0 0 0-1.71L14.49 13.5a.5.5 0 0 1-.15-.35v-1.8a.5.5 0 0 1 .15-.35l5.37-5.37a1.21 1.21 0 0 0 0-1.71z" />
                        </svg>
                        Tạo lại ảnh
                    </span>
                    <!-- Trạng thái đang tải -->
                    <span id="generate-btn-loader" class="hidden inline-flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3 animate-spin">
                            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                        </svg>
                        Đang xử lý...
                    </span>
                </button>

                <!-- Thông báo lỗi -->
                <div id="error-message" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-800 rounded-md text-sm">
                    <!-- Lỗi sẽ xuất hiện ở đây -->
                </div>
            </div>

            <!-- Cột 2: Kết quả -->
            <div class="lg:w-2/3 w-full p-6 bg-white rounded-lg shadow-xl">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-3">2. Kết quả</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 w-full">
                    <!-- Card Nền Trắng -->
                    <div class="flex flex-col items-center p-4 border rounded-lg shadow-sm bg-white">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">Nền Trắng</h3>
                        <div class="w-full bg-gray-200 rounded-md aspect-[2/3] flex items-center justify-center overflow-hidden">
                            <!-- Loader -->
                            <div id="loader-white" class="hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 text-blue-600 animate-spin">
                                    <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                                </svg>
                            </div>
                            <!-- Ảnh kết quả -->
                            <img id="result-white-img" src="" alt="Nền Trắng" class="hidden object-cover w-full h-full" />
                            <!-- Placeholder -->
                            <div id="placeholder-white" class="text-gray-500">Xem trước</div>
                        </div>
                        <button id="download-white-btn" onclick="handleDownload(generatedWhiteBg, 'anh-the-nen-trang.png')" disabled class="mt-4 inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            Tải về ảnh PNG
                        </button>
                    </div>
                    
                    <!-- Card Nền Xanh -->
                    <div class="flex flex-col items-center p-4 border rounded-lg shadow-sm bg-white">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">Nền Xanh Royal</h3>
                        <div class="w-full bg-gray-200 rounded-md aspect-[2/3] flex items-center justify-center overflow-hidden">
                            <!-- Loader -->
                            <div id="loader-blue" class="hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 text-blue-600 animate-spin">
                                    <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                                </svg>
                            </div>
                            <!-- Ảnh kết quả -->
                            <img id="result-blue-img" src="" alt="Nền Xanh Royal" class="hidden object-cover w-full h-full" />
                            <!-- Placeholder -->
                            <div id="placeholder-blue" class="text-gray-500">Xem trước</div>
                        </div>
                        <button id="download-blue-btn" onclick="handleDownload(generatedBlueBg, 'anh-the-nen-xanh.png')" disabled class="mt-4 inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            Tải về ảnh PNG
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Logic -->
    <script>
        "use strict";

        // --- Biến toàn cục (thay thế cho React state) ---
        let originalImage = null;
        let originalMimeType = '';
        let selectedClothing = "white shirt and tie"; // Giá trị mặc định
        let generatedWhiteBg = null;
        let generatedBlueBg = null;
        let isLoading = false;

        // --- Tham chiếu đến các phần tử DOM ---
        const fileUpload = document.getElementById('file-upload');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const uploadPreview = document.getElementById('upload-preview');
        const clothingSelect = document.getElementById('clothing-select');
        const generateButton = document.getElementById('generate-button');
        const generateBtnContent = document.getElementById('generate-btn-content');
        const generateBtnLoader = document.getElementById('generate-btn-loader');
        const errorMessage = document.getElementById('error-message');
        
        const loaderWhite = document.getElementById('loader-white');
        const placeholderWhite = document.getElementById('placeholder-white');
        const resultWhiteImg = document.getElementById('result-white-img');
        const downloadWhiteBtn = document.getElementById('download-white-btn');
        
        const loaderBlue = document.getElementById('loader-blue');
        const placeholderBlue = document.getElementById('placeholder-blue');
        const resultBlueImg = document.getElementById('result-blue-img');
        const downloadBlueBtn = document.getElementById('download-blue-btn');

        // --- Hàm gọi API Gemini (giữ nguyên từ code React) ---
        const callGeminiApi = async (base64Data, mimeType, prompt) => {
            const apiKey = ""; // Canvas sẽ tự động cung cấp
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            let retries = 5;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const generatedPart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                    
                    if (generatedPart) {
                        return `data:${generatedPart.inlineData.mimeType};base64,${generatedPart.inlineData.data}`;
                    } else {
                        throw new Error("Không tìm thấy dữ liệu ảnh trong phản hồi API.");
                    }
                } catch (error) {
                    console.error(`Lỗi API (lần thử ${i + 1}/${retries}):`, error);
                    if (i === retries - 1) {
                        throw error; // Ném lỗi cuối cùng
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        };

        // --- Hàm xây dựng Prompt (giữ nguyên) ---
        const buildPrompt = (clothing, background) => {
            let backgroundPrompt = "";
            if (background === "white") {
                backgroundPrompt = "The background must be solid white (#FFFFFF).";
            } else if (background === "blue") {
                backgroundPrompt = "The background must be solid royal blue (#4169E1).";
            }

            return `
                Tạo một ảnh thẻ 4x6 cm chuyên nghiệp (tỷ lệ 2:3).
                1.  **Chân dung:** Người trong ảnh phải nhìn thẳng vào camera, biểu cảm nghiêm túc, miệng khép tự nhiên, không cười.
                2.  **Căn chỉnh & Crop:** Tự động nhận diện khuôn mặt và vai. Căn giữa khuôn mặt. Crop ảnh theo tỷ lệ 2:3 (ảnh thẻ 4x6 cm). Kích thước đầu và vai phải tuân thủ tiêu chuẩn ảnh thẻ.
                3.  **Trang phục:** Thay trang phục của người đó thành: "${clothing}".
                4.  **Nền:** ${backgroundPrompt}
                5.  **Chất lượng:** Tự động tăng độ nét, làm sáng ảnh và cân bằng tông màu da để trông chuyên nghiệp và rõ nét.
            `;
        };

        // --- Hàm tiện ích để cập nhật giao diện ---
        function setLoading(loading) {
            isLoading = loading;
            generateButton.disabled = loading;

            if (loading) {
                // Nút tạo ảnh
                generateBtnContent.classList.add('hidden');
                generateBtnLoader.classList.remove('hidden');
                
                // Thẻ xem trước
                loaderWhite.classList.remove('hidden');
                loaderBlue.classList.remove('hidden');
                placeholderWhite.classList.add('hidden');
                placeholderBlue.classList.add('hidden');
                resultWhiteImg.classList.add('hidden');
                resultBlueImg.classList.add('hidden');
                
                downloadWhiteBtn.disabled = true;
                downloadBlueBtn.disabled = true;
            } else {
                // Nút tạo ảnh
                generateBtnContent.classList.remove('hidden');
                generateBtnLoader.classList.add('hidden');
                
                // Ẩn loader
                loaderWhite.classList.add('hidden');
                loaderBlue.classList.add('hidden');
                
                // Nút generate chỉ bật lại khi có ảnh gốc
                generateButton.disabled = !originalImage;
            }
        }

        function showError(message) {
            if (message) {
                errorMessage.innerHTML = message;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.innerHTML = '';
                errorMessage.classList.add('hidden');
            }
        }

        // --- Xử lý sự kiện ---
        
        // Cập nhật khi chọn trang phục
        clothingSelect.onchange = (event) => {
            selectedClothing = event.target.value;
        };

        // Xử lý tải ảnh lên
        const handleImageUpload = (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError("Tệp tải lên phải là ảnh (JPG, PNG, WEBP, v.v.).");
                return;
            }
            
            showError(null);
            
            // Đặt lại ảnh đã tạo
            generatedWhiteBg = null;
            generatedBlueBg = null;
            resultWhiteImg.src = '';
            resultBlueImg.src = '';
            resultWhiteImg.classList.add('hidden');
            resultBlueImg.classList.add('hidden');
            placeholderWhite.classList.remove('hidden');
            placeholderBlue.classList.remove('hidden');
            downloadWhiteBtn.disabled = true;
            downloadBlueBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                originalImage = dataUrl;
                originalMimeType = file.type;
                
                // Cập nhật DOM
                uploadPreview.src = dataUrl;
                uploadPreview.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                generateButton.disabled = false; // Kích hoạt nút tạo ảnh
            };
            reader.onerror = () => {
                showError("Không thể đọc tệp ảnh.");
            };
            reader.readAsDataURL(file);
        };

        // Hàm tạo ảnh chính
        const generateImages = async () => {
            if (!originalImage) {
                showError("Vui lòng tải ảnh chân dung lên trước.");
                return;
            }

            setLoading(true);
            showError(null);

            const base64Data = originalImage.split(',')[1];
            
            try {
                // --- 1. Tạo ảnh nền trắng ---
                console.log("Đang tạo ảnh nền trắng...");
                const whiteBgPrompt = buildPrompt(selectedClothing, "white");
                const whiteBgResult = await callGeminiApi(base64Data, originalMimeType, whiteBgPrompt);
                generatedWhiteBg = whiteBgResult;
                resultWhiteImg.src = whiteBgResult;
                resultWhiteImg.classList.remove('hidden');
                downloadWhiteBtn.disabled = false;
                console.log("Đã tạo xong ảnh nền trắng.");

                // --- 2. Tạo ảnh nền xanh ---
                console.log("Đang tạo ảnh nền xanh royal...");
                const blueBgPrompt = buildPrompt(selectedClothing, "blue");
                const blueBgResult = await callGeminiApi(base64Data, originalMimeType, blueBgPrompt);
                generatedBlueBg = blueBgResult;
                resultBlueImg.src = blueBgResult;
                resultBlueImg.classList.remove('hidden');
                downloadBlueBtn.disabled = false;
                console.log("Đã tạo xong ảnh nền xanh.");

            } catch (err) {
                console.error("Lỗi trong quá trình tạo ảnh:", err);
                showError(`Không thể tạo ảnh. Lỗi: ${err.message}. Vui lòng thử lại.`);
                // Hiển thị lại placeholder nếu ảnh bị lỗi
                if (!generatedWhiteBg) placeholderWhite.classList.remove('hidden');
                if (!generatedBlueBg) placeholderBlue.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        };

        // Hàm tải ảnh về
        const handleDownload = (imageUrl, filename) => {
            if (!imageUrl) return;
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

    </script>
</body>
</html>
