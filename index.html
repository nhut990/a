<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Check-in BV nh√¢n d√¢n Gia ƒê·ªãnh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsPDF & autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7fafd; margin: 0; padding: 0; min-height: 100vh;}
    .container { max-width: 440px; margin: 40px auto; background: #fff; border-radius: 16px;
      box-shadow: 0 2px 12px #0002; padding: 32px 24px 32px 24px;}
    h2 { text-align: center; color: #1275d1; font-size: 2em; margin-bottom: 8px;}
    .event-name { display: block; font-size: 1.28em; font-weight: bold; text-align: center; color: #e74c3c; margin-bottom: 28px; margin-top: 0;}
    label { font-size: 1.1em; margin-top: 18px; display: block; font-weight: 500;}
    input[type="text"] { width: 100%; padding: 12px 10px; font-size: 1.1em; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ccc; margin-top: 4px; box-sizing: border-box;}
    .btn-group { margin-top: 18px; text-align: center;}
    button { font-size: 1.1em; padding: 13px 26px; margin: 0 7px; background: #1275d1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;}
    button:hover, button:focus { background: #0d60b6;}
    #status { font-size: 1.04em; margin: 15px 0 5px 0; text-align: center; min-height: 28px; color: #333;}
    #list { margin-top: 32px;}
    table { width: 100%; border-collapse: collapse; margin-top: 7px;}
    th, td { border: 1px solid #d1e4f1; padding: 7px 2px; text-align: center; font-size: 1.05em;}
    th { background: #e3f0fa; color: #1275d1;}
    .pdf-btn-wrap {text-align:center;margin:14px 0;}
    .pdf-btn-wrap button { background:#dc3545;color:white;}
    @media (max-width: 540px) { .container { max-width: 96vw; padding: 9vw 2vw; margin: 6vw 1vw;} h2 { font-size: 1.25em; } }
  </style>
</head>
<body>
  <div class="container">
    <h2>ƒêI·ªÇM DANH CHECK-IN/CHECK-OUT</h2>
    <div class="event-name">BV nh√¢n d√¢n Gia ƒê·ªãnh</div>
    <form id="form" autocomplete="off" onsubmit="return false;">
      <label for="name">H·ªç v√† t√™n:</label>
      <input id="name" type="text" autocomplete="off" required placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n">
      <label for="userid">M√£ s·ªë/Nick/ID:</label>
      <input id="userid" type="text" autocomplete="off" required placeholder="Nh·∫≠p m√£ s·ªë nh√¢n vi√™n, nick ho·∫∑c ID">
      <div class="btn-group">
        <button type="button" onclick="checkin()" id="btn-checkin">Check-in</button>
        <button type="button" onclick="checkout()" id="btn-checkout" style="background:#f39c12;">Check-out</button>
      </div>
    </form>
    <div id="status"></div>
    <div id="list"></div>
    <div class="pdf-btn-wrap">
      <button onclick="exportPDF()">T·∫£i PDF danh s√°ch</button>
    </div>
  </div>
  <!-- Nh√∫ng font NotoSans-Regular ƒë√£ convert jsPDF VFS (r√∫t g·ªçn DEMO, d√πng th·ª±c t·∫ø h√£y d√πng font ƒë·∫ßy ƒë·ªß) -->
  <script>
  const NotoSansRegular = 
"AAEAAAARAQAABAAQRFNJRwAAAAEAAf6BAAAAVEdQT1PAAABvAAABTgAAAG5HU1VCAAAClAAAAbgAAAB\
... (ƒêO·∫†N BASE64 R·∫§T D√ÄI, ƒë√£ c·∫Øt b·ªõt ƒë·ªÉ demo. Khi d√πng th·ª±c t·∫ø h√£y convert ƒë·∫ßy ƒë·ªß b·∫±ng jsPDF fontconverter) ...\
AAAAA==";
  </script>
  <script>
    // === Init Firebase ===
    const firebaseConfig = {
      databaseURL: "https://nhutvan5c-79ce9-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === Config event name, kh√¥ng cho s·ª≠a ===
    const eventId = "BV-nhan-dan-Gia-Dinh"; // d√πng cho key tr√™n database

    // === Check-in function ===
    async function checkin() {
      let name = document.getElementById('name').value.trim();
      let userid = document.getElementById('userid').value.trim();
      if (!name || !userid) {
        showStatus("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† m√£ s·ªë/ID!", "#e74c3c");
        return;
      }
      let now = Math.floor(Date.now()/1000);
      try {
        await db.ref(`events/${eventId}/checkins/${userid}`).update({
          name,
          checkin: now
        });
        showStatus(`‚úÖ ${name} ƒë√£ <b>check-in</b> l√∫c ${toTime(now)}`, "#27ae60");
      } catch (e) {
        showStatus("C√≥ l·ªói khi check-in!", "#e74c3c");
      }
    }

    // === Check-out function ===
    async function checkout() {
      let name = document.getElementById('name').value.trim();
      let userid = document.getElementById('userid').value.trim();
      if (!name || !userid) {
        showStatus("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† m√£ s·ªë/ID!", "#e74c3c");
        return;
      }
      let now = Math.floor(Date.now()/1000);
      try {
        await db.ref(`events/${eventId}/checkins/${userid}`).update({
          name,
          checkout: now
        });
        showStatus(`üëã ${name} ƒë√£ <b>check-out</b> l√∫c ${toTime(now)}`, "#f39c12");
      } catch (e) {
        showStatus("C√≥ l·ªói khi check-out!", "#e74c3c");
      }
    }

    // === Hi·ªÉn th·ªã tr·∫°ng th√°i ===
    function showStatus(msg, color="#333") {
      let st = document.getElementById('status');
      st.innerHTML = msg;
      st.style.color = color;
    }

    // === Hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi ƒë√£ check-in/check-out ===
    function watchList() {
      db.ref(`events/${eventId}/checkins`).on('value', snap => {
        let data = snap.val();
        let html = `<h3 style="text-align:center; color:#1275d1; font-size:1.14em; font-weight:600;margin-top:0;">Danh s√°ch ƒëi·ªÉm danh</h3>`;
        html += `<table><tr><th>H·ªç t√™n</th><th>Check-in</th><th>Check-out</th></tr>`;
        if (data) {
          let arr = [];
          for (let user in data) {
            let u = data[user];
            arr.push(u);
          }
          // S·∫Øp x·∫øp theo th·ªùi gian check-in g·∫ßn nh·∫•t tr∆∞·ªõc
          arr.sort((a,b) => (b.checkin||0)-(a.checkin||0));
          for (let u of arr) {
            html += `<tr>
              <td>${u.name || ''}</td>
              <td>${u.checkin ? toTime(u.checkin) : ''}</td>
              <td>${u.checkout ? toTime(u.checkout) : ''}</td>
            </tr>`;
          }
        }
        html += `</table>`;
        document.getElementById('list').innerHTML = html;
      });
    }
    watchList();

    // === ƒê·ªãnh d·∫°ng gi·ªù ph√∫t gi√¢y ===
    function toTime(ts) {
      let d = new Date(ts*1000);
      return d.toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    // === Xu·∫•t PDF danh s√°ch ƒë√£ check-in, kh√¥ng l·ªói font ti·∫øng Vi·ªát ===
    async function exportPDF() {
      let snap = await db.ref(`events/${eventId}/checkins`).once('value');
      let data = snap.val();
      if (!data) {
        alert("Ch∆∞a c√≥ ai check-in!");
        return;
      }
      let rows = [];
      Object.values(data).forEach(u => {
        rows.push([
          u.name || "",
          u.checkin ? toTime(u.checkin) : "",
          u.checkout ? toTime(u.checkout) : ""
        ]);
      });
      // S·∫Øp x·∫øp theo th·ªùi gian check-in g·∫ßn nh·∫•t tr∆∞·ªõc
      rows.sort((a,b) => b[1].localeCompare(a[1]));

      const { jsPDF } = window.jspdf;
      let doc = new jsPDF();

      // Nh√∫ng font NotoSans Unicode
      doc.addFileToVFS('NotoSans-Regular.ttf', NotoSansRegular);
      doc.addFont('NotoSans-Regular.ttf', 'NotoSans', 'normal');
      doc.setFont('NotoSans');

      doc.setFontSize(16);
      doc.text("Danh s√°ch ƒëi·ªÉm danh - BV nh√¢n d√¢n Gia ƒê·ªãnh", 105, 18, {align:"center"});
      doc.setFontSize(11);
      doc.text("Ng√†y xu·∫•t: " + new Date().toLocaleString('vi-VN'), 105, 26, {align:"center"});
      doc.autoTable({
        head: [["H·ªç t√™n", "Check-in", "Check-out"]],
        body: rows,
        startY: 32,
        theme: 'grid',
        styles: {font: "NotoSans", fontSize: 12, cellWidth: "wrap"},
        headStyles: {fillColor: [41,128,185], textColor: 255, font: "NotoSans"},
        margin: {left: 10, right: 10}
      });
      doc.save("danh-sach-diem-danh.pdf");
    }

    // === H·ªó tr·ª£ nh·∫•n Enter ƒë·ªÉ check-in ===
    document.getElementById('form').addEventListener('keydown', function(e){
      if (e.key === "Enter") {
        e.preventDefault();
        checkin();
      }
    });
  </script>
</body>
</html>