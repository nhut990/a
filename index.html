<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kiểm tra Camera & Micro (Có sóng âm động)</title>
<style>
  body{
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:#f7f8fa;
    padding:18px;
    color:#111;
  }
  h1{font-size:1.2rem;margin:0 0 12px}
  select,button{
    padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:white;
  }
  button{cursor:pointer}
  video{width:100%;max-width:560px;border-radius:8px;background:#000;margin-top:10px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .note{font-size:0.85rem;color:#666;margin-top:6px}
  .panel{max-width:760px}
  canvas{width:100%;max-width:560px;height:120px;background:#111;border-radius:8px;margin-top:8px}
  .meter-bar{width:200px;height:20px;border-radius:6px;background:#eee;overflow:hidden;position:relative}
  .meter-bar>.fill{position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#4caf50,#ffeb3b)}
  audio{display:block;margin-top:10px}
</style>
</head>
<body>
<h1>Kiểm tra Camera & Micro (có sóng âm động)</h1>

<div class="panel">
  <div>
    <label>Camera:
      <select id="cameraSelect"></select>
    </label>
    <label>Micro:
      <select id="micSelect"></select>
    </label>
    <button id="startPreviewBtn">Bắt đầu Preview</button>
    <button id="stopPreviewBtn" disabled>Ngưng Preview</button>
  </div>

  <video id="videoPreview" autoplay playsinline muted></video>
  <canvas id="waveCanvas"></canvas>
  <div class="note">Nói vào micro để thấy sóng chuyển động theo âm thanh thực.</div>

  <div class="controls">
    <button id="startRecBtn">Bắt đầu Ghi âm</button>
    <button id="stopRecBtn" disabled>Ngưng Ghi</button>
    <button id="playRecBtn" disabled>Phát lại</button>
    <a id="downloadLink" download="recording.webm" style="padding:8px;border:1px solid #ccc;border-radius:6px;background:#fff;text-decoration:none;color:#111">Tải về</a>
  </div>

  <audio id="playback" controls></audio>
</div>

<script>
(async function(){
  const cameraSelect=document.getElementById('cameraSelect');
  const micSelect=document.getElementById('micSelect');
  const startPreviewBtn=document.getElementById('startPreviewBtn');
  const stopPreviewBtn=document.getElementById('stopPreviewBtn');
  const videoPreview=document.getElementById('videoPreview');
  const waveCanvas=document.getElementById('waveCanvas');
  const startRecBtn=document.getElementById('startRecBtn');
  const stopRecBtn=document.getElementById('stopRecBtn');
  const playRecBtn=document.getElementById('playRecBtn');
  const downloadLink=document.getElementById('downloadLink');
  const playback=document.getElementById('playback');

  let currentStream=null;
  let audioCtx=null;
  let analyser=null;
  let waveAnim=null;
  let mediaRecorder=null;
  let chunks=[];
  let waveSource=null;

  const ctx=waveCanvas.getContext('2d');
  function drawWave(){
    if(!analyser) return;
    const bufferLength=analyser.fftSize;
    const dataArray=new Uint8Array(bufferLength);
    function draw(){
      analyser.getByteTimeDomainData(dataArray);
      ctx.fillStyle="#111";
      ctx.fillRect(0,0,waveCanvas.width,waveCanvas.height);
      ctx.lineWidth=2;
      ctx.strokeStyle="#4caf50";
      ctx.beginPath();
      const sliceWidth=waveCanvas.width/bufferLength;
      let x=0;
      for(let i=0;i<bufferLength;i++){
        const v=dataArray[i]/128.0;
        const y=v*waveCanvas.height/2;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
        x+=sliceWidth;
      }
      ctx.lineTo(waveCanvas.width,waveCanvas.height/2);
      ctx.stroke();
      waveAnim=requestAnimationFrame(draw);
    }
    draw();
  }

  function stopWave(){
    if(waveAnim) cancelAnimationFrame(waveAnim);
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,waveCanvas.width,waveCanvas.height);
  }

  async function updateDevices(){
    const devices=await navigator.mediaDevices.enumerateDevices();
    const cams=devices.filter(d=>d.kind==='videoinput');
    const mics=devices.filter(d=>d.kind==='audioinput');
    cameraSelect.innerHTML=cams.map(c=>`<option value="${c.deviceId}">${c.label||'Camera '+(cams.indexOf(c)+1)}</option>`).join('');
    micSelect.innerHTML=mics.map(m=>`<option value="${m.deviceId}">${m.label||'Micro '+(mics.indexOf(m)+1)}</option>`).join('');
  }

  async function startPreview(){
    stopPreview();
    const constraints={
      video:{deviceId:cameraSelect.value?{exact:cameraSelect.value}:undefined},
      audio:{deviceId:micSelect.value?{exact:micSelect.value}:undefined}
    };
    try{
      currentStream=await navigator.mediaDevices.getUserMedia(constraints);
      videoPreview.srcObject=currentStream;
      videoPreview.muted=true;
      stopPreviewBtn.disabled=false;

      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      analyser=audioCtx.createAnalyser();
      analyser.fftSize=1024;
      waveSource=audioCtx.createMediaStreamSource(currentStream);
      waveSource.connect(analyser);
      drawWave();
      await updateDevices();
    }catch(e){
      alert("Không thể truy cập camera/mic: "+e.message);
    }
  }

  function stopPreview(){
    if(currentStream){currentStream.getTracks().forEach(t=>t.stop());currentStream=null;}
    if(audioCtx){audioCtx.close();audioCtx=null;}
    analyser=null;
    stopWave();
    stopPreviewBtn.disabled=true;
  }

  function startRecording(){
    if(!micSelect.value){alert("Chưa chọn micro!");return;}
    navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:micSelect.value}}})
      .then(stream=>{
        chunks=[];
        mediaRecorder=new MediaRecorder(stream);
        mediaRecorder.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);}
        mediaRecorder.onstop=()=>{
          const blob=new Blob(chunks,{type:'audio/webm'});
          const url=URL.createObjectURL(blob);
          playback.src=url;
          playRecBtn.disabled=false;
          downloadLink.href=url;
        };
        mediaRecorder.start();
        startRecBtn.disabled=true;
        stopRecBtn.disabled=false;

        // visual from recording stream
        audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        analyser=audioCtx.createAnalyser();
        analyser.fftSize=1024;
        waveSource=audioCtx.createMediaStreamSource(stream);
        waveSource.connect(analyser);
        drawWave();
      }).catch(err=>alert("Không thể ghi âm: "+err.message));
  }

  function stopRecording(){
    if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop();
    stopRecBtn.disabled=true;
    startRecBtn.disabled=false;
    if(audioCtx) audioCtx.close();
    stopWave();
  }

  startPreviewBtn.onclick=startPreview;
  stopPreviewBtn.onclick=stopPreview;
  startRecBtn.onclick=startRecording;
  stopRecBtn.onclick=stopRecording;
  playRecBtn.onclick=()=>playback.play();
  await updateDevices();
})();
</script>
</body>
</html>