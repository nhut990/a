<!DOCTYPE html>

<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·∫•y Th√¥ng Tin IPA</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .main-container {
            max-width: 700px;
            margin: 50px auto;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
        }
        .info-result {
            display: none;
            margin-top: 20px;
        }
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }
        .info-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .info-value {
            color: #333;
            word-break: break-all;
        }
        .spinner-border {
            display: none;
        }
        .progress-container {
            display: none;
            margin-top: 15px;
        }
        .copy-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            padding: 5px 10px;
            font-size: 12px;
        }
        .debug-toggle {
            margin-top: 10px;
            text-align: center;
        }
        .debug-info {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="card">
            <div class="card-header text-center">
                <h2 class="mb-0">üîç L·∫•y Th√¥ng Tin IPA</h2>
                <p class="mb-0 mt-2">Nh·∫≠p link IPA ƒë·ªÉ xem th√¥ng tin chi ti·∫øt</p>
            </div>
            <div class="card-body p-4">
                <form id="ipaForm">
                    <div class="form-group">
                        <label for="ipaLink"><strong>Link IPA:</strong></label>
                        <input type="text" class="form-control form-control-lg" id="ipaLink" 
                               placeholder="https://archive.org/download/example/app.ipa" required>
                        <small class="form-text text-muted">
                            üìå H·ªó tr·ª£: archive.org, github.com, dropbox.com, direct links
                        </small>
                    </div>

```
                <div class="row">
                    <div class="col-6">
                        <button type="submit" class="btn btn-primary btn-lg btn-block">
                            <span class="btn-text">L·∫•y Th√¥ng Tin</span>
                            <span class="spinner-border spinner-border-sm ml-2" role="status"></span>
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-success btn-lg btn-block" id="testProxyBtn">
                            üîß Test Proxy
                        </button>
                    </div>
                </div>

                <!-- Progress bar -->
                <div class="progress-container">
                    <div class="progress mt-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <small class="text-muted mt-2 d-block text-center" id="progressText">ƒêang t·∫£i...</small>
                </div>

                <!-- Debug toggle -->
                <div class="debug-toggle">
                    <small>
                        <a href="#" id="debugToggle">üêõ Hi·ªán debug info</a>
                    </small>
                </div>
                <div class="debug-info" id="debugInfo"></div>
            </form>

            <!-- K·∫øt qu·∫£ -->
            <div class="info-result" id="infoResult">
                <hr class="my-4">
                <h5 class="text-center mb-4">üì± Th√¥ng Tin ·ª®ng D·ª•ng</h5>
                
                <div class="info-item">
                    <div class="info-label">üìù T√™n App:</div>
                    <div class="info-value" id="appName">-</div>
                    <button class="btn btn-sm btn-outline-secondary copy-btn" data-copy="appName">Copy</button>
                </div>
                
                <div class="info-item">
                    <div class="info-label">üî¢ Phi√™n B·∫£n:</div>
                    <div class="info-value" id="appVersion">-</div>
                    <button class="btn btn-sm btn-outline-secondary copy-btn" data-copy="appVersion">Copy</button>
                </div>
                
                <div class="info-item">
                    <div class="info-label">üÜî Bundle ID:</div>
                    <div class="info-value" id="bundleId">-</div>
                    <button class="btn btn-sm btn-outline-secondary copy-btn" data-copy="bundleId">Copy</button>
                </div>

                <div class="info-item">
                    <div class="info-label">üèóÔ∏è Build Version:</div>
                    <div class="info-value" id="buildVersion">-</div>
                </div>

                <div class="info-item">
                    <div class="info-label">üì± Minimum iOS Version:</div>
                    <div class="info-value" id="minVersion">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick tips -->
    <div class="card mt-3">
        <div class="card-body">
            <h6>üí° M·∫πo s·ª≠ d·ª•ng:</h6>
            <ul class="mb-0 small">
                <li>Link ph·∫£i l√† <strong>direct download link</strong> (download tr·ª±c ti·∫øp)</li>
                <li>N·∫øu d√πng Dropbox: link s·∫Ω t·ª± ƒë·ªông chuy·ªÉn t·ª´ <code>dl=0</code> sang <code>dl=1</code></li>
                <li>Link t·ª´ <strong>archive.org</strong> v√† <strong>github.com</strong> ho·∫°t ƒë·ªông t·ªët nh·∫•t</li>
                <li>File IPA ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng v√† kh√¥ng b·ªã h·ªèng</li>
            </ul>
        </div>
    </div>
</div>

<!-- Modal th√¥ng b√°o -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Th√¥ng b√°o</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
    // Debug logger
    const debugLog = {
        logs: [],
        add(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            this.logs.push(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
            this.update();
        },
        update() {
            $('#debugInfo').html(this.logs.join('<br>'));
        },
        clear() {
            this.logs = [];
            this.update();
        }
    };

    // IPA Parser Class - Enhanced version
    class IPAParser {
        constructor(proxyUrl = './proxy.php') {
            this.proxyUrl = proxyUrl;
            debugLog.add(`Kh·ªüi t·∫°o parser v·ªõi proxy: ${proxyUrl}`);
        }

        async testProxy() {
            try {
                debugLog.add('ƒêang test proxy...');
                const response = await fetch(this.proxyUrl);
                const text = await response.text();
                debugLog.add(`Proxy response: ${text.substring(0, 100)}`, 'success');
                return response.ok;
            } catch (error) {
                debugLog.add(`L·ªói khi test proxy: ${error.message}`, 'error');
                return false;
            }
        }

        async parseIPA(url) {
            try {
                debugLog.clear();
                debugLog.add(`B·∫Øt ƒë·∫ßu parse IPA: ${url}`);
                
                // Chu·∫©n h√≥a URL
                url = this.normalizeURL(url);
                debugLog.add(`URL sau khi chu·∫©n h√≥a: ${url}`);
                
                // T·∫£i file IPA qua proxy
                const proxyFullUrl = `${this.proxyUrl}?url=${encodeURIComponent(url)}`;
                debugLog.add(`Proxy URL: ${proxyFullUrl}`);
                
                this.updateProgress(10, 'ƒêang k·∫øt n·ªëi t·ªõi server...');
                
                const response = await fetch(proxyFullUrl);
                debugLog.add(`Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    // Th·ª≠ ƒë·ªçc error message t·ª´ response
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP ${response.status}`);
                    } catch (e) {
                        const errorText = await response.text();
                        debugLog.add(`Error response: ${errorText.substring(0, 200)}`, 'error');
                        throw new Error(`HTTP ${response.status}: Kh√¥ng th·ªÉ t·∫£i file IPA. ${errorText.substring(0, 100)}`);
                    }
                }
                
                this.updateProgress(30, 'ƒêang t·∫£i file IPA...');
                
                const blob = await response.blob();
                debugLog.add(`File size: ${(blob.size / 1024 / 1024).toFixed(2)} MB`);
                
                if (blob.size < 1000) {
                    throw new Error('File qu√° nh·ªè, c√≥ th·ªÉ kh√¥ng ph·∫£i file IPA h·ª£p l·ªá');
                }
                
                this.updateProgress(60, 'ƒêang ph√¢n t√≠ch c·∫•u tr√∫c ZIP...');
                
                const arrayBuffer = await blob.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                // Ki·ªÉm tra ZIP signature
                if (uint8Array[0] !== 0x50 || uint8Array[1] !== 0x4B) {
                    throw new Error('File kh√¥ng ph·∫£i ƒë·ªãnh d·∫°ng ZIP/IPA h·ª£p l·ªá');
                }
                debugLog.add('ZIP signature h·ª£p l·ªá ‚úì');

                this.updateProgress(80, 'ƒêang tr√≠ch xu·∫•t Info.plist...');
                
                // Parse ZIP
                const info = await this.extractInfoPlist(uint8Array);
                debugLog.add('Tr√≠ch xu·∫•t th√¥ng tin th√†nh c√¥ng ‚úì', 'success');
                
                this.updateProgress(100, 'Ho√†n th√†nh!');
                
                return info;
            } catch (error) {
                debugLog.add(`L·ªñI: ${error.message}`, 'error');
                throw error;
            }
        }

        normalizeURL(url) {
            // X·ª≠ l√Ω Dropbox
            if (url.includes('dropbox.com')) {
                url = url.replace('?dl=0', '?dl=1');
                if (!url.includes('?dl=')) {
                    url += (url.includes('?') ? '&' : '?') + 'dl=1';
                }
                debugLog.add('ƒê√£ chuy·ªÉn ƒë·ªïi Dropbox link');
            }
            
            // X·ª≠ l√Ω Google Drive
            if (url.includes('drive.google.com')) {
                const match = url.match(/\/d\/([^/]+)/);
                if (match) {
                    url = `https://drive.google.com/uc?export=download&id=${match[1]}`;
                    debugLog.add('ƒê√£ chuy·ªÉn ƒë·ªïi Google Drive link');
                }
            }
            
            return url;
        }

        updateProgress(percent, text) {
            $('.progress-bar').css('width', percent + '%').text(percent + '%');
            $('#progressText').text(text);
            debugLog.add(`Progress: ${percent}% - ${text}`);
        }

        async extractInfoPlist(zipData) {
            const view = new DataView(zipData.buffer);
            let offset = 0;
            let filesFound = 0;
            
            debugLog.add('B·∫Øt ƒë·∫ßu qu√©t c·∫•u tr√∫c ZIP...');
            
            while (offset < zipData.length - 4) {
                // T√¨m ZIP local file header (0x504B0304)
                if (view.getUint32(offset, true) === 0x04034b50) {
                    filesFound++;
                    
                    const filenameLength = view.getUint16(offset + 26, true);
                    const extraLength = view.getUint16(offset + 28, true);
                    const compressedSize = view.getUint32(offset + 18, true);
                    const uncompressedSize = view.getUint32(offset + 22, true);
                    const compressionMethod = view.getUint16(offset + 8, true);
                    
                    const filenameOffset = offset + 30;
                    const filename = new TextDecoder().decode(
                        zipData.slice(filenameOffset, filenameOffset + filenameLength)
                    );
                    
                    // T√¨m Info.plist
                    if (filename.includes('Info.plist') && !filename.includes('__MACOSX')) {
                        debugLog.add(`T√¨m th·∫•y Info.plist: ${filename}`);
                        debugLog.add(`Compression: ${compressionMethod === 8 ? 'Deflate' : compressionMethod === 0 ? 'None' : 'Unknown'}`);
                        debugLog.add(`Size: ${compressedSize} -> ${uncompressedSize} bytes`);
                        
                        const dataOffset = filenameOffset + filenameLength + extraLength;
                        let plistData = zipData.slice(dataOffset, dataOffset + compressedSize);
                        
                        // Gi·∫£i n√©n n·∫øu c·∫ßn
                        if (compressionMethod === 8) {
                            try {
                                plistData = pako.inflate(plistData);
                                debugLog.add('ƒê√£ gi·∫£i n√©n Info.plist ‚úì');
                            } catch (e) {
                                debugLog.add(`L·ªói gi·∫£i n√©n: ${e.message}`, 'error');
                                throw new Error('L·ªói khi gi·∫£i n√©n Info.plist');
                            }
                        }
                        
                        return this.parsePlist(plistData);
                    }
                    
                    offset += 30 + filenameLength + extraLength + compressedSize;
                } else {
                    offset++;
                }
            }
            
            debugLog.add(`ƒê√£ qu√©t ${filesFound} files trong ZIP`, 'warning');
            throw new Error(`Kh√¥ng t√¨m th·∫•y Info.plist trong file IPA (qu√©t ${filesFound} files)`);
        }

        parsePlist(data) {
            const text = new TextDecoder().decode(data);
            debugLog.add(`Plist size: ${text.length} characters`);
            
            const getValue = (key) => {
                const regex = new RegExp(`<key>${key}</key>\\s*<string>([^<]+)</string>`);
                const match = text.match(regex);
                if (match) {
                    debugLog.add(`Found ${key}: ${match[1]}`);
                }
                return match ? match[1] : 'N/A';
            };

            const info = {
                appName: getValue('CFBundleDisplayName') || getValue('CFBundleName'),
                version: getValue('CFBundleShortVersionString'),
                bundleId: getValue('CFBundleIdentifier'),
                buildVersion: getValue('CFBundleVersion'),
                minVersion: getValue('MinimumOSVersion')
            };

            debugLog.add('Parse plist th√†nh c√¥ng ‚úì', 'success');
            return info;
        }
    }

    // Main app logic
    $(document).ready(function() {
        const parser = new IPAParser();

        // Debug toggle
        $('#debugToggle').on('click', function(e) {
            e.preventDefault();
            $('#debugInfo').slideToggle();
            $(this).text($(this).text().includes('Hi·ªán') ? 'üêõ ·∫®n debug info' : 'üêõ Hi·ªán debug info');
        });

        // Test proxy button
        $('#testProxyBtn').on('click', async function() {
            debugLog.clear();
            const $btn = $(this);
            $btn.prop('disabled', true).html('‚è≥ Testing...');
            
            const isWorking = await parser.testProxy();
            
            if (isWorking) {
                showModal('‚úÖ Proxy ho·∫°t ƒë·ªông t·ªët', 'Proxy ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng. B·∫°n c√≥ th·ªÉ nh·∫≠p link IPA.', 'success');
            } else {
                showModal('‚ùå L·ªói Proxy', 'Proxy kh√¥ng ho·∫°t ƒë·ªông. Vui l√≤ng ki·ªÉm tra file proxy.php v√† c·∫•u h√¨nh server.', 'danger');
            }
            
            $btn.prop('disabled', false).html('üîß Test Proxy');
            $('#debugInfo').show();
        });

        // Copy buttons
        $(document).on('click', '.copy-btn', function() {
            const target = $(this).data('copy');
            const text = $(`#${target}`).text();
            
            // Copy to clipboard
            const $temp = $('<input>');
            $('body').append($temp);
            $temp.val(text).select();
            document.execCommand('copy');
            $temp.remove();
            
            // Visual feedback
            $(this).text('‚úì Copied!').removeClass('btn-outline-secondary').addClass('btn-success');
            setTimeout(() => {
                $(this).text('Copy').removeClass('btn-success').addClass('btn-outline-secondary');
            }, 2000);
        });

        // Form submit
        $('#ipaForm').on('submit', async function(e) {
            e.preventDefault();
            
            const url = $('#ipaLink').val().trim();
            const $btn = $(this).find('button[type="submit"]');
            const $spinner = $btn.find('.spinner-border');
            const $btnText = $btn.find('.btn-text');
            
            if (!url) {
                showModal('‚ö†Ô∏è C·∫£nh b√°o', 'Vui l√≤ng nh·∫≠p link IPA', 'warning');
                return;
            }
            
            // Validate URL format
            if (!url.match(/^https?:\/\//i)) {
                showModal('‚ö†Ô∏è URL kh√¥ng h·ª£p l·ªá', 'URL ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://', 'warning');
                return;
            }
            
            // Hi·ªÉn th·ªã loading
            $btn.prop('disabled', true);
            $spinner.show();
            $btnText.text('ƒêang x·ª≠ l√Ω...');
            $('#infoResult').hide();
            $('.progress-container').show();
            $('.progress-bar').css('width', '0%').text('0%');

            try {
                const info = await parser.parseIPA(url);
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                $('#appName').text(info.appName);
                $('#appVersion').text(info.version);
                $('#bundleId').text(info.bundleId);
                $('#buildVersion').text(info.buildVersion);
                $('#minVersion').text(info.minVersion);
                
                $('#infoResult').fadeIn();
                
                // Th√¥ng b√°o th√†nh c√¥ng
                setTimeout(() => {
                    showModal('‚úÖ Th√†nh c√¥ng', 
                        `<div class="text-center">
                            <h5>${info.appName}</h5>
                            <p class="mb-0">Version: <strong>${info.version}</strong></p>
                            <p class="mb-0"><code>${info.bundleId}</code></p>
                        </div>`, 
                        'success');
                }, 500);
                
            } catch (error) {
                console.error(error);
                
                let errorMsg = `<p><strong>L·ªói:</strong> ${error.message}</p>`;
                let suggestions = `
                    <hr>
                    <h6>üí° C√°c b∆∞·ªõc kh·∫Øc ph·ª•c:</h6>
                    <ol class="text-left small mb-0">
                        <li>Ki·ªÉm tra link IPA c√≥ m·ªü ƒë∆∞·ª£c trong tr√¨nh duy·ªát kh√¥ng</li>
                        <li>ƒê·∫£m b·∫£o link l√† <strong>direct download link</strong></li>
                        <li>Th·ª≠ v·ªõi link t·ª´ archive.org ho·∫∑c github.com</li>
                        <li>Ki·ªÉm tra file proxy.php ƒë√£ upload ƒë√∫ng ch∆∞a</li>
                        <li>Nh·∫•n n√∫t "Test Proxy" ƒë·ªÉ ki·ªÉm tra</li>
                    </ol>
                `;
                
                showModal('‚ùå L·ªói', errorMsg + suggestions, 'danger');
                $('#debugInfo').show();
                
            } finally {
                $btn.prop('disabled', false);
                $spinner.hide();
                $btnText.text('L·∫•y Th√¥ng Tin');
                setTimeout(() => $('.progress-container').fadeOut(), 1000);
            }
        });

        function showModal(title, message, type) {
            $('#modalTitle').html(title);
            $('#modalBody').html(`<div class="alert alert-${type} mb-0">${message}</div>`);
            $('#messageModal').modal('show');
        }
    });
</script>
```

</body>
</html>