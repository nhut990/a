<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê√†n Piano - Style ƒê·ªám</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh;
            padding: 5px; touch-action: manipulation; overflow-x: hidden; }
        .sound-toggle { background: linear-gradient(145deg, #4CAF50, #45a049); color: white; border: none; border-radius: 50%;
            width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; touch-action: manipulation; }
        .sound-toggle:active { transform: scale(0.95); }
        .sound-toggle.muted { background: linear-gradient(145deg, #f44336, #d32f2f); }
        .container { width: 100%; max-width: 100vw; }
        .title { text-align: center; color: #FFD700; margin-bottom: 8px; font-size: 18px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-weight: bold; }
        .created-by { text-align: center; color: #fff; font-size: 13px; margin-top: 0px; margin-bottom: 8px; opacity: 0.85; font-weight: 400; }
        .chords-section { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 10px; padding: 6px; margin-bottom: 4px; max-width: 290px; margin-left: 8px; margin-right: auto; }
        .style-selector { margin-bottom: 8px; }
        .style-select { width: 100%; padding: 6px; border-radius: 6px; border: none; font-size: 13px; font-weight: bold; color: #fff; background: linear-gradient(145deg, #2196F3, #2962FF); box-shadow: 0 2px 4px rgba(0,0,0,0.3);}
        .tone-selector { display: flex; gap: 5px; margin-bottom: 8px; overflow-x: auto; justify-content: flex-start; padding: 0 4px; }
        .tone-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 5px 8px; font-size: 11px; font-weight: bold; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .tone-btn.active { background: linear-gradient(145deg, #FF9800, #F57C00); border-color: #FF9800; }
        .tone-btn:active { transform: scale(0.95); }
        .chords-title { color: white; font-size: 12px; margin-bottom: 4px; text-align: center; }
        .chords-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 4px; }
        .chord-btn { background: linear-gradient(145deg, #4CAF50, #45a049); color: white; border: 2px solid rgba(255,255,255,0.4); border-radius: 5px; padding: 6px 2px; font-size: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: all 0.1s; touch-action: manipulation;}
        .chord-btn:active { transform: scale(0.95); box-shadow: 0 2px 3px rgba(0,0,0,0.3); background: linear-gradient(145deg, #66BB6A, #5CB860); }
        .piano-container { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-radius: 10px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow-x: auto; overflow-y: hidden; width: 100%; max-width: 800px; }
        .piano { position: relative; height: 140px; width: 1050px; margin: 0 auto; }
        .white-key { position: absolute; width: 35px; height: 140px; background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%); border: 2px solid #222; border-radius: 0 0 4px 4px; cursor: pointer; user-select: none; touch-action: manipulation; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 4px; font-size: 8px; color: #666; font-weight: bold; transition: all 0.05s; }
        .white-key.active { background: linear-gradient(145deg, #b3e5fc 0%, #4fc3f7 100%); color: #0277bd; }
        .white-key.chord-active { background: linear-gradient(to bottom, #FFE680 0%, #FFD966 100%); box-shadow: inset 0 1px 3px rgba(255, 200, 0, 0.4);}
        .black-key { position: absolute; width: 24px; height: 85px; background: linear-gradient(to bottom, #444 0%, #000 100%); border: 1px solid #000; border-radius: 0 0 3px 3px; cursor: pointer; user-select: none; touch-action: manipulation; z-index: 10; color: white; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 3px; font-size: 7px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.5); transition: all 0.05s; }
        .black-key.active { background: linear-gradient(145deg, #b3e5fc 0%, #4fc3f7 100%); color: #0277bd; }
        .black-key.chord-active {background: linear-gradient(to bottom, #FFE680 0%, #FFD966 100%); box-shadow: inset 0 1px 3px rgba(255, 200, 0, 0.4); color: #444;}
        .info { text-align: center; color: white; margin-top: 8px; font-size: 11px; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 8px; position: relative;">
            <h1 class="title" style="margin: 0;">üéπ ƒê√†n Piano</h1>
            <div style="position: absolute; right: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                <button class="sound-toggle muted" id="soundToggle">
                    <span id="soundIcon">üîá</span>
                </button>
                <span style="color: white; font-size: 10px; font-weight: bold;" id="soundStatus">T·∫Øt √¢m</span>
            </div>
        </div>
        <div class="created-by">Created by Minh Nh·ª±t</div>
        <div class="chords-section">
            <div class="style-selector">
                <select class="style-select" id="styleSelect">
                    <option value="piano">Piano (Arp)</option>
                    <option value="ballad">Ballad</option>
                    <option value="rock">Rock</option>
                    <option value="rumba">Rumba</option>
                    <option value="chacha">Cha-cha</option>
                    <option value="pop">Pop</option>
                </select>
            </div>
            <div class="tone-selector" id="toneSelector"></div>
            <div class="chords-title" id="currentTone">H·ª£p √Çm - Tone Dm</div>
            <div class="chords-grid" id="chordsGrid"></div>
        </div>
        <div class="piano-container">
            <div class="piano" id="piano"></div>
        </div>
        <div class="info">
            B·∫•m h·ª£p √¢m ph√≠a tr√™n ƒë·ªÉ nghe ƒë·ªám t·ª± ƒë·ªông<br>B·∫•m ph√≠m ƒë√†n ƒë·ªÉ ch∆°i giai ƒëi·ªáu
        </div>
    </div>
    <script>
        let audioContext = null;
        let isMuted = true;
        let currentTone = 'Dm';
        let autoStyle = 'piano'; // style ƒë·ªám
        let playChordInterval = null;
        let lastPlayingChord = null;
        let lastPlayingPattern = [];
        let stopAutoPlay = false;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        window.addEventListener('load', () => {
            initAudioContext();
        });

        const soundToggle = document.getElementById('soundToggle');
        const soundIcon = document.getElementById('soundIcon');
        const soundStatus = document.getElementById('soundStatus');
        soundToggle.addEventListener('click', () => {
            initAudioContext();
            isMuted = !isMuted;
            soundToggle.classList.toggle('muted', isMuted);
            soundIcon.textContent = isMuted ? 'üîá' : 'üîä';
            soundStatus.textContent = isMuted ? 'T·∫Øt √¢m' : 'B·∫≠t √¢m';
        });

        // NOTE MAP
        const notes = {
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56,
            'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00,
            'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
            'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
            'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 
            'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99,
            'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50
        };

        // H·ª¢P √ÇM
        const chords = {
            'C': ['C3', 'E3', 'G3'],
            'C#': ['C#3', 'F3', 'G#3'],
            'Cm': ['C3', 'D#3', 'G3'],
            'C#m': ['C#3', 'E3', 'G#3'],
            'C7': ['C3', 'E3', 'G3', 'A#3'],
            'C#7': ['C#3', 'F3', 'G#3', 'B3'],
            'D': ['D3', 'F#3', 'A3'],
            'D#': ['D#3', 'G3', 'A#3'],
            'Dm': ['D3', 'F3', 'A3'],
            'D#m': ['D#3', 'F#3', 'A#3'],
            'D7': ['D3', 'F#3', 'A3', 'C4'],
            'E': ['E3', 'G#3', 'B3'],
            'Eb': ['D#3', 'G3', 'A#3'],
            'Em': ['E3', 'G3', 'B3'],
            'Em7': ['E3', 'G3', 'B3', 'D4'],
            'E7': ['E3', 'G#3', 'B3', 'D4'],
            'F': ['F3', 'A3', 'C4'],
            'F#': ['F#3', 'A#3', 'C#4'],
            'Fm': ['F3', 'G#3', 'C4'],
            'F#m': ['F#3', 'A3', 'C#4'],
            'F#7': ['F#3', 'A#3', 'C#4', 'E4'],
            'G': ['G3', 'B3', 'D4'],
            'G#': ['G#3', 'C4', 'D#4'],
            'Gm': ['G3', 'A#3', 'D4'],
            'G#m': ['G#3', 'B3', 'D#4'],
            'G7': ['G3', 'B3', 'D4', 'F4'],
            'A': ['A3', 'C#4', 'E4'],
            'A#': ['A#3', 'D4', 'F4'],
            'Am': ['A3', 'C4', 'E4'],
            'A7': ['A3', 'C#4', 'E4', 'G3'],
            'Am7': ['A3', 'C4', 'E4', 'G4'],
            'B': ['B3', 'D#4', 'F#4'],
            'Bm': ['B3', 'D4', 'F#4'],
            'Bb': ['A#3', 'D4', 'F3'],
            'D#m7': ['D#3', 'F#3', 'A#3', 'C#4'],
            'Dm7': ['D3', 'F3', 'A3', 'C4'],
            'F#m7': ['F#3', 'A3', 'C#4', 'E4'],
            'G#m': ['G#3', 'B3', 'D#4'],
            'Db': ['C#3', 'F3', 'G#3'],
        };

        // Tone v√† c√°c h·ª£p √¢m cho m·ªói tone
        const toneChords = {
            'Dm': ['Dm', 'Gm', 'Bb', 'C', 'F', 'G', 'A7', 'Am', 'E'],
            'Bm': ['Bm', 'Em', 'D#', 'F#', 'B', 'C#', 'F#7', 'F#m', 'G#'],
            'Am': ['Am', 'Dm', 'G', 'Bb', 'Eb', 'A', 'D7', 'Em', 'B'],
            'D#m': ['D#m', 'G#m', 'B', 'C#', 'F#', 'G#', 'C#7', 'C#m', 'F#7'],
            'Gm': ['Gm', 'Cm', 'Bb', 'Db', 'F', 'G', 'D7', 'D', 'A'],
        };

        // STYLE PATTERNS
        const stylePatterns = {
            piano: (chordNotes) => {
                return [
                    [0], [1], [2], [1], [0], [1], [2], [1]
                ].map(indices => indices.map(i => chordNotes[i % chordNotes.length]));
            },
            ballad: (chordNotes) => {
                return [
                    [0], [1,2], [0], [1,2]
                ].map(indices => indices.map(i => chordNotes[i % chordNotes.length]));
            },
            rock: (chordNotes) => {
                return [
                    [0], [0,1,2], [1], [0,1,2]
                ].map(indices => indices.map(i => chordNotes[i % chordNotes.length]));
            },
            rumba: (chordNotes) => {
                return [
                    [0], [1,2], [0], [1,2]
                ].map(indices => indices.map(i => chordNotes[i % chordNotes.length]));
            },
            chacha: (chordNotes) => {
                return [
                    [0], [0], [1], [2], [1], [0], [2], [1]
                ].map(indices => indices.map(i => chordNotes[i % chordNotes.length]));
            },
            pop: (chordNotes) => {
                return [
                    [0,1,2], [0,1,2], [0,1,2], [0,1,2]
                ];
            }
        };

        // Piano key data
        const piano = document.getElementById('piano');
        const whiteKeysData = [
            {note: 'C3', left: 0}, {note: 'D3', left: 35}, {note: 'E3', left: 70},
            {note: 'F3', left: 105}, {note: 'G3', left: 140}, {note: 'A3', left: 175},
            {note: 'B3', left: 210}, {note: 'C4', left: 245}, {note: 'D4', left: 280},
            {note: 'E4', left: 315}, {note: 'F4', left: 350}, {note: 'G4', left: 385},
            {note: 'A4', left: 420}, {note: 'B4', left: 455}, {note: 'C5', left: 490},
            {note: 'D5', left: 525}, {note: 'E5', left: 560}, {note: 'F5', left: 595},
            {note: 'G5', left: 630}, {note: 'A5', left: 665}, {note: 'B5', left: 700},
            {note: 'C6', left: 735}
        ];
        const blackKeysData = [
            {note: 'C#3', left: 24}, {note: 'D#3', left: 59},
            {note: 'F#3', left: 129}, {note: 'G#3', left: 164}, {note: 'A#3', left: 199},
            {note: 'C#4', left: 269}, {note: 'D#4', left: 304},
            {note: 'F#4', left: 374}, {note: 'G#4', left: 409}, {note: 'A#4', left: 444},
            {note: 'C#5', left: 514}, {note: 'D#5', left: 549},
            {note: 'F#5', left: 619}, {note: 'G#5', left: 654}, {note: 'A#5', left: 689}
        ];

        function createKey(isBlack, data) {
            const key = document.createElement('div');
            key.className = isBlack ? 'black-key' : 'white-key';
            key.dataset.note = data.note;
            key.textContent = data.note;
            key.style.left = data.left + 'px';

            const playKeyNote = () => playNote(data.note, key);

            key.addEventListener('mousedown', () => {
                key.classList.add('active');
                playKeyNote();
            });
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                key.classList.add('active');
                playKeyNote();
            });
            key.addEventListener('mouseup', () => {
                key.classList.remove('active');
            });
            key.addEventListener('mouseleave', () => {
                key.classList.remove('active');
            });
            key.addEventListener('touchend', () => {
                key.classList.remove('active');
            });

            return key;
        }
        whiteKeysData.forEach(data => {
            piano.appendChild(createKey(false, data));
        });
        blackKeysData.forEach(data => {
            piano.appendChild(createKey(true, data));
        });

        function playNote(note, keyElement, isChord = false, duration = null) {
            if (!audioContext || !notes[note] || isMuted) return;
            initAudioContext();
            if (keyElement) {
                const activeClass = isChord ? 'chord-active' : 'active';
                keyElement.classList.add(activeClass);
                setTimeout(() => {
                    keyElement.classList.remove(activeClass);
                }, duration || 350);
            }
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = notes[note];
            osc.type = 'sine'; // ch·ªâ ti·∫øng piano
            const now = audioContext.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.4, now + 0.01);
            gain.gain.linearRampToValueAtTime(0.05, now + ((duration||0.35)/1000));
            osc.start(now);
            osc.stop(now + ((duration||350)/1000));
        }

        // --- AUTO PLAY CHORD (style) ---
        function playChordPattern(chordName, style = 'piano') {
            stopAutoPlayChord();
            if (!chords[chordName]) return;
            lastPlayingChord = chordName;
            let pattern = stylePatterns[style] ? stylePatterns[style](chords[chordName]) : stylePatterns.piano(chords[chordName]);
            let idx = 0;
            function step() {
                if (stopAutoPlay) return;
                if (lastPlayingChord !== chordName) return;
                showChordOnKeys(chordName);
                let notesArr = pattern[idx];
                if (notesArr) {
                    notesArr.forEach(note => {
                        const keyElement = document.querySelector(`[data-note="${note}"]`);
                        playNote(note, keyElement, true, 300);
                    });
                }
                idx = (idx+1) % pattern.length;
                playChordInterval = setTimeout(step, 340);
            }
            step();
        }
        function stopAutoPlayChord() {
            stopAutoPlay = true;
            clearTimeout(playChordInterval);
            setTimeout(()=>{ stopAutoPlay = false; }, 50);
        }
        function handleChordPress(chordName) {
            stopAutoPlayChord();
            setTimeout(() => playChordPattern(chordName, autoStyle), 100);
        }
        function showChordOnKeys(chordName) {
            document.querySelectorAll('.white-key,.black-key').forEach(key => {
                key.classList.remove('chord-active');
            });
            const chordNotes = chords[chordName];
            if (!chordNotes) return;
            chordNotes.forEach(note => {
                const keyElement = document.querySelector(`[data-note="${note}"]`);
                if (keyElement) keyElement.classList.add('chord-active');
            });
        }
        function renderToneSelector() {
            const selector = document.getElementById('toneSelector');
            selector.innerHTML = '';
            Object.keys(toneChords).forEach(tone => {
                const btn = document.createElement('button');
                btn.className = 'tone-btn';
                btn.dataset.tone = tone;
                btn.textContent = tone;
                if (tone === currentTone) btn.classList.add('active');
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tone-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTone = tone;
                    renderChords(tone);
                });
                selector.appendChild(btn);
            });
        }
        function renderChords(tone) {
            const grid = document.getElementById('chordsGrid');
            const title = document.getElementById('currentTone');
            grid.innerHTML = '';
            title.textContent = `H·ª£p √Çm - Tone ${tone}`;
            if (toneChords[tone]) {
                toneChords[tone].forEach(chordName => {
                    const btn = document.createElement('button');
                    btn.className = 'chord-btn';
                    btn.dataset.chord = chordName;
                    btn.textContent = chordName;
                    btn.addEventListener('click', () => handleChordPress(chordName));
                    btn.addEventListener('touchstart', (e) => { e.preventDefault(); handleChordPress(chordName); });
                    grid.appendChild(btn);
                });
            }
        }
        document.getElementById('styleSelect').addEventListener('change', function() {
            autoStyle = this.value;
            if (lastPlayingChord) handleChordPress(lastPlayingChord);
        });
        renderToneSelector();
        renderChords(currentTone);
        showChordOnKeys(toneChords[currentTone][0]);
    </script>
</body>
</html>