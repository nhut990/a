import React, { useState, useEffect } from â€˜reactâ€™;
import { X, Users, Copy, Check, Play, RotateCcw } from â€˜lucide-reactâ€™;

const FIREBASE_URL = â€˜https://nhutvan5c-79ce9-default-rtdb.asia-southeast1.firebasedatabase.appâ€™;

const PIECES = {
RED: { K: â€˜å¸¥â€™, A: â€˜ä»•â€™, E: â€˜ç›¸â€™, H: â€˜å‚Œâ€™, R: â€˜ä¿¥â€™, C: â€˜ç‚®â€™, P: â€˜å…µâ€™ },
BLACK: { K: â€˜å°‡â€™, A: â€˜å£«â€™, E: â€˜è±¡â€™, H: â€˜é¦¬â€™, R: â€˜è»Šâ€™, C: â€˜ç ²â€™, P: â€˜å’â€™ }
};

const initBoard = () => {
const board = Array(10).fill(null).map(() => Array(9).fill(null));

board[9][4] = { type: â€˜Kâ€™, color: â€˜REDâ€™ };
board[9][3] = { type: â€˜Aâ€™, color: â€˜REDâ€™ };
board[9][5] = { type: â€˜Aâ€™, color: â€˜REDâ€™ };
board[9][2] = { type: â€˜Eâ€™, color: â€˜REDâ€™ };
board[9][6] = { type: â€˜Eâ€™, color: â€˜REDâ€™ };
board[9][1] = { type: â€˜Hâ€™, color: â€˜REDâ€™ };
board[9][7] = { type: â€˜Hâ€™, color: â€˜REDâ€™ };
board[9][0] = { type: â€˜Râ€™, color: â€˜REDâ€™ };
board[9][8] = { type: â€˜Râ€™, color: â€˜REDâ€™ };
board[7][1] = { type: â€˜Câ€™, color: â€˜REDâ€™ };
board[7][7] = { type: â€˜Câ€™, color: â€˜REDâ€™ };
for (let i = 0; i < 9; i += 2) board[6][i] = { type: â€˜Pâ€™, color: â€˜REDâ€™ };

board[0][4] = { type: â€˜Kâ€™, color: â€˜BLACKâ€™ };
board[0][3] = { type: â€˜Aâ€™, color: â€˜BLACKâ€™ };
board[0][5] = { type: â€˜Aâ€™, color: â€˜BLACKâ€™ };
board[0][2] = { type: â€˜Eâ€™, color: â€˜BLACKâ€™ };
board[0][6] = { type: â€˜Eâ€™, color: â€˜BLACKâ€™ };
board[0][1] = { type: â€˜Hâ€™, color: â€˜BLACKâ€™ };
board[0][7] = { type: â€˜Hâ€™, color: â€˜BLACKâ€™ };
board[0][0] = { type: â€˜Râ€™, color: â€˜BLACKâ€™ };
board[0][8] = { type: â€˜Râ€™, color: â€˜BLACKâ€™ };
board[2][1] = { type: â€˜Câ€™, color: â€˜BLACKâ€™ };
board[2][7] = { type: â€˜Câ€™, color: â€˜BLACKâ€™ };
for (let i = 0; i < 9; i += 2) board[3][i] = { type: â€˜Pâ€™, color: â€˜BLACKâ€™ };

return board;
};

export default function XiangqiOnline() {
const [screen, setScreen] = useState(â€˜menuâ€™);
const [roomId, setRoomId] = useState(â€™â€™);
const [playerId, setPlayerId] = useState(â€™â€™);
const [playerColor, setPlayerColor] = useState(null);
const [gameState, setGameState] = useState(null);
const [selectedPiece, setSelectedPiece] = useState(null);
const [copied, setCopied] = useState(false);

const createRoom = async () => {
const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
const newPlayerId = Math.random().toString(36).substring(2, 15);

```
const initialState = {
  board: initBoard(),
  currentTurn: 'RED',
  players: { RED: newPlayerId, BLACK: null },
  status: 'waiting',
  winner: null
};

try {
  const response = await fetch(`${FIREBASE_URL}/rooms/${newRoomId}.json`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(initialState)
  });

  if (response.ok) {
    setRoomId(newRoomId);
    setPlayerId(newPlayerId);
    setPlayerColor('RED');
    setScreen('game');
  }
} catch (error) {
  alert('Lá»—i táº¡o phÃ²ng: ' + error.message);
}
```

};

const joinRoom = async () => {
if (!roomId.trim()) return;

```
const newPlayerId = Math.random().toString(36).substring(2, 15);

try {
  const response = await fetch(`${FIREBASE_URL}/rooms/${roomId.toUpperCase()}.json`);
  const data = await response.json();

  if (!data) {
    alert('PhÃ²ng khÃ´ng tá»“n táº¡i!');
    return;
  }

  if (data.players.BLACK) {
    alert('PhÃ²ng Ä‘Ã£ Ä‘áº§y!');
    return;
  }

  await fetch(`${FIREBASE_URL}/rooms/${roomId.toUpperCase()}/players/BLACK.json`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(newPlayerId)
  });

  await fetch(`${FIREBASE_URL}/rooms/${roomId.toUpperCase()}/status.json`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify('playing')
  });

  setPlayerId(newPlayerId);
  setPlayerColor('BLACK');
  setScreen('game');
} catch (error) {
  alert('Lá»—i tham gia phÃ²ng: ' + error.message);
}
```

};

useEffect(() => {
if (screen !== â€˜gameâ€™ || !roomId) return;

```
const interval = setInterval(async () => {
  try {
    const response = await fetch(`${FIREBASE_URL}/rooms/${roomId}.json`);
    const data = await response.json();
    if (data) setGameState(data);
  } catch (error) {
    console.error('Error:', error);
  }
}, 1000);

return () => clearInterval(interval);
```

}, [screen, roomId]);

const isValidMove = (fromRow, fromCol, toRow, toCol, piece, board) => {
if (toRow < 0 || toRow > 9 || toCol < 0 || toCol > 8) return false;
const target = board[toRow][toCol];
if (target && target.color === piece.color) return false;

```
const rowDiff = Math.abs(toRow - fromRow);
const colDiff = Math.abs(toCol - fromCol);

switch (piece.type) {
  case 'K':
    if (rowDiff + colDiff !== 1) return false;
    if (piece.color === 'RED') {
      return toRow >= 7 && toCol >= 3 && toCol <= 5;
    }
    return toRow <= 2 && toCol >= 3 && toCol <= 5;

  case 'A':
    if (rowDiff !== 1 || colDiff !== 1) return false;
    if (piece.color === 'RED') {
      return toRow >= 7 && toCol >= 3 && toCol <= 5;
    }
    return toRow <= 2 && toCol >= 3 && toCol <= 5;

  case 'E':
    if (rowDiff !== 2 || colDiff !== 2) return false;
    const midRow = (fromRow + toRow) / 2;
    const midCol = (fromCol + toCol) / 2;
    if (board[midRow][midCol]) return false;
    return piece.color === 'RED' ? toRow >= 5 : toRow <= 4;

  case 'H':
    if (!((rowDiff === 2 && colDiff === 1) || (rowDiff === 1 && colDiff === 2))) return false;
    const blockRow = rowDiff === 2 ? fromRow + (toRow > fromRow ? 1 : -1) : fromRow;
    const blockCol = colDiff === 2 ? fromCol + (toCol > fromCol ? 1 : -1) : fromCol;
    return !board[blockRow][blockCol];

  case 'R':
    if (rowDiff !== 0 && colDiff !== 0) return false;
    if (rowDiff > 0) {
      for (let r = Math.min(fromRow, toRow) + 1; r < Math.max(fromRow, toRow); r++) {
        if (board[r][fromCol]) return false;
      }
    } else {
      for (let c = Math.min(fromCol, toCol) + 1; c < Math.max(fromCol, toCol); c++) {
        if (board[fromRow][c]) return false;
      }
    }
    return true;

  case 'C':
    if (rowDiff !== 0 && colDiff !== 0) return false;
    let count = 0;
    if (rowDiff > 0) {
      for (let r = Math.min(fromRow, toRow) + 1; r < Math.max(fromRow, toRow); r++) {
        if (board[r][fromCol]) count++;
      }
    } else {
      for (let c = Math.min(fromCol, toCol) + 1; c < Math.max(fromCol, toCol); c++) {
        if (board[fromRow][c]) count++;
      }
    }
    return target ? count === 1 : count === 0;

  case 'P':
    if (piece.color === 'RED') {
      if (fromRow > 4) {
        return toRow === fromRow - 1 && toCol === fromCol;
      }
      return (toRow === fromRow - 1 && toCol === fromCol) || 
             (toRow === fromRow && Math.abs(toCol - fromCol) === 1);
    } else {
      if (fromRow < 5) {
        return toRow === fromRow + 1 && toCol === fromCol;
      }
      return (toRow === fromRow + 1 && toCol === fromCol) || 
             (toRow === fromRow && Math.abs(toCol - fromCol) === 1);
    }

  default:
    return false;
}
```

};

const handleSquareClick = async (row, col) => {
if (!gameState || gameState.status !== â€˜playingâ€™ || gameState.currentTurn !== playerColor) return;

```
const piece = gameState.board[row][col];

if (selectedPiece) {
  const [fromRow, fromCol] = selectedPiece;
  const movingPiece = gameState.board[fromRow][fromCol];

  if (fromRow === row && fromCol === col) {
    setSelectedPiece(null);
    return;
  }

  if (isValidMove(fromRow, fromCol, row, col, movingPiece, gameState.board)) {
    const newBoard = gameState.board.map(r => [...r]);
    const capturedPiece = newBoard[row][col];
    newBoard[row][col] = newBoard[fromRow][fromCol];
    newBoard[fromRow][fromCol] = null;

    const nextTurn = playerColor === 'RED' ? 'BLACK' : 'RED';
    const winner = capturedPiece && capturedPiece.type === 'K' ? playerColor : null;

    try {
      await fetch(`${FIREBASE_URL}/rooms/${roomId}.json`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          board: newBoard,
          currentTurn: winner ? playerColor : nextTurn,
          status: winner ? 'finished' : 'playing',
          winner: winner
        })
      });
      setSelectedPiece(null);
    } catch (error) {
      alert('Lá»—i di chuyá»ƒn: ' + error.message);
    }
  } else if (piece && piece.color === playerColor) {
    setSelectedPiece([row, col]);
  } else {
    setSelectedPiece(null);
  }
} else if (piece && piece.color === playerColor) {
  setSelectedPiece([row, col]);
}
```

};

const copyRoomId = () => {
navigator.clipboard.writeText(roomId);
setCopied(true);
setTimeout(() => setCopied(false), 2000);
};

const resetGame = async () => {
try {
await fetch(`${FIREBASE_URL}/rooms/${roomId}.json`, {
method: â€˜PATCHâ€™,
headers: { â€˜Content-Typeâ€™: â€˜application/jsonâ€™ },
body: JSON.stringify({
board: initBoard(),
currentTurn: â€˜REDâ€™,
status: â€˜playingâ€™,
winner: null
})
});
} catch (error) {
alert(â€™Lá»—i reset: â€™ + error.message);
}
};

if (screen === â€˜menuâ€™) {
return (
<div className="min-h-screen bg-gradient-to-br from-red-900 via-red-800 to-amber-900 flex items-center justify-center p-4">
<div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
<h1 className="text-4xl font-bold text-center mb-2 text-red-800">Cá» TÆ°á»›ng Online</h1>
<p className="text-center text-gray-600 mb-8">Xiangqi - Chinese Chess</p>

```
      <div className="space-y-4">
        <button onClick={createRoom} className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-4 px-6 rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg">
          <Play size={20} />
          Táº¡o phÃ²ng má»›i
        </button>
        
        <div className="relative">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-300"></div>
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="px-2 bg-white text-gray-500">hoáº·c</span>
          </div>
        </div>
        
        <div className="space-y-3">
          <input
            type="text"
            placeholder="Nháº­p mÃ£ phÃ²ng (6 kÃ½ tá»±)"
            value={roomId}
            onChange={(e) => setRoomId(e.target.value.toUpperCase())}
            className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-red-500 focus:outline-none uppercase text-center text-lg font-semibold"
            maxLength={6}
          />
          <button onClick={joinRoom} className="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg">
            <Users size={20} />
            Tham gia phÃ²ng
          </button>
        </div>
      </div>
    </div>
  </div>
);
```

}

return (
<div className="min-h-screen bg-gradient-to-br from-red-900 via-red-800 to-amber-900 p-4">
<div className="max-w-4xl mx-auto">
<div className="bg-white rounded-xl shadow-lg p-4 mb-4">
<div className="flex items-center justify-between">
<div className="flex items-center gap-3">
<button onClick={() => { setScreen(â€˜menuâ€™); setRoomId(â€™â€™); setGameState(null); setSelectedPiece(null); }} className=â€œbg-gray-200 hover:bg-gray-300 p-2 rounded-lg transition-colorsâ€>
<X size={20} />
</button>
<div>
<div className="text-sm text-gray-600">MÃ£ phÃ²ng:</div>
<div className="flex items-center gap-2">
<span className="font-bold text-xl text-red-600">{roomId}</span>
<button onClick={copyRoomId} className="p-1 hover:bg-gray-100 rounded transition-colors">
{copied ? <Check size={16} className="text-green-600" /> : <Copy size={16} />}
</button>
</div>
</div>
</div>
<div className="text-right">
<div className="text-sm text-gray-600">Báº¡n lÃ :</div>
<div className={`font-bold text-xl ${playerColor === 'RED' ? 'text-red-600' : 'text-gray-800'}`}>
{playerColor === â€˜REDâ€™ ? â€˜Äá»â€™ : â€˜Äenâ€™}
</div>
</div>
</div>
</div>

```
    {gameState && (
      <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
        {gameState.status === 'waiting' && (
          <div className="text-center">
            <p className="text-lg font-semibold text-amber-600">Äang chá» Ä‘á»‘i thá»§...</p>
            <p className="text-sm text-gray-600 mt-1">Chia sáº» mÃ£ phÃ²ng Ä‘á»ƒ má»i báº¡n bÃ¨</p>
          </div>
        )}
        
        {gameState.status === 'playing' && (
          <div className="text-center">
            <p className="text-lg font-semibold">
              LÆ°á»£t: <span className={gameState.currentTurn === 'RED' ? 'text-red-600' : 'text-gray-800'}>
                {gameState.currentTurn === 'RED' ? 'Äá»' : 'Äen'}
              </span>
            </p>
            {gameState.currentTurn === playerColor && (
              <p className="text-sm text-green-600 mt-1">Äáº¿n lÆ°á»£t báº¡n!</p>
            )}
          </div>
        )}
        
        {gameState.status === 'finished' && (
          <div className="text-center">
            <p className="text-2xl font-bold mb-3">
              {gameState.winner === playerColor ? 'ğŸ‰ Báº¡n tháº¯ng!' : 'ğŸ˜” Báº¡n thua!'}
            </p>
            <button onClick={resetGame} className="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors inline-flex items-center gap-2">
              <RotateCcw size={18} />
              ChÆ¡i láº¡i
            </button>
          </div>
        )}
      </div>
    )}

    {gameState && (
      <div className="bg-amber-100 rounded-xl shadow-2xl p-6">
        <div className="inline-block bg-amber-200 p-4 rounded-lg">
          {gameState.board.map((row, rowIndex) => (
            <div key={rowIndex} className="flex">
              {row.map((piece, colIndex) => {
                const isSelected = selectedPiece && selectedPiece[0] === rowIndex && selectedPiece[1] === colIndex;
                const isRiver = rowIndex === 4 || rowIndex === 5;
                
                return (
                  <div
                    key={`${rowIndex}-${colIndex}`}
                    onClick={() => handleSquareClick(rowIndex, colIndex)}
                    className={`w-12 h-12 flex items-center justify-center cursor-pointer border border-gray-400 ${isSelected ? 'bg-yellow-300' : isRiver ? 'bg-blue-50' : 'bg-amber-50'} hover:bg-yellow-100 transition-colors`}
                  >
                    {piece && (
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-2xl shadow-lg ${piece.color === 'RED' ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`}>
                        {piece.color === 'RED' ? PIECES.RED[piece.type] : PIECES.BLACK[piece.type]}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          ))}
        </div>
      </div>
    )}
  </div>
</div>
```

);
}