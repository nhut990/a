<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ƒê√†n Piano & Nh·∫°c C·ª• C√≥ Ghi √Çm</title>
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); margin:0; padding:0; min-height:100vh; }
    .container { width:100%; max-width:860px; margin:auto; position:relative; padding:32px 0 24px;}
    h1 { color: #FFD700; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 0 0 10px 0;}
    .created-by { text-align: center; color: #fff; font-size: 13px; opacity: 0.85; margin-bottom: 16px; }
    .sound-control {
      position: absolute; top: 10px; right: 14px;
      display: flex; flex-direction: column; align-items: center; z-index: 100;
    }
    .sound-toggle { background: linear-gradient(145deg, #4CAF50, #45a049); color: white; border: none;
      border-radius: 50%; width: 52px; height: 52px; font-size: 26px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.22);
      transition: all 0.2s; display: flex; align-items: center; justify-content: center;}
    .sound-toggle.muted { background: linear-gradient(145deg, #f44336, #d32f2f);}
    .sound-toggle:active { transform: scale(0.95); }
    .sound-status { color: white; font-size: 13px; font-weight: bold; margin-top: 1px; text-shadow: 0 1px 3px rgba(0,0,0,0.14); }

    .record-controls {
      margin: 10px auto 8px auto;
      display: flex; justify-content: center; gap: 14px; align-items: center;
    }
    .rec-btn, .play-btn, .download-btn, .clear-btn {
      background: linear-gradient(137deg,#222,#7B1FA2);
      color: #FFD700; border: none; border-radius: 12px; padding: 9px 18px;
      font-size: 17px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      cursor: pointer; transition: all 0.15s;
      display: flex; align-items: center; gap:6px;
    }
    .rec-btn { background: linear-gradient(137deg,#d50000,#ee2c2c); color:#fff;}
    .rec-btn.active { background: linear-gradient(137deg,#FFD700,#f6c233); color:#d50000;}
    .play-btn.active { background: linear-gradient(137deg, #43a047,#76ff03); color:#222;}
    .rec-btn:active,.play-btn:active,.download-btn:active,.clear-btn:active { transform: scale(0.97);}
    .clear-btn { background: linear-gradient(125deg,#444,#ee1c90); color:#FFD700;}
    .download-btn { background: linear-gradient(137deg,#ffad2b,#FFD700); color:#7B1FA2;}
    .record-status { font-size:15px;font-weight: bold; color:#fff;margin-left:15px; text-shadow:0 2px 8px rgba(0,0,0,0.2);}
    .record-status.active { color: #FFD700;}

    .instrument-selector { max-width: 260px; margin: 18px auto 16px auto; position: relative; }
    .instrument-current { background: linear-gradient(145deg, #9C27B0, #7B1FA2); color: white; border: none; border-radius: 6px; padding: 9px 14px;
        font-size: 15px; font-weight: bold; cursor: pointer; width: 100%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.3);}
    .instrument-current:active { transform: scale(0.98); }
    .instrument-dropdown {
        position: absolute; top: 100%; left: 0; right: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
        border-radius: 6px; margin-top: 4px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.54);
    }
    .instrument-dropdown.open {
        max-height: 420px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    .instrument-option { background: transparent; color: white; border: none; padding: 10px 12px; font-size: 15px; font-weight: bold; cursor: pointer; width: 100%; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.11); transition: background 0.2s; }
    .instrument-option:hover, .instrument-option:active { background: rgba(156, 39, 176, 0.27); }
    .instrument-option:last-child { border-bottom: none; }
    .loading-status {
      text-align: center; color: #FFD700; font-size: 14px; margin: 10px 0 16px 0; font-weight: bold;
    }
    #alert { 
      text-align: center; 
      color: #f44336; 
      background: #fff2f2;
      border-radius: 8px; 
      font-size: 15px;
      font-weight:bold;
      margin: 12px auto 0 auto; 
      max-width: 350px; 
      padding: 10px 12px;
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.09);
      border: 1px solid #ffd9d9;
    }
    .piano-container { background: rgba(0,0,0,0.32); backdrop-filter: blur(10px); border-radius: 10px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.45); max-width: 820px; margin: auto; }
    .piano { position: relative; height: 150px; width: 1260px; margin: 0 auto;}
    .white-key { position: absolute; width: 33px; height: 150px; background: linear-gradient(to bottom, #fff 0%, #ececec 100%); border: 2px solid #222; border-radius: 0 0 5px 5px; cursor: pointer;
      user-select: none; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 4px; font-size: 9px; color: #555; font-weight: bold; transition: all 0.06s;}
    .white-key.active { background: linear-gradient(145deg, #b3e5fc 0%, #4fc3f7 100%); color: #0277bd;}
    .white-key:active { background: linear-gradient(145deg, #b3e5fc 0%, #4fc3f7 100%);}
    .black-key { position: absolute; width: 22px; height: 89px; background: linear-gradient(to bottom, #444 0%, #0a0a0a 100%); border: 1px solid #111; border-radius: 0 0 4px 4px; cursor: pointer;
      user-select: none; z-index: 9; color: white; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 3px; font-size: 7px; font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.55); transition: all 0.05s;}
    .black-key.active { background: linear-gradient(145deg, #b3e5fc 0%, #4fc3f7 100%); color: #0277bd;}
    .black-key:active { background: linear-gradient(145deg, #b3e5fc 0%, #4fc3f7 100%);}
    @media (max-width: 1290px){
      .piano { width:98vw; max-width:1260px;}
    }
    @media (max-width: 900px){
      .piano-container{max-width:99vw;}
      .piano{width:930px;}
    }
    @media (max-width: 1000px){
      .container{padding:15px 0;}
    }
    @media (max-width: 700px){
      .piano{width:650px;}
      .piano-container{padding:4px;}
    }
    @media (max-width: 650px){
      .piano{width:99vw;}
      .container{padding:8px 0;}
      .piano-container{padding:1px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sound-control">
      <button class="sound-toggle muted" id="soundToggle">
        <span id="soundIcon">üîá</span>
      </button>
      <span class="sound-status" id="soundStatus">T·∫Øt √¢m</span>
    </div>
    <h1>üéπ ƒê√†n Piano & Nh·∫°c C·ª• (C√≥ ghi √¢m, ph√°t l·∫°i)</h1>
    <div class="created-by">Created by Minh Nh·ª±t - ghi √¢m n·ªët & ph√°t l·∫°i b√†n ph√≠m</div>
    <div class="record-controls">
      <button class="rec-btn" id="recordBtn"><span id="recIcon">‚è∫Ô∏è</span> Ghi √¢m</button>
      <button class="play-btn" id="playBtn" disabled><span id="playIcon">‚ñ∂Ô∏è</span> Ph√°t l·∫°i</button>
      <button class="download-btn" id="downloadBtn" disabled><span id="downIcon">üíæ</span> T·∫£i v·ªÅ</button>
      <button class="clear-btn" id="clearBtn" disabled><span id="clearIcon">üóëÔ∏è</span> X√≥a b·∫£n ghi</button>
      <span class="record-status" id="recordStatus">Ch∆∞a ghi √¢m</span>
    </div>
    <div class="instrument-selector">
        <button class="instrument-current" id="instrumentCurrent">
            <span id="instrumentName">üéπ Piano Th·∫≠t</span>
            <span id="dropdownArrow">‚ñº</span>
        </button>
        <div class="instrument-dropdown" id="instrumentDropdown">
            <button class="instrument-option" data-instrument="piano">üéπ Acoustic Grand Piano</button>
            <button class="instrument-option" data-instrument="guitar_nylon">üé∏ Acoustic Guitar Nylon</button>
            <button class="instrument-option" data-instrument="guitar_steel">üé∏ Acoustic Guitar Steel</button>
            <button class="instrument-option" data-instrument="alto_sax">üé∑ Alto Saxophone</button>
            <button class="instrument-option" data-instrument="bass">üé∏ Electric Bass</button>
            <button class="instrument-option" data-instrument="guitar_clean">üé∏ Electric Guitar Clean</button>
            <button class="instrument-option" data-instrument="epiano1">üéπ Electric Piano 1</button>
            <button class="instrument-option" data-instrument="epiano2">üéπ Electric Piano 2</button>
            <button class="instrument-option" data-instrument="flute">üé∂ Flute</button>
            <button class="instrument-option" data-instrument="overdriven_guitar">üé∏ Overdriven Guitar</button>
            <button class="instrument-option" data-instrument="soprano_sax">üé∑ Soprano Saxophone</button>
            <button class="instrument-option" data-instrument="synth_brass">üé∫ Synth Brass 2</button>
            <button class="instrument-option" data-instrument="trumpet">üé∫ Trumpet</button>
            <button class="instrument-option" data-instrument="violin">üéª Violin</button>
        </div>
    </div>
    <div class="loading-status" id="loadingStatus">‚è≥ ƒêang t·∫£i nh·∫°c c·ª•...</div>
    <div id="alert"></div>
    <div class="piano-container">
      <div class="piano" id="piano"></div>
    </div>
  </div>
  <script>
    // ----------- D·ªØ li·ªáu m·∫´u & tr·∫°ng th√°i ----------
    const sampleInstruments = {
      piano: { name: 'üéπ Acoustic Grand Piano', folder: 'acoustic_grand_piano-mp3' },
      guitar_nylon: { name: 'üé∏ Acoustic Guitar Nylon', folder: 'acoustic_guitar_nylon-mp3' },
      guitar_steel: { name: 'üé∏ Acoustic Guitar Steel', folder: 'acoustic_guitar_steel-mp3' },
      alto_sax: { name: 'üé∑ Alto Saxophone', folder: 'alto_sax-mp3' },
      bass: { name: 'üé∏ Electric Bass', folder: 'electric_bass_finger-mp3' },
      guitar_clean: { name: 'üé∏ Electric Guitar Clean', folder: 'electric_guitar_clean-mp3' },
      epiano1: { name: 'üéπ Electric Piano 1', folder: 'electric_piano_1-mp3' },
      epiano2: { name: 'üéπ Electric Piano 2', folder: 'electric_piano_2-mp3' },
      flute: { name: 'üé∂ Flute', folder: 'flute-mp3' },
      overdriven_guitar: { name: 'üé∏ Overdriven Guitar', folder: 'overdriven_guitar-mp3' },
      soprano_sax: { name: 'üé∑ Soprano Saxophone', folder: 'soprano_sax-mp3' },
      synth_brass: { name: 'üé∫ Synth Brass 2', folder: 'synth_brass_2-mp3' },
      trumpet: { name: 'üé∫ Trumpet', folder: 'trumpet-mp3' },
      violin: { name: 'üéª Violin', folder: 'violin-mp3' }
    };
    const sampleBaseURL = "https://raw.githubusercontent.com/Nhut11790/nhut11790.github.io/main/tieng/";
    const pianoNotes = [
      'C3','C#3','D3','D#3','E3','F3','F#3','G3','G#3','A3','A#3','B3',
      'C4','C#4','D4','D#4','E4','F4','F#4','G4','G#4','A4','A#4','B4',
      'C5','C#5','D5','D#5','E5','F5','F#5','G5','G#5','A5'
    ];
    const notesFreq = {
      'C3':130.81,'C#3':138.59,'D3':146.83,'D#3':155.56,'E3':164.81,'F3':174.61,'F#3':185.00,
      'G3':196.00,'G#3':207.65,'A3':220.00,'A#3':233.08,'B3':246.94,
      'C4':261.63,'C#4':277.18,'D4':293.66,'D#4':311.13,'E4':329.63,'F4':349.23,'F#4':369.99,
      'G4':392.00,'G#4':415.30,'A4':440.00,'A#4':466.16,'B4':493.88,
      'C5':523.25,'C#5':554.37,'D5':587.33,'D#5':622.25,'E5':659.25,'F5':698.46,'F#5':739.99,
      'G5':783.99,'G#5':830.61,'A5':880.00
    };
    let audioContext = null;
    let isMuted = true, isAudioActivated = false;
    let currentInstrument = 'piano';
    let sampleBuffers = {};
    for(const key in sampleInstruments) sampleBuffers[key] = {};
    let hasPreload = {}; for(const key in sampleInstruments) hasPreload[key] = false;

    // ----------- Ghi √¢m v√† ph√°t l·∫°i ----------
    let isRecording = false;
    let recordStart = 0;
    let noteRecords = []; // {note, ts, instrument}
    let playbackTimeouts = [];
    let isPlayingBack = false;

    // ========= AUDIO ==========
    function initAudioContext() {
      if (!audioContext) { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
      if (audioContext.state === 'suspended') audioContext.resume();
    }
    function convertSharpToFlat(note) {
      const sharpToFlat = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
      for (let sharp in sharpToFlat) {
        if (note.startsWith(sharp))
          return note.replace(sharp, sharpToFlat[sharp]);
      }
      return note;
    }
    async function preloadSamples(instrument) {
      let notesList = pianoNotes, folder = sampleInstruments[instrument].folder;
      let successCount = 0;
      document.getElementById('loadingStatus').textContent = `‚è≥ ƒêang t·∫£i ${sampleInstruments[instrument].name}...`;
      let promises = notesList.map(note => {
        let flatNote = convertSharpToFlat(note);
        let fileName = flatNote + '.mp3';
        let url = `${sampleBaseURL}${folder}/${fileName}`;
        return fetch(url)
          .then(res => res.ok ? res.arrayBuffer() : null)
          .then(buf => buf ? audioContext.decodeAudioData(buf) : null)
          .then(audioBuf => { 
            if(audioBuf) { sampleBuffers[instrument][note] = audioBuf; successCount++; 
              document.getElementById('loadingStatus').textContent = 
                `‚è≥ ƒêang t·∫£i ${sampleInstruments[instrument].name}... (${successCount}/${notesList.length})`;
            }
          })
          .catch(()=>{});
      });
      await Promise.all(promises);
      if (successCount === 0) {
        document.getElementById('loadingStatus').textContent = `‚ùå Kh√¥ng th·ªÉ t·∫£i nh·∫°c c·ª• ${sampleInstruments[instrument].name}`;
      } else {
        document.getElementById('loadingStatus').textContent = `‚úÖ ƒê√£ t·∫£i ${sampleInstruments[instrument].name}`;
        setTimeout(() => {document.getElementById('loadingStatus').style.display = 'none';},1800);
      }
    }
    async function ensureSamples(instrument) {
      initAudioContext();
      if (!hasPreload[instrument]) {
        document.getElementById('loadingStatus').style.display = 'block';
        await preloadSamples(instrument);
        hasPreload[instrument] = true;
      }
    }

    // ========== TH√îNG B√ÅO ===========
    function showAlert(msg) {
      const alertBox = document.getElementById("alert");
      alertBox.textContent = msg;
      alertBox.style.display = "block";
      setTimeout(() => { alertBox.style.display = "none"; }, 2200);
    }

    // ========== RENDER PIANO ===========
    function renderPiano() {
      const pianoDiv = document.getElementById('piano');
      pianoDiv.innerHTML = '';
      const whiteOrder = ['C','D','E','F','G','A','B'];
      const blackMap = {
        'C': 'C#','D': 'D#','F': 'F#','G': 'G#','A': 'A#'
      };
      let whites = [], whitesIndex = {};
      pianoNotes.forEach(note => {
        let m = note.match(/^([A-G])([#]?)(\d)$/);
        if (m && !m[2]) { whitesIndex[note]=whites.length; whites.push({note: note, octave: m[3], key: m[1]}); }
      });
      // Ph√≠m tr·∫Øng
      whites.forEach((data, i) => {
        let left = i * 33;
        const key = document.createElement('div');
        key.className = 'white-key';
        key.dataset.note = data.note;
        key.textContent = data.note;
        key.style.left = left + 'px';
        key.id = 'key_'+data.note;
        key.tabIndex = 0;
        const playKeyNote = () => playNote(data.note, key,true);
        key.addEventListener('mousedown', () => { key.classList.add('active'); playKeyNote(); });
        key.addEventListener('touchstart', (e) => { e.preventDefault(); key.classList.add('active'); playKeyNote(); });
        key.addEventListener('mouseup', () => { key.classList.remove('active'); });
        key.addEventListener('mouseleave', () => { key.classList.remove('active'); });
        key.addEventListener('touchend', () => { key.classList.remove('active'); });
        pianoDiv.appendChild(key);
      });
      // Ph√≠m ƒëen
      whites.forEach((data, i) => {
        let bKey = blackMap[data.key];
        if (!bKey) return;
        let blackNote = bKey + data.octave;
        if (!pianoNotes.includes(blackNote)) return;
        let left = (i * 33) + 22;
        const key = document.createElement('div');
        key.className = 'black-key';
        key.dataset.note = blackNote;
        key.textContent = blackNote;
        key.style.left = left + 'px';
        key.id = 'key_'+blackNote;
        key.tabIndex = 0;
        const playKeyNote = () => playNote(blackNote, key,true);
        key.addEventListener('mousedown', () => { key.classList.add('active'); playKeyNote(); });
        key.addEventListener('touchstart', (e) => { e.preventDefault(); key.classList.add('active'); playKeyNote(); });
        key.addEventListener('mouseup', () => { key.classList.remove('active'); });
        key.addEventListener('mouseleave', () => { key.classList.remove('active'); });
        key.addEventListener('touchend', () => { key.classList.remove('active'); });
        pianoDiv.appendChild(key);
      });
    }
    // ========== PH√ÅT √ÇM ===========
    async function playSample(instrument, note, volume=1.0, duration=1200) {
      if (!audioContext || !isAudioActivated) return;
      let sampleBuffer = sampleBuffers[instrument][note];
      let rootNote = note;
      if (!sampleBuffer) {
        // D√πng sample g·∫ßn nh·∫•t n·∫øu kh√¥ng c√≥
        const availableNotes = Object.keys(sampleBuffers[instrument]).filter(n => sampleBuffers[instrument][n]);
        let minDiff = 9999, bestNote=null;
        for(const avail of availableNotes){
          let diff = Math.abs(notesFreq[avail] - notesFreq[note]);
          if(diff < minDiff){minDiff=diff;bestNote=avail;}
        }
        if (!bestNote) return;
        sampleBuffer = sampleBuffers[instrument][bestNote];
        rootNote = bestNote;
      }
      const src = audioContext.createBufferSource();
      src.buffer = sampleBuffer;
      let semitone = Math.log2(notesFreq[note] / notesFreq[rootNote]) * 12;
      src.playbackRate.value = Math.pow(2, semitone / 12);
      const gainNode = audioContext.createGain();
      gainNode.gain.value = volume;
      gainNode.connect(audioContext.destination);
      src.connect(gainNode);
      src.start();
      src.stop(audioContext.currentTime + Math.min(duration/1000, src.buffer.duration/src.playbackRate.value));
    }
    // ========== GHI √ÇM NOTE ===========
    async function playNote(note, keyElement, recordEvent=true) {
      if (isPlayingBack) return; // Kh√¥ng ghi khi ƒëang ph√°t l·∫°i
      if (!isAudioActivated) { showAlert("B·∫°n c·∫ßn b·∫≠t √¢m b·∫±ng n√∫t üîá tr∆∞·ªõc khi ch∆°i ƒë√†n!"); return; }
      initAudioContext();
      if (keyElement) {
        keyElement.classList.add('active');
        setTimeout(() => { keyElement.classList.remove('active'); }, 220);
      }
      await ensureSamples(currentInstrument);
      playSample(currentInstrument, note, 1.0, 1150);
      // Ghi v√†o record n·∫øu ƒëang ghi √¢m
      if (isRecording && recordEvent) {
        let now = Date.now();
        if (noteRecords.length === 0) recordStart = now;
        noteRecords.push({
          note: note,
          ts: now - recordStart,
          instrument: currentInstrument
        });
        updateRecordStatus();
      }
    }

    // ========== PH√ÅT L·∫†I B·∫¢N GHI ===========
    async function playback() {
      if (noteRecords.length === 0) return;
      isPlayingBack = true;
      setPlaybackUI(true);
      // ƒêi·ªÅu ki·ªán ƒë·ªÉ ph√°t l·∫°i ƒë√∫ng nh·∫°c c·ª• khi thu
      for (let i = 0; i < noteRecords.length; i++) {
        let rec = noteRecords[i];
        let delay = (i === 0) ? rec.ts : rec.ts - noteRecords[i - 1].ts;
        let t = setTimeout(async () => {
          let inst = rec.instrument || currentInstrument;
          await ensureSamples(inst);
          let keyEl = document.getElementById('key_' + rec.note);
          if (keyEl) {
            keyEl.classList.add('active');
            setTimeout(() => { keyEl.classList.remove('active'); }, 220);
          }
          playSample(inst, rec.note);
          if (i === noteRecords.length - 1) {
            setTimeout(() => { isPlayingBack = false; setPlaybackUI(false); },500);
          }
        }, rec.ts);
        playbackTimeouts.push(t);
      }
    }
    function stopPlayback() {
      playbackTimeouts.forEach(tid => clearTimeout(tid));
      playbackTimeouts = [];
      isPlayingBack = false;
      setPlaybackUI(false);
    }
    // ========== UI RECORD ===========
    function setRecordUI(active) {
      recordBtn.classList.toggle('active', active);
      recordStatus.classList.toggle('active', active);
      recordStatus.textContent = active ? "ƒêang ghi √¢m..." : noteRecords.length>0 ? `ƒê√£ ghi ${noteRecords.length} n·ªët` : "Ch∆∞a ghi √¢m";
      playBtn.disabled = active || noteRecords.length===0;
      downloadBtn.disabled = active || noteRecords.length===0;
      clearBtn.disabled = active || noteRecords.length===0;
    }
    function setPlaybackUI(active) {
      playBtn.classList.toggle('active', active);
      playBtn.textContent = active ? "‚èπÔ∏è D·ª´ng ph√°t l·∫°i" : "‚ñ∂Ô∏è Ph√°t l·∫°i";
      recordBtn.disabled = active;
      downloadBtn.disabled = active || noteRecords.length===0;
      clearBtn.disabled = active || noteRecords.length===0;
      recordStatus.textContent = active ? "ƒêang ph√°t l·∫°i..." : noteRecords.length>0 ? `ƒê√£ ghi ${noteRecords.length} n·ªët` : "Ch∆∞a ghi √¢m";
    }
    function updateRecordStatus() {
      let status='Ch∆∞a ghi √¢m';
      if (isRecording) status = 'ƒêang ghi √¢m...';
      else if (noteRecords.length>0) status = `ƒê√£ ghi ${noteRecords.length} n·ªët`;
      recordStatus.textContent=status;
      playBtn.disabled = isRecording || noteRecords.length===0;
      downloadBtn.disabled = isRecording || noteRecords.length===0;
      clearBtn.disabled = isRecording || noteRecords.length===0;
    }
    // ========== T·∫¢I V·ªÄ FILE ===========
    function downloadRecord() {
      if (noteRecords.length===0) return;
      let obj = {
        instrument: currentInstrument,
        notes: noteRecords,
        date: new Date().toISOString(),
        info: "ƒê√¢y l√† file ghi l·∫°i b·∫£n ch∆°i ƒë√†n piano nhac c·ª• - c√≥ th·ªÉ chia s·∫ª ho·∫∑c t·∫£i l·∫°i tr√™n web"
      };
      let url = URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:"application/json"}));
      let a = document.createElement('a');
      a.href=url;
      a.download="ban-ghi-piano-"+Date.now()+".json";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=>{URL.revokeObjectURL(url)},1300);
    }
    // ========== CLEAR ===========
    function clearRecord(){
      if (isRecording) return;
      noteRecords = [];
      updateRecordStatus();
    }

    // ========== S·ª∞ KI·ªÜN N√öT ===========
    const recordBtn = document.getElementById('recordBtn');
    const playBtn = document.getElementById('playBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const recordStatus = document.getElementById('recordStatus');
    const clearBtn = document.getElementById('clearBtn');
    recordBtn.addEventListener('click', ()=>{
      if (isPlayingBack) return;
      if (!isRecording) {
        isRecording=true; noteRecords=[];
        recordStart=0; setRecordUI(true);
      } else {
        isRecording=false; setRecordUI(false);
      }
    });
    playBtn.addEventListener('click', ()=>{
      if (isPlayingBack) { stopPlayback(); return; }
      if (noteRecords.length>0) playback();
    });
    downloadBtn.addEventListener('click', downloadRecord);
    clearBtn.addEventListener('click', ()=>{clearRecord();});

    // N√∫t √¢m thanh
    const soundToggle = document.getElementById('soundToggle');
    const soundIcon = document.getElementById('soundIcon');
    const soundStatus = document.getElementById('soundStatus');
    soundToggle.addEventListener('click', async () => {
      if (isAudioActivated) return;
      soundToggle.disabled = true;
      soundIcon.textContent = '‚è≥';
      soundStatus.textContent = 'ƒêang k√≠ch ho·∫°t...';
      try {
        initAudioContext();
        const testAudio = new Audio('https://raw.githubusercontent.com/nhut990/files/refs/heads/main/tieng/E3_active_audio.mp3');
        testAudio.volume = 0.3;
        await new Promise((resolve,reject)=>{
          testAudio.addEventListener('canplaythrough',()=>{
            testAudio.play().then(()=>{
              setTimeout(()=>{
                testAudio.pause();
                testAudio.currentTime=0;resolve();
              },250);
            }).catch(reject);
          },{once:true});
          testAudio.addEventListener('error',reject,{once:true});
          testAudio.load();
          setTimeout(()=>reject(new Error('Timeout')),4000);
        });
        await audioContext.resume();
        isAudioActivated = true; isMuted = false;
        soundToggle.classList.remove('muted');
        soundToggle.style.opacity = '0.7';
        soundToggle.style.cursor = 'not-allowed';
        soundIcon.textContent = 'üîä';
        soundStatus.textContent = '√Çm thanh b·∫≠t';
      } catch (error) {
        soundToggle.disabled = false;
        soundIcon.textContent = 'üîá';
        soundStatus.textContent = 'Th·ª≠ l·∫°i';
        alert('‚ö†Ô∏è Kh√¥ng th·ªÉ k√≠ch ho·∫°t √¢m thanh.\n\nL·ªói: ' + error.message);
      }
    });

    // Ch·ªçn nh·∫°c c·ª•
    const instrumentCurrent = document.getElementById('instrumentCurrent');
    const instrumentDropdown = document.getElementById('instrumentDropdown');
    const instrumentName = document.getElementById('instrumentName');
    const dropdownArrow = document.getElementById('dropdownArrow');
    instrumentCurrent.addEventListener('click', () => {
      instrumentDropdown.classList.toggle('open');
      dropdownArrow.textContent = instrumentDropdown.classList.contains('open') ? '‚ñ≤' : '‚ñº';
    });
    document.querySelectorAll('.instrument-option').forEach(btn => {
      btn.addEventListener('click', async () => {
        currentInstrument = btn.dataset.instrument;
        instrumentName.textContent = sampleInstruments[currentInstrument].name;
        await ensureSamples(currentInstrument);
        instrumentDropdown.classList.remove('open');
        dropdownArrow.textContent = '‚ñº';
      });
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.instrument-selector')) {
        instrumentDropdown.classList.remove('open');
        dropdownArrow.textContent = '‚ñº';
      }
    });

    // Keyboard shortcut: A-S-D... ch∆°i theo ph√≠m v·∫≠t l√Ω (th∆∞·ªùng cho C4,D4,E,...) n·∫øu mu·ªën m·ªü r·ªông
    // window.addEventListener('keydown', (e)=>{
    //   let keyMap = {'a':'C4','w':'C#4','s':'D4','e':'D#4','d':'E4','f':'F4','t':'F#4','g':'G4','y':'G#4','h':'A4','u':'A#4','j':'B4'};
    //   let note = keyMap[e.key.toLowerCase()];
    //   if (note){let keyEl = document.getElementById('key_'+note); if (keyEl) playNote(note, keyEl);}
    // });

    // ======== Khi load trang ========
    window.addEventListener('load', async () => {
      initAudioContext();
      instrumentName.textContent = sampleInstruments[currentInstrument].name;
      await ensureSamples('piano');
      renderPiano();
      document.getElementById('loadingStatus').style.display = 'none';
      updateRecordStatus();
    });
  </script>
</body>
</html>
