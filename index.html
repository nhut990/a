<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ki·ªÉm tra Camera & Micro</title>
<style>
  body{
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
    line-height:1.5;
    padding:18px;
    background:#f8f9fb;
    color:#111;
  }
  h1{font-size:1.2rem;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  select,button{
    padding:8px;border-radius:6px;border:1px solid #cfcfcf;background:white
  }
  button{cursor:pointer;transition:opacity .2s}
  button:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  video{width:100%;max-width:560px;border-radius:8px;background:#000}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .meter{width:220px;height:22px;border-radius:6px;background:#eee;overflow:hidden;position:relative}
  .meter>.level{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#ffeb3b)}
  .panel{margin-top:12px;max-width:760px}
  .small{font-size:0.9rem;color:#444}
  .note{font-size:0.85rem;color:#444;margin-top:8px}
  audio{display:block;margin-top:8px}
  .timer{padding:6px 8px;border-radius:6px;background:#fff;border:1px solid #ddd}
  hr{margin:14px 0}
</style>
</head>
<body>
  <h1>Trang ki·ªÉm tra Camera & Micro (Web)</h1>

  <div class="panel">
    <div class="row">
      <label>
        Camera:
        <select id="cameraSelect"></select>
      </label>

      <label>
        Micro:
        <select id="micSelect"></select>
      </label>

      <div style="display:flex;align-items:center;gap:8px">
        <button id="startPreviewBtn">B·∫Øt ƒë·∫ßu Preview</button>
        <button id="stopPreviewBtn" disabled>Ng∆∞ng Preview</button>
      </div>
    </div>

    <video id="videoPreview" playsinline autoplay muted></video>

    <div class="row" style="align-items:center;margin-top:10px">
      <div class="small">M·ª©c √¢m thanh (camera/micro):</div>
      <div class="meter"><div class="level" id="meterLevelCam"></div></div>
      <div class="timer" id="levelDbCam">‚Äî dB</div>
    </div>

    <div class="note">
      ‚ö†Ô∏è <b>L∆∞u √Ω:</b> Tr√¨nh duy·ªát c√≥ th·ªÉ y√™u c·∫ßu quy·ªÅn truy c·∫≠p <b>camera</b> v√† <b>micro</b>. 
      H√£y ch·ªçn ‚ÄúCho ph√©p‚Äù ƒë·ªÉ ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.
    </div>

    <hr />

    <div class="row" style="align-items:center">
      <div class="small">Ghi √¢m ki·ªÉm tra micro:</div>
    </div>

    <div class="controls">
      <button id="startRecBtn">B·∫Øt ƒë·∫ßu Ghi √¢m</button>
      <button id="stopRecBtn" disabled>Ng∆∞ng Ghi</button>
      <button id="playRecBtn" disabled>Ph√°t L·∫°i</button>
      <a id="downloadLink" style="padding:8px;border-radius:6px;text-decoration:none;border:1px solid #cfcfcf;background:#fff;color:#111" download="recording.webm">T·∫£i v·ªÅ</a>
      <div id="recTimer" class="timer">00:00</div>
    </div>

    <div class="row" style="align-items:center;margin-top:6px">
      <div class="small">M·ª©c √¢m thanh khi ghi:</div>
      <div class="meter"><div class="level" id="meterLevelRec"></div></div>
      <div class="timer" id="levelDbRec">‚Äî dB</div>
    </div>

    <audio id="playback" controls></audio>
  </div>

<script>
(async function(){
  const cameraSelect=document.getElementById('cameraSelect');
  const micSelect=document.getElementById('micSelect');
  const startPreviewBtn=document.getElementById('startPreviewBtn');
  const stopPreviewBtn=document.getElementById('stopPreviewBtn');
  const videoPreview=document.getElementById('videoPreview');
  const meterLevelCam=document.getElementById('meterLevelCam');
  const levelDbCam=document.getElementById('levelDbCam');
  const meterLevelRec=document.getElementById('meterLevelRec');
  const levelDbRec=document.getElementById('levelDbRec');
  const startRecBtn=document.getElementById('startRecBtn');
  const stopRecBtn=document.getElementById('stopRecBtn');
  const playRecBtn=document.getElementById('playRecBtn');
  const downloadLink=document.getElementById('downloadLink');
  const playback=document.getElementById('playback');
  const recTimer=document.getElementById('recTimer');

  let currentStream=null;
  let audioContextCam=null, analyserCam=null, rafCam=null;
  let audioContextRec=null, analyserRec=null, rafRec=null;
  let mediaRecorder=null, recordedChunks=[];
  let recTimerInterval=null, recordingStart=null;

  async function updateDeviceList(){
    const devices=await navigator.mediaDevices.enumerateDevices();
    const cams=devices.filter(d=>d.kind==='videoinput');
    const mics=devices.filter(d=>d.kind==='audioinput');
    cameraSelect.innerHTML=cams.map(c=>`<option value="${c.deviceId}">${c.label||'Camera '+(cams.indexOf(c)+1)}</option>`).join('')||'<option>(Kh√¥ng c√≥ camera)</option>';
    micSelect.innerHTML=mics.map(m=>`<option value="${m.deviceId}">${m.label||'Micro '+(mics.indexOf(m)+1)}</option>`).join('')||'<option>(Kh√¥ng c√≥ micro)</option>';
  }

  async function startPreview(){
    stopPreview();
    startPreviewBtn.disabled=true; // üîí l√†m m·ªù n√∫t khi ƒëang preview
    try{
      const constraints={
        audio: micSelect.value?{deviceId:{exact:micSelect.value}}:true,
        video: cameraSelect.value?{deviceId:{exact:cameraSelect.value}}:{facingMode:'user'}
      };
      currentStream=await navigator.mediaDevices.getUserMedia(constraints);
      videoPreview.srcObject=currentStream;
      await videoPreview.play().catch(()=>{});
      stopPreviewBtn.disabled=false;
      setupAudioMeterCam(currentStream);
    }catch(err){
      alert('Kh√¥ng th·ªÉ truy c·∫≠p camera/micro: '+err.message);
      startPreviewBtn.disabled=false; // kh√¥i ph·ª•c l·∫°i n·∫øu l·ªói
    }
  }

  function stopPreview(){
    if(currentStream){currentStream.getTracks().forEach(t=>t.stop());currentStream=null;}
    if(videoPreview){videoPreview.pause();videoPreview.srcObject=null;}
    disconnectAudioMeterCam();
    stopPreviewBtn.disabled=true;
    startPreviewBtn.disabled=false; // ‚úÖ kh√¥i ph·ª•c n√∫t s√°ng l·∫°i
  }

  cameraSelect.addEventListener('change',()=>{if(currentStream)startPreview();});

  function setupAudioMeterCam(stream){
    disconnectAudioMeterCam();
    const audioTracks=stream.getAudioTracks();
    if(!audioTracks.length)return;
    audioContextCam=new (window.AudioContext||window.webkitAudioContext)();
    const source=audioContextCam.createMediaStreamSource(new MediaStream(audioTracks));
    analyserCam=audioContextCam.createAnalyser();
    analyserCam.fftSize=2048;
    source.connect(analyserCam);
    const data=new Uint8Array(analyserCam.fftSize);
    function update(){
      analyserCam.getByteTimeDomainData(data);
      let sum=0;for(let i=0;i<data.length;i++){const v=(data[i]-128)/128;sum+=v*v;}
      const rms=Math.sqrt(sum/data.length);
      const db=20*Math.log10(rms||1e-8);
      const pct=Math.min(100,Math.max(0,rms*300));
      meterLevelCam.style.width=pct+'%';
      levelDbCam.textContent=db.toFixed(1)+' dB';
      rafCam=requestAnimationFrame(update);
    }
    update();
  }

  function disconnectAudioMeterCam(){
    if(rafCam){cancelAnimationFrame(rafCam);rafCam=null;}
    if(analyserCam){analyserCam.disconnect();analyserCam=null;}
    if(audioContextCam){try{audioContextCam.close();}catch(e){}audioContextCam=null;}
    meterLevelCam.style.width='0%';
    levelDbCam.textContent='‚Äî dB';
  }

  function setupAudioMeterRec(stream){
    disconnectAudioMeterRec();
    const audioTracks=stream.getAudioTracks();
    if(!audioTracks.length)return;
    audioContextRec=new (window.AudioContext||window.webkitAudioContext)();
    const source=audioContextRec.createMediaStreamSource(new MediaStream(audioTracks));
    analyserRec=audioContextRec.createAnalyser();
    analyserRec.fftSize=2048;
    source.connect(analyserRec);
    const data=new Uint8Array(analyserRec.fftSize);
    function update(){
      analyserRec.getByteTimeDomainData(data);
      let sum=0;for(let i=0;i<data.length;i++){const v=(data[i]-128)/128;sum+=v*v;}
      const rms=Math.sqrt(sum/data.length);
      const db=20*Math.log10(rms||1e-8);
      const pct=Math.min(100,Math.max(0,rms*300));
      meterLevelRec.style.width=pct+'%';
      levelDbRec.textContent=db.toFixed(1)+' dB';
      rafRec=requestAnimationFrame(update);
    }
    update();
  }

  function disconnectAudioMeterRec(){
    if(rafRec){cancelAnimationFrame(rafRec);rafRec=null;}
    if(analyserRec){analyserRec.disconnect();analyserRec=null;}
    if(audioContextRec){try{audioContextRec.close();}catch(e){}audioContextRec=null;}
    meterLevelRec.style.width='0%';
    levelDbRec.textContent='‚Äî dB';
  }

  function startRecording(){
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
      setupAudioMeterRec(stream);
      recordedChunks=[];
      const options={};
      if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus'))options.mimeType='audio/webm;codecs=opus';
      else if(MediaRecorder.isTypeSupported('audio/ogg;codecs=opus'))options.mimeType='audio/ogg;codecs=opus';
      mediaRecorder=new MediaRecorder(stream,options);
      mediaRecorder.ondataavailable=e=>{if(e.data.size)recordedChunks.push(e.data);};
      mediaRecorder.onstop=()=>{
        disconnectAudioMeterRec();
        const blob=new Blob(recordedChunks,{type:recordedChunks[0]?.type||'audio/webm'});
        const url=URL.createObjectURL(blob);
        playback.src=url;
        playRecBtn.disabled=false;
        downloadLink.href=url;
      };
      mediaRecorder.start();
      startRecBtn.disabled=true;
      stopRecBtn.disabled=false;
      playRecBtn.disabled=true;
      recordingStart=Date.now();
      recTimerInterval=setInterval(()=>{
        const s=Math.floor((Date.now()-recordingStart)/1000);
        const mm=String(Math.floor(s/60)).padStart(2,'0');
        const ss=String(s%60).padStart(2,'0');
        recTimer.textContent=`${mm}:${ss}`;
      },300);
    }).catch(e=>alert('Kh√¥ng th·ªÉ ghi √¢m: '+e.message));
  }

  function stopRecording(){
    if(mediaRecorder&&mediaRecorder.state!=='inactive')mediaRecorder.stop();
    if(recTimerInterval){clearInterval(recTimerInterval);recTimerInterval=null;}
    startRecBtn.disabled=false;
    stopRecBtn.disabled=true;
  }

  playRecBtn.addEventListener('click',()=>playback.play().catch(()=>{}));
  startPreviewBtn.addEventListener('click',startPreview);
  stopPreviewBtn.addEventListener('click',stopPreview);
  startRecBtn.addEventListener('click',startRecording);
  stopRecBtn.addEventListener('click',stopRecording);
  navigator.mediaDevices.addEventListener('devicechange',updateDeviceList);
  await updateDeviceList();
})();
</script>
</body>
</html>