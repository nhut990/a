<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Báº£n Ä‘á»“ chia sáº» vá»‹ trÃ­ (Leaflet)</title>

<!-- ThÆ° viá»‡n báº£n Ä‘á»“ Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #f2f2f2;
    font-family: sans-serif;
    text-align: center;
  }
  #map {
    width: 100%;
    height: 80vh;
  }
  #info {
    padding: 10px;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background: #4CAF50;
    color: white;
  }
</style>
</head>
<body>

<h2>ğŸ“ Chia sáº» vá»‹ trÃ­ theo thá»i gian thá»±c</h2>
<div id="info">Nháº¥n nÃºt Ä‘á»ƒ báº¯t Ä‘áº§u chia sáº» vá»‹ trÃ­</div>
<button onclick="startShare()">Báº¯t Ä‘áº§u chia sáº»</button>
<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ==== Cáº¥u hÃ¬nh Firebase ====
const firebaseConfig = {
  databaseURL: "https://mapgps-6fa8a-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== TÃªn ngÆ°á»i chia sáº» ====
const USERNAME = "nhut"; // sá»­a thÃ nh tÃªn khÃ¡c náº¿u lÃ  ngÆ°á»i khÃ¡c

let map, marker;

// ==== Khá»Ÿi táº¡o báº£n Ä‘á»“ Leaflet ====
function initMap() {
  map = L.map('map').setView([10.8, 106.6], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
  }).addTo(map);

  marker = L.marker([10.8, 106.6]).addTo(map)
    .bindPopup("Vá»‹ trÃ­ hiá»‡n táº¡i").openPopup();

  // Láº¯ng nghe vá»‹ trÃ­ tá»« Firebase
  firebase.database().ref("locations/" + USERNAME).on("value", snap => {
    const data = snap.val();
    if (data) {
      const latlng = [data.lat, data.lng];
      marker.setLatLng(latlng);
      map.setView(latlng, 15);
      document.getElementById("info").innerHTML = 
        `ğŸ“ Lat: ${data.lat.toFixed(5)}, Lng: ${data.lng.toFixed(5)}<br>
         â± ${new Date(data.timestamp).toLocaleTimeString()}<br>
         <a href="https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}" target="_blank">ğŸ§­ Chá»‰ Ä‘Æ°á»ng Ä‘áº¿n Ä‘Ã¢y</a>`;
    }
  });
}

// ==== Báº¯t Ä‘áº§u chia sáº» vá»‹ trÃ­ ====
function startShare() {
  document.getElementById("info").innerText = "Äang chia sáº» vá»‹ trÃ­...";
  if (!navigator.geolocation) {
    alert("Thiáº¿t bá»‹ khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹ GPS");
    return;
  }

  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const timestamp = Date.now();
      firebase.database().ref("locations/" + USERNAME).set({ lat, lng, timestamp });
    },
    err => alert("KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­: " + err.message),
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

// Khá»Ÿi táº¡o báº£n Ä‘á»“ sau khi táº£i xong
window.onload = initMap;
</script>

</body>
</html>