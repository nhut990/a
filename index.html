<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat ri√™ng Firebase</title>
<style>
body { font-family: Arial; background:#eef; text-align:center; margin:0; padding:0; }
#login, #chat { max-width:400px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px #999; }
input, button { width:90%; padding:10px; margin:6px 0; font-size:16px; }
#messages { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; text-align:left; background:#fafafa; }
.msg { margin:4px 0; }
.me { color:blue; font-weight:bold; }
.you { color:green; font-weight:bold; }
</style>
</head>
<body>

<div id="login">
  <h2>üí¨ Chat ri√™ng Firebase</h2>
  <input id="name" placeholder="T√™n c·ªßa b·∫°n">
  <input id="room" placeholder="T√™n ph√≤ng">
  <input id="pass" placeholder="M·∫≠t kh·∫©u" type="password">
  <button id="create">T·∫°o ph√≤ng</button>
  <button id="join">V√†o ph√≤ng</button>
</div>

<div id="chat" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <input id="msgBox" placeholder="Nh·∫≠p tin nh·∫Øn...">
  <button id="send">G·ª≠i</button>
  <br><br>
  <button id="deleteRoom" style="background:red;color:white;">Xo√° ph√≤ng</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  databaseURL: "https://nhutvan5c-79ce9-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let myName, roomName, myPass, isCreator=false;

// --- T·∫°o ph√≤ng ---
document.getElementById("create").onclick = async ()=>{
  myName = name.value.trim();
  roomName = room.value.trim();
  myPass = pass.value.trim();
  if(!myName || !roomName || !myPass) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
  const rRef = ref(db,"rooms/"+roomName);
  const snap = await get(rRef);
  if(snap.exists()) return alert("Ph√≤ng ƒë√£ t·ªìn t·∫°i!");
  await set(rRef,{password:myPass,messages:{}});
  isCreator=true;
  startChat();
};

// --- V√†o ph√≤ng ---
document.getElementById("join").onclick = async ()=>{
  myName = name.value.trim();
  roomName = room.value.trim();
  myPass = pass.value.trim();
  if(!myName || !roomName || !myPass) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
  const rRef = ref(db,"rooms/"+roomName);
  const snap = await get(rRef);
  if(!snap.exists()) return alert("Ph√≤ng kh√¥ng t·ªìn t·∫°i!");
  const data = snap.val();
  if(data.password!==myPass) return alert("Sai m·∫≠t kh·∫©u!");
  startChat();
};

// --- B·∫Øt ƒë·∫ßu chat ---
function startChat(){
  login.style.display="none";
  chat.style.display="block";
  roomTitle.textContent="Ph√≤ng: "+roomName;
  loadMessages();
}

// --- G·ª≠i tin nh·∫Øn ---
document.getElementById("send").onclick = async ()=>{
  const text = msgBox.value.trim();
  if(!text) return;
  const msgRef = ref(db,"rooms/"+roomName+"/messages");
  await push(msgRef,{
    sender: myName,
    text: text,
    time: new Date().toLocaleString()
  });
  msgBox.value="";
};

// --- Hi·ªÉn th·ªã tin nh·∫Øn realtime ---
function loadMessages(){
  const msgRef = ref(db,"rooms/"+roomName+"/messages");
  onValue(msgRef,(snap)=>{
    messages.innerHTML="";
    snap.forEach(child=>{
      const m=child.val();
      const div=document.createElement("div");
      div.className="msg";
      div.innerHTML=`<span class='${m.sender===myName?"me":"you"}'>${m.sender}:</span> ${m.text}`;
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

// --- Xo√° ph√≤ng ---
document.getElementById("deleteRoom").onclick = async ()=>{
  if(!isCreator) return alert("Ch·ªâ ng∆∞·ªùi t·∫°o ph√≤ng m·ªõi ƒë∆∞·ª£c xo√°!");
  if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° ph√≤ng n√†y?")){
    await remove(ref(db,"rooms/"+roomName));
    alert("ƒê√£ xo√° ph√≤ng!");
    location.reload();
  }
};
</script>
</body>
</html>