<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Karaoke Echo with YouTube</title>
  <style>
    body { font-family: sans-serif; background: #191624; color: #fff; text-align: center; }
    #youtube-container { margin: 20px 0; }
    .controls { margin: 25px 0; }
    .slider { width: 300px; }
    input[type="text"] { width: 350px; padding: 7px; border-radius: 4px; border: 1px solid #ccc; }
    label { font-size: 1rem; }
    button { padding: 8px 18px; border-radius: 5px; border: 1px solid #244; background: #5533cc; color: white; cursor: pointer; }
    button:hover { background: #7755ee; }
  </style>
</head>
<body>
  <h1>Karaoke với Echo & YouTube</h1>
  <div class="controls">
    <input id="youtube-url" type="text" placeholder="Dán link YouTube karaoke vào đây" />
    <button onclick="loadYouTube()">Phát nhạc Karaoke</button>
  </div>
  <div id="youtube-container"></div>
  <div class="controls">
    <button id="mic-btn" onclick="toggleMic()">Bật Mic</button>
    <label for="echo">Echo mic (Delay):</label>
    <input id="echo" class="slider" type="range" min="0" max="1" step="0.01" value="0.18" onchange="setEcho(this.value)" />
    <span id="echo-value">0.18s</span>
  </div>
  <p>Bật mic, tăng giảm Echo để tạo hiệu ứng vọng, vừa hát vừa nghe nhạc karaoke ở YouTube.</p>
  <script>
    // YouTube embed logic
    function getYoutubeId(url) {
      const regExp = /(?:youtube\.com.*v=|youtu\.be\/)([a-zA-Z0-9_-]+)/i;
      const match = url.match(regExp);
      return match ? match[1] : '';
    }
    function loadYouTube() {
      const url = document.getElementById('youtube-url').value.trim();
      const id = getYoutubeId(url);
      if (id) {
        document.getElementById('youtube-container').innerHTML =
          `<iframe width="560" height="315"
            src="https://www.youtube.com/embed/${id}?autoplay=1"
            frameborder="0" allow="autoplay; encrypted-media"
            allowfullscreen></iframe>`;
      } else {
        alert('Link YouTube không đúng!');
      }
    }

    // Mic + Echo logic
    let audioContext, micStream, delayNode, sourceNode;
    let isMicOn = false;
    function toggleMic() {
      if (!isMicOn) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            micStream = stream;
            sourceNode = audioContext.createMediaStreamSource(stream);

            // Create echo effect using DelayNode & Feedback
            delayNode = audioContext.createDelay(2.0);
            delayNode.delayTime.value = parseFloat(document.getElementById('echo').value);

            // Feedback loop for echo effect
            let feedback = audioContext.createGain();
            feedback.gain.value = 0.35;

            // Connect feedback loop
            sourceNode.connect(delayNode);
            delayNode.connect(feedback);
            feedback.connect(delayNode);
            delayNode.connect(audioContext.destination);

            isMicOn = true;
            document.getElementById('mic-btn').textContent = 'Tắt Mic';
          })
          .catch(() => alert('Không thể truy cập mic, vui lòng cấp quyền'));
      } else {
        // Turn off mic
        if (micStream) micStream.getTracks().forEach(track => track.stop());
        if (audioContext) audioContext.close();
        isMicOn = false;
        document.getElementById('mic-btn').textContent = 'Bật Mic';
      }
    }
    function setEcho(val) {
      document.getElementById('echo-value').textContent = `${val}s`;
      if (delayNode) delayNode.delayTime.value = parseFloat(val);
    }
  </script>
</body>
</html>
