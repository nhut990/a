<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ki·ªÉm tra Camera & Micro - Test tr·ª±c ti·∫øp tr√™n Web</title>
<style>
  body{
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
    line-height:1.4;
    padding:18px;
    background:#f7f7f9;
    color:#111;
  }
  h1{font-size:1.2rem;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  select,button{
    padding:8px;border-radius:6px;border:1px solid #cfcfcf;background:white
  }
  button{cursor:pointer}
  video{width:100%;max-width:560px;border-radius:8px;background:#000}
  .note{font-size:0.85rem;color:#444;margin-top:8px}
</style>
</head>
<body>
  <h1>Trang ki·ªÉm tra Camera & Micro (Web)</h1>

  <div class="row">
    <label>
      Camera:
      <select id="cameraSelect"></select>
    </label>

    <label>
      Micro:
      <select id="micSelect"></select>
    </label>

    <div style="display:flex;align-items:center;gap:8px">
      <button id="startPreviewBtn">B·∫Øt ƒë·∫ßu Preview</button>
      <button id="stopPreviewBtn" disabled>Ng∆∞ng Preview</button>
    </div>
  </div>

  <video id="videoPreview" playsinline autoplay muted></video>

  <div class="note">
    ‚ö†Ô∏è <b>L∆∞u √Ω:</b> Tr√¨nh duy·ªát c√≥ th·ªÉ y√™u c·∫ßu quy·ªÅn truy c·∫≠p <b>camera</b> v√† <b>micro</b>. 
    T√≠nh nƒÉng n√†y ch·ªâ ho·∫°t ƒë·ªông khi b·∫°n <b>ch·ªçn Cho ph√©p</b>.
  </div>

<script>
(async function(){
  const cameraSelect=document.getElementById('cameraSelect');
  const micSelect=document.getElementById('micSelect');
  const startPreviewBtn=document.getElementById('startPreviewBtn');
  const stopPreviewBtn=document.getElementById('stopPreviewBtn');
  const videoPreview=document.getElementById('videoPreview');
  let currentStream=null;

  async function updateDeviceList(){
    try{
      const devices=await navigator.mediaDevices.enumerateDevices();
      const cams=devices.filter(d=>d.kind==='videoinput');
      const mics=devices.filter(d=>d.kind==='audioinput');

      cameraSelect.innerHTML=cams.map(c=>`<option value="${c.deviceId}">${c.label||'Camera '+(cams.indexOf(c)+1)}</option>`).join('') || '<option value="">(Kh√¥ng c√≥ camera)</option>';
      micSelect.innerHTML=mics.map(m=>`<option value="${m.deviceId}">${m.label||'Micro '+(mics.indexOf(m)+1)}</option>`).join('') || '<option value="">(Kh√¥ng c√≥ micro)</option>';
    }catch(err){
      console.warn('Kh√¥ng th·ªÉ li·ªát k√™ thi·∫øt b·ªã:',err);
    }
  }

  async function startPreview(){
    stopPreview();
    const constraints={
      audio: micSelect.value?{deviceId:{exact:micSelect.value}}:true,
      video: cameraSelect.value?{deviceId:{exact:cameraSelect.value}}:{facingMode:'user'}
    };
    try{
      currentStream=await navigator.mediaDevices.getUserMedia(constraints);
      videoPreview.srcObject=currentStream;
      videoPreview.muted=true;
      await videoPreview.play().catch(()=>{});
      stopPreviewBtn.disabled=false;
    }catch(err){
      alert('L·ªói khi truy c·∫≠p camera/micro: '+(err.message||err.name));
    }
  }

  function stopPreview(){
    if(currentStream){
      currentStream.getTracks().forEach(t=>t.stop());
      currentStream=null;
    }
    videoPreview.srcObject=null;
    stopPreviewBtn.disabled=true;
  }

  // üîÑ T·ª± ƒë·ªông chuy·ªÉn camera khi ng∆∞·ªùi d√πng ch·ªçn camera kh√°c
  cameraSelect.addEventListener('change',()=>{
    if(currentStream) startPreview();
  });

  startPreviewBtn.addEventListener('click',startPreview);
  stopPreviewBtn.addEventListener('click',stopPreview);

  navigator.mediaDevices.addEventListener('devicechange',updateDeviceList);
  await updateDeviceList();
})();
</script>
</body>
</html>