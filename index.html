<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat riÃªng Firebase</title>
<style>
body { font-family: Arial; background:#eef; text-align:center; margin:0; padding:0; }
#login, #chat { max-width:400px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px #999; }
input, button { width:90%; padding:10px; margin:6px 0; font-size:16px; border:1px solid #ccc; border-radius:5px; }
button { background:#4CAF50; color:white; cursor:pointer; border:none; }
button:hover { background:#45a049; }
button:disabled { background:#ccc; cursor:not-allowed; }
#messages { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; text-align:left; background:#fafafa; margin:10px 0; }
.msg { margin:8px 0; padding:8px 12px; clear:both; max-width:80%; word-wrap:break-word; }
.msg.left { float:left; background:#e3f2fd; border-radius:10px 10px 10px 0; }
.msg.right { float:right; background:#c8e6c9; border-radius:10px 10px 0 10px; text-align:right; }
.msg .sender { font-weight:bold; font-size:13px; margin-bottom:3px; display:block; }
.msg.left .sender { color:#1976d2; }
.msg.right .sender { color:#388e3c; }
.msg .text { font-size:15px; color:#333; }
.msg .time { font-size:11px; color:#666; margin-top:3px; display:block; }
#deleteRoom { background:#f44336; }
#deleteRoom:hover { background:#da190b; }
.loading { opacity:0.6; pointer-events:none; }
.system-msg { text-align:center; color:#999; font-size:12px; padding:5px; font-style:italic; clear:both; }
</style>
</head>
<body>

<div id="login">
  <h2>ğŸ’¬ Chat riÃªng Online</h2>
  <button id="showGuide" style="width:auto; padding:5px 15px; font-size:14px; background:#2196F3; margin-bottom:10px;">ğŸ“– HÆ°á»›ng dáº«n</button>
  <input id="name" placeholder="TÃªn cá»§a báº¡n" autocomplete="off">
  <input id="room" placeholder="TÃªn phÃ²ng" autocomplete="off">
  <input id="pass" placeholder="Máº­t kháº©u" type="password">
  <button id="create">Táº¡o phÃ²ng</button>
  <button id="join">VÃ o phÃ²ng</button>
  <p style="font-size:12px; color:#666;">ğŸ’¡ TÃªn phÃ²ng vÃ  máº­t kháº©u phÃ¢n biá»‡t hoa thÆ°á»ng</p>
</div>

<!-- Modal HÆ°á»›ng dáº«n -->

<div id="guideModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; overflow:auto;">
  <div style="max-width:500px; margin:30px auto; background:white; padding:25px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
    <h2 style="color:#2196F3; margin-top:0;">ğŸ“– HÆ°á»›ng dáº«n sá»­ dá»¥ng Chat riÃªng Online</h2>
    <div style="text-align:left; line-height:1.8;">
      <h3 style="color:#4CAF50; margin-top:20px;">ğŸ  Táº¡o phÃ²ng chat</h3>
      <p style="margin:5px 0;">1ï¸âƒ£ Nháº­p <strong>tÃªn cá»§a báº¡n</strong></p>
      <p style="margin:5px 0;">2ï¸âƒ£ Äáº·t <strong>tÃªn phÃ²ng</strong> (vÃ­ dá»¥: PhongCuaBan123)</p>
      <p style="margin:5px 0;">3ï¸âƒ£ Táº¡o <strong>máº­t kháº©u</strong> (tá»‘i thiá»ƒu 6 kÃ½ tá»±)</p>
      <p style="margin:5px 0;">4ï¸âƒ£ Nháº¥n nÃºt <strong>"Táº¡o phÃ²ng"</strong></p>
      <p style="margin:5px 0; color:#666; font-size:14px;">ğŸ’¡ Báº¡n lÃ  ngÆ°á»i táº¡o phÃ²ng vÃ  sáº½ nháº­n thÃ´ng bÃ¡o khi cÃ³ ngÆ°á»i vÃ o</p>

```
  <h3 style="color:#FF9800; margin-top:20px;">ğŸšª VÃ o phÃ²ng cÃ³ sáºµn</h3>
  <p style="margin:5px 0;">1ï¸âƒ£ Nháº­p <strong>tÃªn cá»§a báº¡n</strong></p>
  <p style="margin:5px 0;">2ï¸âƒ£ Nháº­p <strong>tÃªn phÃ²ng</strong> (do báº¡n bÃ¨ táº¡o)</p>
  <p style="margin:5px 0;">3ï¸âƒ£ Nháº­p <strong>máº­t kháº©u</strong> (há»i ngÆ°á»i táº¡o phÃ²ng)</p>
  <p style="margin:5px 0;">4ï¸âƒ£ Nháº¥n nÃºt <strong>"VÃ o phÃ²ng"</strong></p>
  
  <h3 style="color:#9C27B0; margin-top:20px;">ğŸ’¬ Chat trong phÃ²ng</h3>
  <p style="margin:5px 0;">âœ… Tin nháº¯n cá»§a báº¡n: <span style="background:#c8e6c9; padding:3px 8px; border-radius:5px;">mÃ u xanh lÃ¡, bÃªn pháº£i</span></p>
  <p style="margin:5px 0;">âœ… Tin nháº¯n ngÆ°á»i khÃ¡c: <span style="background:#e3f2fd; padding:3px 8px; border-radius:5px;">mÃ u xanh dÆ°Æ¡ng, bÃªn trÃ¡i</span></p>
  <p style="margin:5px 0;">âœ… Nháº¥n <strong>Enter</strong> hoáº·c nÃºt <strong>"Gá»­i"</strong> Ä‘á»ƒ gá»­i tin</p>
  
  <h3 style="color:#f44336; margin-top:20px;">âš ï¸ LÆ°u Ã½ quan trá»ng</h3>
  <p style="margin:5px 0;">ğŸ”’ <strong>Báº£o máº­t:</strong> TÃªn phÃ²ng vÃ  máº­t kháº©u phÃ¢n biá»‡t HOA/thÆ°á»ng</p>
  <p style="margin:5px 0;">ğŸ—‘ï¸ <strong>XÃ³a phÃ²ng:</strong> Báº¥t ká»³ ai trong phÃ²ng Ä‘á»u cÃ³ thá»ƒ xÃ³a phÃ²ng</p>
  <p style="margin:5px 0;">ğŸ’¾ <strong>Dá»¯ liá»‡u:</strong> Khi xÃ³a phÃ²ng, Táº¤T Cáº¢ tin nháº¯n sáº½ Máº¤T VÄ¨NH VIá»„N</p>
  <p style="margin:5px 0;">ğŸ”„ <strong>Real-time:</strong> Tin nháº¯n hiá»ƒn thá»‹ ngay láº­p tá»©c cho táº¥t cáº£ thÃ nh viÃªn</p>
  <p style="margin:5px 0;">ğŸ‘¥ <strong>Chia sáº»:</strong> Gá»­i tÃªn phÃ²ng + máº­t kháº©u cho báº¡n bÃ¨ Ä‘á»ƒ há» vÃ o cÃ¹ng</p>
  
  <div style="background:#ffebee; border-left:4px solid #f44336; padding:12px; margin-top:20px; border-radius:5px;">
    <p style="color:#c62828; margin:0; font-size:14px; line-height:1.6;">
      <strong>âš ï¸ CAM Káº¾T VÃ€ KHUYáº¾N CÃO:</strong><br>
      Web nÃ y Ä‘Æ°á»£c táº¡o ra vá»›i má»¥c Ä‘Ã­ch giÃºp má»i ngÆ°á»i trÃ² chuyá»‡n vá»›i nhau má»™t cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t. ChÃºng tÃ´i cam káº¿t <strong>KHÃ”NG lÆ°u trá»¯, thu tháº­p hay sá»­ dá»¥ng</strong> báº¥t ká»³ ná»™i dung trÃ² chuyá»‡n nÃ o cá»§a báº¡n. Tuy nhiÃªn, Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n tuyá»‡t Ä‘á»‘i, chÃºng tÃ´i <strong>KHÃ”NG KHUYáº¾N NGHá»Š</strong> chia sáº» cÃ¡c thÃ´ng tin nháº¡y cáº£m nhÆ°: máº­t kháº©u tÃ i khoáº£n, sá»‘ tháº» ngÃ¢n hÃ ng, CMND/CCCD, tÃ i liá»‡u máº­t, thÃ´ng tin cÃ¡ nhÃ¢n quan trá»ng hoáº·c báº¥t ká»³ dá»¯ liá»‡u nháº¡y cáº£m nÃ o khÃ¡c qua á»©ng dá»¥ng nÃ y.
    </p>
  </div>
</div>
<button id="closeGuide" style="width:100%; margin-top:20px; padding:12px; background:#4CAF50; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">âœ… ÄÃ£ hiá»ƒu</button>
```

  </div>
</div>

<div id="chat" style="display:none;">
  <h3 id="roomTitle"></h3>
  <div id="messages"></div>
  <input id="msgBox" placeholder="Nháº­p tin nháº¯n..." autocomplete="off">
  <button id="send">Gá»­i</button>
  <br><br>
  <button id="leave" style="background:#FF9800;">Rá»i phÃ²ng</button>
  <button id="deleteRoom" style="background:#f44336;">XoÃ¡ phÃ²ng</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const firebaseConfig = {
    databaseURL: "https://nhutvan5c-79ce9-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let myName, roomName, myPass, isCreator = false;
  let messageListener = null;
  let memberListener = null;

  // Xá»­ lÃ½ modal hÆ°á»›ng dáº«n
  document.getElementById("showGuide").onclick = () => {
    document.getElementById("guideModal").style.display = "block";
  };

  document.getElementById("closeGuide").onclick = () => {
    document.getElementById("guideModal").style.display = "none";
  };

  document.getElementById("guideModal").onclick = (e) => {
    if (e.target.id === "guideModal") {
      document.getElementById("guideModal").style.display = "none";
    }
  };

  // HÃ m hash máº­t kháº©u
  async function hashPassword(password) {
    const msgBuffer = new TextEncoder().encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // HÃ m escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Táº¡o phÃ²ng
  document.getElementById("create").onclick = async () => {
    const btn = document.getElementById("create");
    try {
      btn.disabled = true;
      btn.textContent = "Äang táº¡o...";

      myName = document.getElementById("name").value.trim();
      roomName = document.getElementById("room").value.trim();
      myPass = document.getElementById("pass").value.trim();

      if (!myName || !roomName || !myPass) {
        alert("âš ï¸ Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin!");
        return;
      }

      if (myPass.length < 6) {
        alert("âš ï¸ Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!");
        return;
      }

      const rRef = db.ref("rooms/" + roomName);
      const snap = await rRef.get();

      if (snap.exists()) {
        alert("âš ï¸ PhÃ²ng Ä‘Ã£ tá»“n táº¡i! Vui lÃ²ng chá»n tÃªn khÃ¡c.");
        return;
      }

      const hashedPass = await hashPassword(myPass);
      await rRef.set({ 
        password: hashedPass,
        creator: myName,
        createdAt: new Date().toISOString()
      });

      // ThÃªm ngÆ°á»i táº¡o vÃ o danh sÃ¡ch thÃ nh viÃªn
      await rRef.child("members").child(myName).set({
        name: myName,
        joinedAt: new Date().toISOString()
      });

      isCreator = true;
      startChat();

    } catch (error) {
      console.error("Lá»—i táº¡o phÃ²ng:", error);
      alert("âŒ Lá»—i: " + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "Táº¡o phÃ²ng";
    }
  };

  // VÃ o phÃ²ng
  document.getElementById("join").onclick = async () => {
    const btn = document.getElementById("join");
    try {
      btn.disabled = true;
      btn.textContent = "Äang káº¿t ná»‘i...";

      myName = document.getElementById("name").value.trim();
      roomName = document.getElementById("room").value.trim();
      myPass = document.getElementById("pass").value.trim();

      if (!myName || !roomName || !myPass) {
        alert("âš ï¸ Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin!");
        return;
      }

      const rRef = db.ref("rooms/" + roomName);
      const snap = await rRef.get();

      if (!snap.exists()) {
        alert("âš ï¸ PhÃ²ng khÃ´ng tá»“n táº¡i!");
        return;
      }

      const hashedPass = await hashPassword(myPass);
      if (snap.val().password !== hashedPass) {
        alert("âŒ Sai máº­t kháº©u!");
        return;
      }

      // ThÃªm thÃ nh viÃªn má»›i vÃ o phÃ²ng
      await rRef.child("members").child(myName).set({
        name: myName,
        joinedAt: new Date().toISOString()
      });

      isCreator = false;
      startChat();

    } catch (error) {
      console.error("Lá»—i vÃ o phÃ²ng:", error);
      alert("âŒ Lá»—i: " + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "VÃ o phÃ²ng";
    }
  };

  // Báº¯t Ä‘áº§u chat
  function startChat() {
    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("roomTitle").textContent = "ğŸ  PhÃ²ng: " + roomName;
    loadMessages();
    listenForNewMembers();
  }

  // Láº¯ng nghe thÃ nh viÃªn má»›i
  function listenForNewMembers() {
    const membersRef = db.ref("rooms/" + roomName + "/members");
    let knownMembers = new Set();
    let isFirstLoad = true;

    // Load danh sÃ¡ch thÃ nh viÃªn hiá»‡n táº¡i
    membersRef.once("value").then((snapshot) => {
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          knownMembers.add(child.val().name);
        });
      }
      isFirstLoad = false;
    });

    // Láº¯ng nghe thÃ nh viÃªn má»›i
    memberListener = membersRef.on("child_added", (snapshot) => {
      if (!isFirstLoad) {
        const memberName = snapshot.val().name;
        
        // Chá»‰ thÃ´ng bÃ¡o náº¿u khÃ´ng pháº£i lÃ  mÃ¬nh vÃ  chÆ°a cÃ³ trong danh sÃ¡ch
        if (memberName !== myName && !knownMembers.has(memberName)) {
          const messagesDiv = document.getElementById("messages");
          const systemMsg = document.createElement("div");
          systemMsg.className = "system-msg";
          systemMsg.textContent = `ğŸ‘‹ ${memberName} Ä‘Ã£ vÃ o phÃ²ng`;
          messagesDiv.appendChild(systemMsg);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        knownMembers.add(memberName);
      }
    });
  }

  // Gá»­i tin nháº¯n
  document.getElementById("send").onclick = sendMessage;
  document.getElementById("msgBox").onkeypress = function(e) {
    if (e.key === 'Enter') sendMessage();
  };

  async function sendMessage() {
    const msgBox = document.getElementById("msgBox");
    const text = msgBox.value.trim();
    if (!text) return;

    try {
      const msgRef = db.ref("rooms/" + roomName + "/messages");
      await msgRef.push({
        sender: myName,
        text: text,
        time: new Date().toISOString()
      });
      msgBox.value = "";
    } catch (error) {
      console.error("Lá»—i gá»­i tin:", error);
      alert("âŒ KhÃ´ng thá»ƒ gá»­i tin nháº¯n: " + error.message);
    }
  }

  // Load tin nháº¯n
  function loadMessages() {
    const msgRef = db.ref("rooms/" + roomName + "/messages");
    
    if (messageListener) {
      msgRef.off("value", messageListener);
    }

    messageListener = msgRef.on("value", (snap) => {
      const messagesDiv = document.getElementById("messages");
      // LÆ°u cÃ¡c tin nháº¯n há»‡ thá»‘ng hiá»‡n cÃ³
      const systemMessages = Array.from(messagesDiv.querySelectorAll('.system-msg'));
      
      messagesDiv.innerHTML = "";
      
      if (!snap.exists() || !snap.val()) {
        messagesDiv.innerHTML = "<p style='color:#999;text-align:center;'>ChÆ°a cÃ³ tin nháº¯n nÃ o...</p>";
        return;
      }

      snap.forEach(child => {
        const m = child.val();
        const div = document.createElement("div");
        
        // Tin cá»§a mÃ¬nh bÃªn PHáº¢I (xanh lÃ¡), ngÆ°á»i khÃ¡c bÃªn TRÃI (xanh dÆ°Æ¡ng)
        const isMyMessage = m.sender === myName;
        div.className = isMyMessage ? "msg right" : "msg left";
        
        const time = new Date(m.time).toLocaleString('vi-VN', {
          hour: '2-digit',
          minute: '2-digit',
          day: '2-digit',
          month: '2-digit'
        });
        
        div.innerHTML = `
          <span class="sender">${escapeHtml(m.sender)}</span>
          <span class="text">${escapeHtml(m.text)}</span>
          <span class="time">${time}</span>
        `;
        messagesDiv.appendChild(div);
      });
      
      // ThÃªm láº¡i cÃ¡c tin nháº¯n há»‡ thá»‘ng
      systemMessages.forEach(msg => messagesDiv.appendChild(msg));
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // XÃ³a phÃ²ng
  document.getElementById("deleteRoom").onclick = async () => {
    if (confirm("âš ï¸ XÃ“A PHÃ’NG CHAT\n\nBáº¡n cháº¯c cháº¯n muá»‘n xÃ³a phÃ²ng nÃ y?\n\nâ€¢ PhÃ²ng \"" + roomName + "\" sáº½ bá»‹ xÃ³a vÄ©nh viá»…n\nâ€¢ Táº¥t cáº£ tin nháº¯n sáº½ bá»‹ máº¥t\nâ€¢ Má»i ngÆ°á»i sáº½ bá»‹ ngáº¯t káº¿t ná»‘i\n\nHÃ nh Ä‘á»™ng nÃ y KHÃ”NG THá»‚ hoÃ n tÃ¡c!")) {
      try {
        const btn = document.getElementById("deleteRoom");
        btn.disabled = true;
        btn.textContent = "Äang xÃ³a...";

        // Táº¯t táº¥t cáº£ listeners
        if (messageListener) {
          db.ref("rooms/" + roomName + "/messages").off("value", messageListener);
          messageListener = null;
        }
        if (memberListener) {
          db.ref("rooms/" + roomName + "/members").off("child_added", memberListener);
          memberListener = null;
        }
        
        await db.ref("rooms/" + roomName).remove();
        alert("âœ… ÄÃ£ xÃ³a phÃ²ng vÃ  táº¥t cáº£ tin nháº¯n thÃ nh cÃ´ng!");
        location.reload();
      } catch (error) {
        console.error("Lá»—i xÃ³a phÃ²ng:", error);
        alert("âŒ KhÃ´ng thá»ƒ xÃ³a phÃ²ng: " + error.message);
        document.getElementById("deleteRoom").disabled = false;
        document.getElementById("deleteRoom").textContent = "XoÃ¡ phÃ²ng";
      }
    }
  };

  // Rá»i phÃ²ng
  document.getElementById("leave").onclick = async () => {
    if (confirm("Báº¡n muá»‘n rá»i khá»i phÃ²ng?")) {
      try {
        // XÃ³a khá»i danh sÃ¡ch members
        await db.ref("rooms/" + roomName + "/members/" + myName).remove();
        
        // Táº¯t listeners
        if (messageListener) {
          db.ref("rooms/" + roomName + "/messages").off("value", messageListener);
          messageListener = null;
        }
        if (memberListener) {
          db.ref("rooms/" + roomName + "/members").off("child_added", memberListener);
          memberListener = null;
        }
        
        location.reload();
      } catch (error) {
        console.error("Lá»—i rá»i phÃ²ng:", error);
        location.reload();
      }
    }
  };
});
</script>

</body>
</html>